/####/Paquete:serializers/####/Paquete:serializers.generics/####/Paquete:serializers.clockings/####/Interfaz:contractor/####//**
requiere:
  - fuente de datos tipo 1 (query)
  - vars: $_objects

si se pasa una fuente con varios elementos, debe incluir manualmente
preInterfaz => "[" y postInterfaz => "]"

EJ:
$_objects = "[";
lanzaInterfaz("serializers.clockings.contractor", "clockings", "");
$_objects = $_objects + "]";
*/

SI ($_objects <> "[" Y $_objects <> "") ENTONCES
  $_objects = $_objects + ", ";
FIN;

$_single = "{" +
  "'id': " + campo("MARC_ID") + ", " +
  "'center': '" + campo("MARC_CENTRO") + "', " +
  "'ss': '" + campo("PERSO_CUIL") + "', " +
  "'action': '" + campo("MARC_SENTIDO") + "', " +
  "'datetime': '" + campo("MARC_FECHA") + "'" +
  "}";

$_objects = $_objects + $_single ;
/####/Paquete:api/####/Interfaz:logger/####/$msg = "Processing API request.";

SI ($httpheader_user_agent <> "") ENTONCES
  $msg = $msg + " User-Agent: " + $httpheader_user_agent + ".";
FIN;

SI ($httpheader_content_type <> "") ENTONCES
  $msg = $msg + " Content-type: " + $httpheader_content_type + ".";
FIN;

informa($msg);/####/Interfaz:_authReject/####/$resp_headers="Content-Type:application/json|Content-Encoding:utf-8";
$httpresult = 401 ;

$body = "{'ok': false, 'error': 'Credentials error or not provided.'}";/####/Interfaz:_authMiddleware/####/$token = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNTQ1MjI0MjU5LCJqdGkiOiIyYmQ1NjI3MmIzYjI0YjNmOGI1MjJlNThjMzdjMTdlMSIsInVzZXJfaWQiOjF9.D92tTuVi_YcNkJtiLGHtcn6tBcxLCBxz9FKD3qzhUg8";

SI ($httpheader_authorization == "Bearer " + $token) ENTONCES
  $_authMidResult = 1;
SINO
  $_authMidResult = 0;
FIN;/####/Tarea:getGreeting/####/lanzaInterfaz("logger", "", "");
$resp_headers="Content-Type:application/json|Content-Encoding:utf-8";
$httpresult = 200;
$body = "{'result': 'Hello'}";/####/Paquete:api.employees/####/Tarea:employee/####/lanzaInterfaz("api.logger", "", "");
$resp_headers="Content-Type:application/json|Content-Encoding:utf-8";
$httpresult = 200;
$body = "{'result': 'getting/posting own people'}";/####/Tarea:contractor/####/lanzaInterfaz("api.logger", "", "");
$resp_headers="Content-Type:application/json|Content-Encoding:utf-8";
$httpresult = 200;
$body = "{'result': 'getting/posting contractor people'}";/####/Paquete:api.clockings/####/Interfaz:getContractors/####/$resp_headers="Content-Type:application/json|Content-Encoding:utf-8";
$httpresult = 200;

$query = "SELECT TOP (1000) PERS_CODIGO as MARC_ID, PERS_TIPO as MARC_CENTRO, PERS_PILA as PERSO_CUIL, PERS_NOMBRE as MARC_SENTIDO, PERS_PERFIL as MARC_FECHA FROM PERSONAS";
creaFuente("clockings", 1, $query, "");

$_objects = "[";
lanzaInterfaz("serializers.clockings.contractor", "clockings", "");
$_objects = $_objects + "]";

$body = "{" +
  "'ok': true, " +
  "'error': null, " +
  "'data': "+ $_objects +
  "}";/####/Tarea:employee/####/lanzaInterfaz("api.logger", "", "");
$resp_headers="Content-Type:application/json|Content-Encoding:utf-8";
$httpresult = 200;
$body = "{'result': 'getting employee clockings'}";/####/Tarea:contractor/####/lanzaInterfaz("api.logger", "", "");

$_authMidResult = 0;
lanzaInterfaz("api._authMiddleware", "", "");

SI ($_authMidResult == 0) ENTONCES
  lanzaInterfaz("api._authReject", "", "");
SINO
  lanzaInterfaz("getContractors", "", "");
FIN;
/####/Paquete:api.auth/####/Tarea:logout/####/lanzaInterfaz("api.logger", "", "");
$resp_headers="Content-Type:application/json|Content-Encoding:utf-8";
$httpresult = 200;
$body = "{'result': 'logout...'}";/####/Tarea:login/####/lanzaInterfaz("api.logger", "", "");
$resp_headers="Content-Type:application/json|Content-Encoding:utf-8";
$httpresult = 200;
$body = "{'result': 'login...'}";/####/Paquete:portal/####/Interfaz:botones_gestor/####/ SI ($sf=="0016") ENTONCES $mb="";SINO $mb="f=N|";FSI;
  ponComponente("0016_gen.html",str("mInformes",0),9,3,$mb+$i4);

 SI ($sf=="0022") ENTONCES $mb="";SINO $mb="f=N|";FSI;
  ponComponente("0022_gen.html",str("mMiEquipo",0),9,3,$mb+$i11);
 /####/Interfaz:pon_botones3/####/$urlMan=getURLManager();

print("<td class='btns-td txt-right'>");
ponComponente($urlMan+"ayuda/portal/100/faqs.html","FAQ",9,3,"f=EB|"+$i13);

SI ($es_gestor) ENTONCES
 ponComponente($urlMan+"ayuda/portal/100/gestor/portal_gestor.html",str("mManual",0),9,3,"f=EB|"+$i12);
SINO
 ponComponente($urlMan+"ayuda/portal/100/usuario/portal_usuario.html",str("mManual",0),9,3,"f=EB|"+$i12);
FSI;

ponComponente(getVariableGlobal("centro_http")+"salir.html",
str("mQuit",0),9,3,$i9);
print("</td>");/####/Interfaz:pon_botones2/####/print("<div class='row col-12'></div>");
print("<div class='row col-12'>");
print("<table class='contenedor marges_taula'><tbody><tr id=''>");
print("<td><table class='contenedor' width='100%'><tbody><tr id=''>");
print("<td class='btns-td'>");

$sf=getVarHTTP("sufijo");
$mb="";

$cambia_password=getVariableGlobal("cambia_password");
SI (a_entero($cambia_password)==0) ENTONCES
//----------------------------------------------------------

SI ($ch<>"") ENTONCES
 SI ($sf=="0001") ENTONCES $mb="";SINO $mb="f=N|";FSI;
 ponComponente("0001_gen.html",str("mResum",0),9,3,$mb+$i1);
 SI ($sf=="0000") ENTONCES $mb="";SINO $mb="f=N|";FSI;
 SI (buscaTexto($perm_persona,"R")>0) ENTONCES
  ponComponente("0000_gen.html",str("mMarcRem",0),9,3,$mb+$i0);
 FSI;

 SI ($sf=="0003") ENTONCES $mb="";SINO $mb="f=N|";FSI;
 ponComponente("0003_gen.html",str("mListMovimientos",0),9,3,$mb+$i2);
 SI ($sf=="0004") ENTONCES $mb="";SINO $mb="f=N|";FSI;
 ponComponente("0004_gen.html",str("mCalendari",0),9,3,$mb+$i3);
FSI;

SI ($sf=="0023") ENTONCES $mb="";SINO $mb="f=N|";FSI;
 ponComponente("0023_gen.html",str("mPlans",0),9,3,$mb+$i23);

SI ($sf=="0016") ENTONCES $mb="";SINO $mb="f=N|";FSI;
ponComponente("0016_gen.html",str("mInformes",0),9,3,$mb+$i4);

SI ($es_gestor) ENTONCES 
 SI ($sf=="0022") ENTONCES $mb="";SINO $mb="f=N|";FSI;
 ponComponente("0022_gen.html",str("mMiEquipo",0),9,3,$mb+$i11);
 //lanzaInterfaz("portal.botones_gestor","","");
FSI;

SI ($es_persona) ENTONCES
 SI ($sf=="0009") ENTONCES $mb="";SINO $mb="f=N|";FSI;
 $equipo_em=0;
 creaFuente("em",1,"EQUIPOS_PERSONAS","");
 lanzaInterfaz("portal.comprueba_emergencia","em",
"EQ_PERS_TIPO="+campoPersona("tipo_persona")
+" AND EQ_PERS_CODIGO="+campoPersona("codigo"));
FSI;
//SI ($es_gestor) ENTONCES
// SI ($sf=="0010") ENTONCES $mb="";SINO $mb="f=N|";FSI;
// ponComponente("0010_gen.html",str("mFiltro",0),9,3,$mb+$i7);
//FSI;
SI ($es_persona) ENTONCES
 SI ($sf=="0011") ENTONCES $mb="";SINO $mb="f=N|";FSI;
 ponComponente("0011_gen.html",str("mMisDatos",0),9,3,$mb+$i8);
FSI;
print("</td>");
//-----------------------------------------------------------
FSI;
lanzaInterfaz("portal.pon_botones3","","");
print("</tr></tbody></table></td></tr></tbody></table></div>");
/####/Interfaz:notificaciones/####/$sp_ant=propiedadFiltro("persona");
tipo_persona=campoObjetoCalculo("peticion","tipo_persona");
codigo=campoObjetoCalculo("peticion","codigo");
SI (propiedadUsuario("persona")) ENTONCES
 $nombre_user=campoPersona("nombre_completo");
 $cod_usr=campoPersona("codigo");
 $tp_usr=campoPersona("tipo_persona");
 SI (campoObjetoCalculo("peticion","estado")==1) ENTONCES
  creaFuente("vals",22,"validadores",$idpet+"|"+$tpet);
  SI (propiedadUsuario("idioma")=="100") ENTONCES
   $frase=", tiene usted pendiente la validación de una petición por parte de ";
  SINO
   $frase=", te vostè pendent la validació d'una petició per part de ";
  FSI;
 SINO 
  SI (campoObjetoCalculo("peticion","estado")<>2) ENTONCES
   creaFuente("vals",22,"prevalidadores",$idpet+"|"+$tpet);
   SI (propiedadUsuario("idioma")=="100") ENTONCES
    $frase=", ha sido modificada una petición de ";
   SINO
    $frase=", ha sigut modificada una petició de ";
   FSI;
  FSI;
 FSI;
 lanzaInterfaz("portal.correo","vals","");
 SI (($tp_usr<>tipo_persona)O($cod_usr<>codigo)) ENTONCES
//el usuario no es el afectado: notificamos al afectado
  SI (buscaPersonaPorCodigo()) ENTONCES
   $mail=campoPersona("mail");
   $cuerpo=campoPersona("nombre_completo")+", una petición suya ha sido modificada por "+$nombre_user;
   enviaCorreo("",$mail,  "", str("mPeticion",0), $cuerpo, "");
  FSI;
 FSI;
FSI;
setPropiedadFiltro("persona",$sp_ant);/####/Interfaz:cuerpo_ventana/####/COMPRUEBA (getVarHTTP("sufijo"))
CASO ("0001") ENTONCES
 SI ($params) ENTONCES 
  lanzaInterfaz("portal.resumen.cambio_persona","","");
 SINO 
  lanzaInterfaz("portal.resumen.resumen","","");FSI;
FIN
CASO ("0002") ENTONCES lanzaInterfaz("portal.resumen.grafico","","");FIN
CASO ("0023") ENTONCES lanzaInterfaz("portal.resumen.peticiones","","");FIN
CASO ("0003") ENTONCES 
 SI ($params) ENTONCES
  lanzaInterfaz("portal.diagrama.cambio_persona","","");
 SINO
  lanzaInterfaz("portal.diagrama.movimientos","","");
 FSI;
FIN
CASO ("0004") ENTONCES
 SI ($params) ENTONCES
  lanzaInterfaz("portal.calendario.modo_cal","","");
 SINO
  lanzaInterfaz("portal.calendario.ventana_calendario","","");
 FSI;
FIN
CASO ("0005") ENTONCES
 //$planif_creada=1;
 SI ($params) ENTONCES
  lanzaInterfaz("portal.jornada.respuesta","","");
 FSI;
 lanzaInterfaz("portal.jornada.ventana_jornada","","");
 //FSI;
FIN
CASO ("0006") ENTONCES
 SI ($params) ENTONCES
  lanzaInterfaz("portal.peticion.operacion","","");
 SINO
  lanzaInterfaz("portal.peticion.peticion","","");
 FSI;
FIN
CASO ("0007") ENTONCES 
SI ($params) ENTONCES
lanzaInterfaz("portal.peticion.mod_mov","","");
SINO lanzaInterfaz("portal.peticion.movimiento","","");
FSI;
FIN
CASO ("0008") ENTONCES
 lanzaInterfaz("portal.calendario.respuesta","","");
 lanzaInterfaz("portal.calendario.ventana_calendario","","");
FIN
CASO ("0009") ENTONCES 
 SI (indefinido($nueva)==0) ENTONCES
  lanzaInterfaz("portal.visitas.form1","","");
 SINO
  lanzaInterfaz("portal.visitas.visitas","","");
 FSI;
FIN
DEFECTO lanzaInterfaz("portal.otrasOpciones","","");FIN
FIN;
/####/Interfaz:por_paises/####/COMPRUEBA ($suf)
CASO ("por") ENTONCES
  $idi=102;setVariableGlobal("centro_http","por_");
  print("<div class='centrado'>");
  print("Portugal");
  print("</div>");
FIN
CASO ("arg") ENTONCES
  $css="style_arg.css";setVariableGlobal("centro_http","arg_");
print("<div class='centrado'>");
  print("Argentina");
print("</div>");
FIN
CASO ("m") ENTONCES
  $idi=100;
  setVariableGlobal("centro_http","m_");
  saltarFilaParametros();
FIN
DEFECTO
 saltarFilaParametros();
 setVariableGlobal("centro_http","");
FIN
FIN;
setVariableEntorno("css",$css);/####/Interfaz:filtro_personas_informes/####/$modf=getVariableGlobal("filtro_mod");
SI ($modf=="1") ENTONCES setPropiedadFiltro("refresco","");FSI;
setVariableGlobal("filtro_mod","0");
creaFuente("filtro_pers",22,"personas_filtro_tm","");
$filtro_p="FUENTE:filtro_pers";
//SI ($operacion_global) ENTONCES 
$filtro_p="0;"+str("mTodos>",0)+"|"+$filtro_p;
//FSI;
SI ((indefinido($pers_filtro)==0)Y($pers_filtro=="0")) ENTONCES
$todos=1;
FSI;
print("<label class='label-user'>");
clase_html="user-select-img";
ponComponente("user-info_brand.svg","",16,0,"");
clase_html="";
print("</label>");
ponParametro("$pers_filtro!","",5,$filtro_p);
SI ($todos) ENTONCES
ponValorParametro("$pers_filtro","0");
SINO
ponValorParametro("$pers_filtro",propiedadFiltro("persona"));
FSI;
saltarFilaParametros();/####/Interfaz:pon_login/####/$e=campoPersona("mail");
SI (length($e)>11) ENTONCES
  setPropiedadUsuario("login",recorta($e,1,length($e)-11),2);
  setPropiedadUsuario("password","1234",2);
FSI;/####/Interfaz:pon_botones/####/tablaHTML(1,"contenedor");
$sf=getVarHTTP("sufijo");
$mb="";

SI ($ch<>"") ENTONCES
 SI ($sf=="0001") ENTONCES $mb="";SINO $mb="f=N|";FSI;
 ponComponente("0001_gen.html",str("mResum",0),9,2,$mb+$i1);
 SI ($sf=="0003") ENTONCES $mb="";SINO $mb="f=N|";FSI;
 ponComponente("0003_gen.html",str("mListMovimientos",0),9,2,$mb+$i2);
 SI ($sf=="0004") ENTONCES $mb="";SINO $mb="f=N|";FSI;
 ponComponente("0004_gen.html",str("mCalendari",0),9,2,$mb+$i3);
FSI;
SI ($es_gestor) ENTONCES
 SI ($sf=="0016") ENTONCES $mb="";SINO $mb="f=N|";FSI;
  ponComponente("0016_gen.html",str("mInformes",0),9,2,$mb+$i4);
 FSI;
SI ($es_persona) ENTONCES
 SI ($sf=="0009") ENTONCES $mb="";SINO $mb="f=N|";FSI;
 ponComponente("0009_gen.html",str("mVisitas",0),9,2,$mb+$i5);
 $equipo_em=0;
 creaFuente("em",1,"EQUIPOS_PERSONAS","");
 lanzaInterfaz("portal.comprueba_emergencia","em",
"EQ_PERS_TIPO="+campoPersona("tipo_persona")
+" AND EQ_PERS_CODIGO="+campoPersona("codigo"));
 SI ($equipo_em) ENTONCES
  SI ($sf=="0015") ENTONCES $mb="";SINO $mb="f=N|";FSI;
  ponComponente("0015_gen.html",str("mModEvac",0),9,2,$mb+$i6);
 FSI;
FSI;
//SI ($es_gestor) ENTONCES
// SI ($sf=="0010") ENTONCES $mb="";SINO $mb="f=N|";FSI;
// ponComponente("0010_gen.html",str("mFiltro",0),9,2,$mb+$i7);
//FSI;
SI ($es_persona) ENTONCES
 SI ($sf=="0011") ENTONCES $mb="";SINO $mb="f=N|";FSI;
 ponComponente("0011_gen.html",str("mFichaEmpleado",0),9,2,$mb+$i8);
FSI;

ponComponente(getVariableGlobal("centro_http")+"salir.html",str("mQuit",0),9,2,$i9);
cierraTablaHTML();/####/Interfaz:vterm/####/SI ($params) ENTONCES
 SI (indefinido($f_incidencia)) ENTONCES $i=0;
 SINO $i=a_entero($f_incidencia);
 FSI;
 $res=insertarMarcaje(71,66,ahora,$i,"Terminal Virtual",0,"");
 $mens = str("mMarcRegistrado",0);
 SI ($res==0) ENTONCES $mens=str("mError",0);
 FSI;
 print("<script src='"+getURLManager()+"notie.js'></script>");
 print("<script>notie.alert({ type: 1, text: '"+$mens+"', time: 2 })");  
 print("</script>");
SINO
 formularioHTML("form1","0000_gen",0);
 print("<div class='row col-12'>");
 print("<table class='contenedor marges_taula'><tbody>");
 print("<tr id=''><td>");
 print("<label class='numero2'>"+str("mMarcRem",0)+"</label>");
 print("<table class='tabla_datos' width='100%'><thead><tr id>");
 print("<th>"+str("mIncid",0)+"</th>");
 print("<th class='numero'>"+str("mHora",0)+"</th>");
 print("<th></th>");
 print("</tr></thead><tbody><tr id=''><td style='width:50%'>");
 $opciones_lista_justificaciones = "";

 $sql_justificaciones = "select cti.incid as cod,coalesce(ij.just_nombre,'"+str("mEntraSale",0)+"') as nom from"+
" (select tabla_saldos,ch from contratos_ch where pers_codigo="+campoPersona("codigo")+
" and pers_tipo="+campoPersona("tipo_persona")+" and "+hoy()+" between inicio and fin) c "+
" join tablas_saldos ts on ts.ch=c.ch and ts.tabla=c.tabla_saldos"+
" join col_tablas_incid_portal cti on cti.tabla=ts.tabla"+
" left join i_justificaciones ij on ij.cod_id=cti.incid and ij.conv_id="+
"(select max(conv_id) from i_convenios where ua_id=ts.ch)";

 creaFuente("query_justificaciones",1,$sql_justificaciones,"");
 lanzaInterfaz("llena_lista_justificaciones","query_justificaciones","");
 ponParametro("$f_incidencia", " style='width:100%;' ", 5,$opciones_lista_justificaciones);
 $hora=recorta(ahora,9,10)+":"+recorta(ahora,11,12)+":"+recorta(ahora,13,14);
 print("</td><td class='numero' id='hora'></td><td>");
 ponComponente("$mr",str("mFichaje",0),9,0,"s=width:50%;|hola");
 $tz = campoPersona("tz");
 if ($tz=="") ENTONCES $tz="Europe/Madrid"; FSI;
 print("</td></tr></tbody></table></td></tr></tbody></table>");
 print("</div>");
 print("<script>var display=setInterval(function(){Time()},1000);
 function Time(){
  var time=new Date().toLocaleTimeString('es-ES')+' ("+$tz+")';
  document.getElementById('hora').innerHTML=time;}</script>
 ");
 //EN IE esto no va var time=new Date().toLocaleTimeString('es-ES',{timeZone: '"+$tz+"'})+' ("+$tz+")';
 cierraFormularioHTML("");
FSI;/####/Interfaz:primero_lista/####/SI (propiedadFiltro("persona")=="0") ENTONCES
 setPropiedadFiltro("persona",campoPersona("tipo_persona")+""+campoPersona("codigo"));
FSI;
/####/Interfaz:cabecera_principal_old/####/tablaHTML(0,"contenedor");
print("<IMG align='right' src='/iconos/2/logo_spec_peq.png'>");
print("<IMG align='left' src='/iconos/2/webtime50.png'>");
saltarFilaParametros();
cierraTablaHTML();
tablaHTML(1,"contenedor,100");
clase_contenedor="cabecera1";
print(str("mUsuario",0)+": "+campoPersona("nombre")+" "+campoPersona("apellidos"));
print("<label class='label-version'>v1.0.0</label>");
clase_contenedor="";
cierraTablaHTML();
print("<hr style='color: #009ddb;' />");/####/Interfaz:llena_lista_justificaciones/####/$codigo_incidencia = campo("cod");
$nombre_incidencia = campo("nom");
SI (length($opciones_lista_justificaciones)>0) ENTONCES
 $opciones_lista_justificaciones = $opciones_lista_justificaciones +"|"+$codigo_incidencia+";"+$nombre_incidencia;
SINO
 $opciones_lista_justificaciones = $codigo_incidencia+";"+$nombre_incidencia;
FSI;/####/Interfaz:filtro_listado/####/$modf=getVariableGlobal("filtro_mod");
setVariableGlobal("filtro_mod","0");
creaFuente("filtro_pers",22,"personas_filtro_tm","");
/####/Interfaz:entrada_login/####/$res=verificaUsuario("SPEC","");
SI ($res==0) ENTONCES
 $portal = propiedadUsuario("mytime");
 entradaAplicacion("<OK>");
 SI ($portal=="1") ENTONCES
  SI (indefinido($chk_mantener)==0) ENTONCES
   SI ($chk_mantener=="1") ENTONCES mantenerSesion(30); FSI;
  FSI;
  setPropiedadUsuario("locale","es",1);
  SI ($password=="****") ENTONCES
   setVariableGlobal("cambia_password","1");
   ponComponente("0011_gen","",19,0,"");
  SINO
   $ch=propiedadUsuario("ch");
   SI ($ch<>"") ENTONCES
    ponComponente("0001_gen","",19,0,"");
   SINO
    ponComponente("0022_gen","",19,0,"");
   FSI;
  FSI;
 SINO
  entradaAplicacion(str("mSinPermiso",100));
  ponComponente(getVariableGlobal("centro_http")+"login","",19,0,"");
 FSI;
SINO
 entradaAplicacion(str("eNoPassword",100));
 ponComponente(getVariableGlobal("centro_http")+"login","",19,0,"");
FSI;
/####/Interfaz:correo/####/SI (((campoPersona("tipo_persona")<>$tp_usr)O
(campoPersona("codigo")<>$cod_usr))Y
((campoPersona("tipo_persona")<>tipo_persona)O
(campoPersona("codigo")<>codigo))) ENTONCES
 $mail=campoPersona("mail");
 SI ($mail<>"") ENTONCES
  $cuerpo=campoPersona("nombre_completo")+$frase+$pers_pet+
CR+LF+"<br><a>"+getURLPortal()+$link+"</a><br>"+CR+LF;
  enviaCorreo("",$mail,"", 
  str("mPeticion",0), $cuerpo, "imagen.jpg");
 FSI;
FSI;/####/Interfaz:comprueba_emergencia/####/$equipo_em=1;/####/Interfaz:comentario/####/$fd=formatoFecha("DDMMAAAA","/");
$fdh=formatoFecha("DDMMAAAAhhmm","/| |:");
$tipus=getValor("comentarios","id_operacion");
print(formatea((a_fecha(getValor("comentarios","tmp"))),$fdh));

COMPRUEBA($tipus)
  CASO ("0") ENTONCES print(str("mJustificada",0)); FIN
  CASO ("1") ENTONCES print(str("mSolicitada",0)); FIN
  CASO ("2") ENTONCES print(str("mAprobada",0)); FIN
  CASO ("3") ENTONCES print(str("mRechazada",0)); FIN
  CASO ("4") ENTONCES print(str("mAnulada",0)); FIN
  CASO ("5") ENTONCES print(str("mAceptada",0)); FIN
FIN;
print(getValor("comentarios","comentario"));
print(getValor("comentarios","usuario"));/####/Interfaz:otrasOpciones/####/COMPRUEBA (getVarHTTP("sufijo"))
CASO ("0010") ENTONCES
 SI ($params) ENTONCES lanzaInterfaz("portal.personal.accion","","");
 SINO lanzaInterfaz("portal.personal.filtro","","");
 FSI;
FIN
CASO ("0011") ENTONCES
 SI ($params) ENTONCES 
  lanzaInterfaz("portal.ficha.cambia_ficha","","");
 SINO 
  lanzaInterfaz("portal.ficha.ficha","","");
 FSI;
FIN
CASO ("0012") ENTONCES
 SI (indefinido($nuevo)==0) ENTONCES  
  lanzaInterfaz("portal.visitas.form_visita","","");
 SINO lanzaInterfaz("portal.visitas.form2","","");
 FSI;
FIN
CASO ("0013") ENTONCES
 lanzaInterfaz("portal.visitas.form_visita","","");
FIN
CASO ("0014") ENTONCES
 SI (indefinido($borrar)==0) ENTONCES 
  lanzaInterfaz("portal.visitas.borrar","","");
 SINO lanzaInterfaz("portal.visitas.crear","","");
 FSI;
FIN
CASO ("0015") ENTONCES
 lanzaInterfaz("portal.evacuacion.monitor","","");
FIN
CASO ("0016") ENTONCES
 SI ($params) ENTONCES lanzaInterfaz("portal.informes.cambio_persona","",""); FSI;
 lanzaInterfaz("portal.informes.informes","","");
FIN
CASO ("0017") ENTONCES
 lanzaInterfaz("portal.personal.gestion_plantilla","","");
FIN
CASO ("0018") ENTONCES
 SI ($params) ENTONCES lanzaInterfaz("portal.anomalias.cambio_persona","","");
 SINO lanzaInterfaz("portal.anomalias.lista","","");
 FSI;
FIN
CASO ("0019") ENTONCES
 SI ($params) ENTONCES 
  lanzaInterfaz("portal.peticion.cambio_persona","","");
 SINO lanzaInterfaz("portal.peticion.lista","","");
 FSI;
FIN
CASO ("0020") ENTONCES
  lanzaInterfaz("portal.ficha.ver_nodo","","");
FIN
CASO ("0021") ENTONCES
  lanzaInterfaz("portal.ficha.edicion_tm","","");
FIN
CASO ("0022") ENTONCES
 lanzaInterfaz("portal.peticion.lista_tm","","");
FIN
FIN;/####/Interfaz:filtro_personas/####/$modf=getVariableGlobal("filtro_mod");
SI ($modf=="1") ENTONCES setPropiedadFiltro("refresco","");FSI;
setVariableGlobal("filtro_mod","0");
creaFuente("filtro_pers",22,"personas_filtro_tm","");
$filtro_p="FUENTE:filtro_pers";

//SI ($operacion_global) ENTONCES 
// $filtro_p="0;"+str("mTodos>",0)+"|"+$filtro_p;
//FSI;
//SI ((indefinido($pers_filtro)==0)Y($pers_filtro=="0")) ENTONCES
//$todos=1;
//FSI;

print("<label class='label-user'>");
clase_html="user-select-img";
ponComponente("user-info_brand.svg","",16,0,"");
clase_html="";
print("</label>");
ponParametro("$pers_filtro!","",5,$filtro_p);

SI (indefinido($pers_filtro)) ENTONCES
 lanzaInterfaz("portal.primero_lista","filtro_pers","");
FSI;
//SI ($todos) ENTONCES
//ponValorParametro("$pers_filtro","0");
//SINO
ponValorParametro("$pers_filtro",propiedadFiltro("persona"));

saltarFilaParametros();/####/Interfaz:lista_comentarios/####/creaFuente("comentarios",22,"comentarios_peticion","");
tablaHTML(4,"tabla_datos,100");
print(str("mInstante",0));print(str("mOperacion",0));
print(str("mComentario",0));print(str("mUsuario",0));
lanzaInterfaz("portal.comentario","comentarios","");
cierraTablaHTML();/####/Lanzador:refresco/####/$s=getVarHTTP("contexto");
COMPRUEBA ($s)
CASO ("evrefresco") ENTONCES
 lanzaInterfaz("portal.evacuacion.refresco","","");
FIN
FSI;/####/Tarea:menu/####/ampliaInterfaz("menu_portal","portal.ventana_principal","");
ampliaInterfaz("login","portal.ventana_login","");
ampliaInterfaz("envio","portal.envio","");
ampliaInterfaz("refresco","portal.refresco","");

/####/Lanzador:ventana_login/####/$params=a_entero(getVarHTTP("vars"));
$suf=getVarHTTP("sufijo");
SI ($params Y ($login<>"")) ENTONCES
 lanzaInterfaz("portal.entrada_login","","");
SINO
 $idi=100;
 $css="new_style.css";
 print("<div class='row form-wrapper'>");
 clase_html="col-12 col-s-12 form-login";
 formularioHTML("slick-login",$suf+"_login",0);
 print("<div class='row titulo'>SPECManager5</div>");
 print("<div class='row subtitulo'>Portal del Empleado</div>");
 lanzaInterfaz("portal.por_paises","","");
 print("<div class='row col-12 col-s-12'>");
 clase_html="input-login";
 ponParametro("$login", str("mLogin",$idi), 2,"autofocus|placeholder");
 print("</div>");
 print("<div class='row col-12 col-s-12'>");
 ponParametro("$password", str("mPassword",$idi), 2,"oculto|placeholder");
 print("</div>");
 SI ($suf<>"por") ENTONCES
  print("<div class='row col-12 col-s-12'><div class='control-group'>");
  print("<label class='control control-checkbox'>"+str("mManSes",$idi));
  print("<input type='checkbox' name='$chk_mantener' value='1'>");
  print("<div class='control_indicator'></div></label>");
  //clase_html="input-checkbox";
  //ponParametro("$chk_mantener","", 4,"");
  //clase_html="label-checkbox";
  //print(str("mManSes",$idi));
  print("</div></div>");
 FSI;
 print("<div class='row btns-row col-12 col-s-12'>");
 ponComponente("$entrar",str("bAceptar",$idi),9,0,"");
 print("</div>");
 cierraFormularioHTML("");
 print("</div>");
 $error_login=getVarHTTP("last_error");
 SI(length($error_login)>5) ENTONCES
  print("<script src='"+getURLManager()+"notie.js'></script>");
  print("<script>notie.alert({ type: 3, text: '"+$error_login+"', time: 2 })");  
  print("</script>");
 FSI;
FSI;/####/Lanzador:nueva_incidencia/####/crearPeticion("I",$f_comentario,$f_incidencia,$f_inicio,$f_fin,0);
ponComponente("calendario","",19,0,"");/####/Lanzador:ventana_principal/####/$es_rrhh=(propiedadFiltro("persona")=="9,9999999");
$sp_ant=propiedadFiltro("persona");
$es_gestor=(propiedadUsuario("gestor")=="1");
$es_persona=(propiedadUsuario("persona")==1);
$perm_persona=propiedadUsuario("permisos");
$operacion_global=0;
$params=a_entero(getVarHTTP("vars"));
$vcen=getVariableGlobal("centro_http");

$i0="i=watch_brand.svg";
$i1="i=home_brand.svg";
$i2="i=card_brand.svg";
$i3="i=calendar_brand.svg";
$i4="i=report_brand.svg";
$i5="i=visitas_prova1.jpg";
$i6="i=arg9.png";
$i7="i=filter_brand.svg";
$i8="i=user-info_brand.svg";
$i9="i=logout_brand.svg";
$i11="i=team_brand.svg";
$i12="i=manual_brand.svg";
$i13="i=faqs_brand.svg";
$i23="i=resum_planif.svg";

//ponemos la cabecera
print("<div class='row background'>");
print("<div class='titulo_portal'>SPECManager5</div>");
print("<div class='subtitulo_portal'>"+str("mPortalEmpleado",$idi)+"</div>");
print("<label class='label-user'>"+str("mUsuario",0)+": "+campoPersona("nombre")+" "+campoPersona("apellidos")+"<div class='label-version'>v1.0.0</div></label>");
print("</div>");

SI (($vcen=="m_")O(getVarHTTP("sufijo")=="0000")) ENTONCES
 //Si se trata del marcaje remoto, la ventana es completamente diferente
 lanzaInterfaz("portal.pon_botones2","","");
 lanzaInterfaz("vterm","","");
SINO
 $es_persona=propiedadUsuario("persona");
 $ch=propiedadUsuario("ch");
 lanzaInterfaz("portal.pon_botones2","","");
 $nico=1;
 setPropiedadFiltro("persona",$sp_ant);
 tablaHTML(0,"");
 lanzaInterfaz("portal.cuerpo_ventana","","");
 cierraTablaHTML();
FSI;/####/Lanzador:login/####/alAceptar("altas_portal|OK");/####/Lanzador:lista_contadores/####/print(str("mContadores",0));
tablaHTML(2,"tabla_datos,100");
print(str("mContador",0));
clase_html="numero";print(str("mVal",0));clase_html="";

$n=valorContador("saldo");
campoObjetoCalculo("contador","saldo");
print(vc_nombre(0));
clase_html="numero";print($n);clase_html="";

$v=valorContador("HT");
campoObjetoCalculo("contador","HT");
print(vc_nombre(0));
clase_html="numero";print($v);clase_html="";

cierraTablaHTML();/####/Lanzador:envio/####/$s=getVarHTTP("contexto");
$cv=recorta($s,1,1);
$s=recorta($s,2,1000);
COMPRUEBA ($cv)
CASO ("P") ENTONCES
 lanzaInterfaz("portal.personal.envio","","");
FIN
CASO ("E") ENTONCES
 lanzaInterfaz("portal.evacuacion.envio","","");
FIN
FSI;/####/Tarea:inicializacion/####/asociaSuceso("portal.menu","inicio_grafico");/####/Tarea:altas_portal/####/creaFuente("plantilla",2,"PERSONAL_PORTAL","");
lanzaInterfaz("portal.pon_login","plantilla","");/####/Paquete:portal.utils/####/Interfaz:resumen_maximos_anuales/####/buscaContrato();
$ch=campoContrato("ch");
$ch_id=campoContrato("ch_id");

$sql="select cod_id,just_nombre,just_nom_c,just_solo_dias,acu_id,acu_anyprev_id from i_justificaciones where conv_id=(select max(conv_id) from i_convenios where ua_id="+$ch_id+") and cod_id in (select cti.incid from (select tabla_saldos,ch from contratos_ch where pers_codigo="+campoPersona("codigo")+
 " and pers_tipo="+campoPersona("tipo_persona")+" and "+hoy()+" between inicio and fin) c join tablas_saldos ts on ts.ch=c.ch and ts.tabla=c.tabla_saldos 
  join col_tablas_incid_portal cti on cti.tabla=ts.tabla) and just_presencia=0 order by 2";

$fila=0;
creaFuente("maximos_anuales",1,$sql,"");
lanzaInterfaz("portal.utils.revisa_maximos_anuales","maximos_anuales","");
/####/Interfaz:comprueba_planificacion_dias/####/
$dias_solicitados=0;
$dias_aprobados=0;
$dias_pendientes=0;
$contador_pendientes=$nombre_contador+"$";

SI ($es_maximo_anual>0) ENTONCES
creaFuente("solicitadas",5,"","");
//cargar las peticiones pendientes de validar del tipo indicado
$sql="SELECT INICIO,FIN FROM PETICIONES_INTERVALO WHERE EMPLEADO_CODIGO="+campoPersona("codigo")+" 
 AND EMPLEADO_APP="+campoPersona("tipo_persona")+" AND INICIO LIKE '"+$ejercicio+"%' AND ESTADO=1 AND NUEVA_INCIDENCIA="+$incid_a_verificar;
creaFuente("pendientes",1,$sql,"");

lanzaInterfaz("portal.utils.llena_lista_solicitadas_dias","pendientes","");
compruebaPlanificaciones("portal.utils.hay_planificacion_dia",a_fecha($ejercicio+"0101"),a_fecha($ejercicio+"1231"),$ch,0,"solicitadas");
FSI;

$style="";
SI ($fila>0) ENTONCES $style="style='display:none;'"; FSI;
SI ($cont_disponibles==0) ENTONCES $dias_pendientes="--"; FSI;
SI ($es_maximo_anual==0) ENTONCES 
 print("<tr id='tmfila"+$incid_a_verificar+"' "+$style+"><td>"+$nom_incidencia+"</td><td>--</td><td>--</td><td>--</td><td></td><td></td></tr>");
SINO
 print("<tr id='tmfila"+$incid_a_verificar+"' "+$style+"><td>"+$nom_incidencia+"</td><td>"+$dias_aprobados+"</td><td>"+$dias_solicitados+"</td><td>"+$dias_pendientes+"</td><td></td><td></td></tr>");
FSI;
/####/Interfaz:resumen_maximos_anuales_horas/####/buscaContrato();
$ch=campoContrato("ch");
$ch_id=campoContrato("ch_id");

$sql="select cod_id,just_nombre,just_nom_c,just_solo_dias,acu_id,acu_anyprev_id from i_justificaciones where conv_id=(select max(conv_id) from i_convenios where ua_id="+$ch_id+") and cod_id in (select cti.incid from (select tabla_saldos,ch from contratos_ch where pers_codigo="+campoPersona("codigo")+
 " and pers_tipo="+campoPersona("tipo_persona")+" and "+hoy()+" between inicio and fin) c join tablas_saldos ts on ts.ch=c.ch and ts.tabla=c.tabla_saldos 
  join col_tablas_incid_portal cti on cti.tabla=ts.tabla) order by 2";

$fila=0;
creaFuente("maximos_anuales",1,$sql,"");
lanzaInterfaz("portal.utils.revisa_maximos_anuales","maximos_anuales","");/####/Interfaz:crea_justificacion_1_dia/####/$quedan_disponibles=1;
//calcular si puede solicitar el número de días
SI ($quedan_disponibles==1) ENTONCES
 $idpet=crearPeticion("P",$f_comentario,$f_incidencia,a_fecha(fecha),a_fecha(fecha),$f);
FSI;

//$planif_creada=1;

/####/Interfaz:crea_justificacion_dias/####/$quedan_disponibles=1;
//calcular si puede solicitar el número de días
SI ($quedan_disponibles==1) ENTONCES
 $idpet=crearPeticion("P",$f_comentario,$f_incidencia,a_fecha($f_inicio),a_fecha($f_fin),0);
FSI;/####/Interfaz:comprueba_planificacion_horas/####/
$horas_solicitadas=0;
$horas_aprobadas=0;
$horas_pendientes=0;
$contador_diario=$nombre_contador;
$contador_pendientes=$nombre_contador+"$";

SI ($es_maximo_anual>0) ENTONCES
creaFuente("solicitadas",5,"","");

//cargar las peticiones pendientes de validar del tipo indicado
$sql="SELECT 'P' AS TIPO,INICIO,FIN,0 AS HINI,0 AS HFIN FROM PETICIONES_INTERVALO WHERE EMPLEADO_CODIGO="+campoPersona("codigo")+
 " AND EMPLEADO_APP="+campoPersona("tipo_persona")+" AND INICIO LIKE '"+$ejercicio+"%' AND ESTADO=1 AND NUEVA_INCIDENCIA="+$incid_a_verificar+
 " UNION "+
 " SELECT 'I' AS TIPO,JORNADA AS INICIO,JORNADA AS FIN,INICIO AS HINI,FIN AS HFIN FROM PETICIONES_JORNADA WHERE EMPLEADO_CODIGO="+campoPersona("codigo")+
 " AND EMPLEADO_APP="+campoPersona("tipo_persona")+" AND JORNADA LIKE '"+$ejercicio+"%' AND ESTADO=1 AND NUEVA_INCIDENCIA="+$incid_a_verificar;

creaFuente("pendientes",1,$sql,"");
lanzaInterfaz("portal.utils.llena_lista_solicitadas_horas","pendientes","");
compruebaPlanificaciones("portal.utils.hay_planificacion_horas",a_fecha($ejercicio+"0101"),a_fecha($ejercicio+"1231"),$ch,0,"solicitadas");
FSI;

$fh=formatoHora(5,2,2,1,0,":");

$style="";
SI ($fila>0) ENTONCES $style="style='display:none;'"; FSI;
SI ($cont_disponibles==0) ENTONCES 
 $horas_pendientes="--"; 
SINO
 $horas_pendientes=formatea($horas_pendientes,$fh);
FSI;

SI ($es_maximo_anual==0) ENTONCES 
 print("<tr id='tmfila"+$incid_a_verificar+"' "+$style+"><td>"+$nom_incidencia+"</td><td>--</td><td>--</td><td>--</td><td></td><td></td></tr>");
SINO

 print("<tr id='tmfila"+$incid_a_verificar+"' "+$style+"><td>"+$nom_incidencia+"</td><td>"+formatea($horas_aprobadas,$fh)+"</td><td>"+formatea($horas_solicitadas,$fh)+"</td><td>"+$horas_pendientes+"</td><td></td><td></td></tr>");
FSI;
/####/Interfaz:crea_justificacion_horas/####/$quedan_disponibles=1;
//calcular si puede solicitar el número de horas
SI ($quedan_disponibles==1) ENTONCES
 $idpet=crearPeticion("H",$f_comentario,$f_incidencia,$f_inicio,$f_fin,$f);
FSI;/####/Interfaz:resumen_maximos_peticion/####/$incid_a_verificar=a_texto(campoObjetoCalculo("peticion","incidencia"));
$fecha=a_texto(campoObjetoCalculo("peticion","fecha"));
$pers=campoObjetoCalculo("peticion","codigo");
$tipo=campoObjetoCalculo("peticion","tipo_persona");
$ejercicio=recorta($fecha,1,4);

$codigo_actual=campoPersona("codigo");
$tipo_actual=campoPersona("tipo_persona");

$codigo_persona_peticion=campoObjetoCalculo("peticion","codigo");
$tipo_persona_peticion=campoObjetoCalculo("peticion","tipo_persona");
codigo=$codigo_persona_peticion;
tipo_persona=$tipo_persona_peticion;
buscaPersonaPorCodigo();
fecha=$fecha;
buscaContrato();
$ch=campoContrato("ch");
$ch_id=campoContrato("ch_id");

$tip_pet=campoObjetoCalculo("peticion","tipo");

creaFuente("solicitadas",5,"","");
SI ($tip_pet==2) ENTONCES
 $inicio=campoObjetoCalculo("peticion","inicio");
 $fin=campoObjetoCalculo("peticion","fin");
 insertaValor("solicitadas","P,"+$inicio+","+$fin+","+$incid_a_verificar);
FSI;
SI ($tip_pet==3) ENTONCES
 $horaini=campoObjetoCalculo("peticion","hinicio");
 $horafin=campoObjetoCalculo("peticion","hfin");
 $pet="I,"+$fecha+","+$incid_a_verificar+",5,"+$horaini+","+$horafin;
 insertaValor("solicitadas",$pet);
FSI;

SI (($tip_pet==2) + ($tip_pet==3)) ENTONCES
 $sql="SELECT JUST_NOMBRE,JUST_NOM_C,JUST_SOLO_DIAS,ACU_ID FROM I_JUSTIFICACIONES WHERE COD_ID="+$incid_a_verificar+" and conv_id=(select max(conv_id) from i_convenios where ua_id=(SELECT CH FROM CONTRATOS_CH WHERE PERS_CODIGO="+$pers+" AND PERS_TIPO="+$tipo+" AND "+$fecha+" BETWEEN INICIO AND FIN))";

 creaFuente("incidencia",1,$sql,"");
 lanzaInterfaz("portal.utils.busca_justificacion","incidencia","");
FSI;

codigo=$codigo_actual;
tipo_persona=$tipo_actual;
buscaPersonaPorCodigo();
/####/Interfaz:revisa_maximos_anuales/####/$incid_a_verificar=campo("cod_id");
$nom_incidencia=campo("just_nombre");
$nombre_contador=campo("just_nom_c");
$es_de_dias=campo("just_solo_dias");
$cont_disponibles=a_entero(campo("acu_id"));
$es_maximo_anual = a_entero(campo("acu_anyprev_id"));

SI ($es_de_dias=="1") ENTONCES
 lanzaInterfaz("portal.utils.comprueba_planificacion_dias","","");
SINO
 lanzaInterfaz("portal.utils.comprueba_planificacion_horas","","");
FSI;

$fila=$fila+1;
/####/Interfaz:llena_lista_solicitadas_horas/####///I,fecha,incidencia,tipo,hora1,hora2. 
//El tipo puede ser 1 (inicio de incidencia), 2 (fin de incidencia), 5 (incidencia entre dos horas) y 6 (incidencia por cantidad).
//el formato a incluir en la lista es
//insertaValor("solicitadas","P,20200110,20200113,1");
//insertaValor("solicitadas","I,20200110,1,5,720,840");
$tipo=campo("TIPO");
$inicio=campo("INICIO");
$fin=campo("FIN");
$hini=campo("HINI");
$hfin=campo("HFIN");
SI ($tipo=="P") ENTONCES
 $planificacion=$tipo+","+$inicio+","+$fin+","+$incid_a_verificar;
SINO
 $planificacion=$tipo+","+$inicio+","+$incid_a_verificar+",5,"+$hini+","+$hfin;
FSI;
insertaValor("solicitadas",$planificacion);/####/Interfaz:busca_justificacion/####/$acum=a_entero(campo("ACU_ID"));
$dias=a_entero(campo("JUST_SOLO_DIAS"));
$nombre=campo("JUST_NOMBRE");
$nombre_contador=campo("JUST_NOM_C");
$contador_diario=$nombre_contador;
$contador_pendientes=$nombre_contador+"$";

SI ($acum>0) ENTONCES
 //7 columnas
 print("</tbody><thead><tr><th></th><th>"+str("mAprobadas",0)+"</th><th>"+str("mSolicitadas",0)+"</th>");
 print("<th>"+str("mDisponibles",0)+"</th><th></th><th></th><th></th></tr></thead><tbody>");

 SI ($dias) ENTONCES

  $dias_solicitados=0;
  $dias_aprobados=0;
  $dias_pendientes=0; compruebaPlanificaciones("portal.utils.hay_planificacion_dia",a_fecha($ejercicio+"0101"),a_fecha($ejercicio+"1231"),$ch,0,"solicitadas");
  print("<tr><td></td><td>"+$dias_aprobados+"</td><td>"+$dias_solicitados+"</td><td>"+
  $dias_pendientes+"</td><td></td><td></td><td></td></tr>");

 SINO

  $horas_solicitadas=0;
  $horas_aprobadas=0;
  $horas_pendientes=0; compruebaPlanificaciones("portal.utils.hay_planificacion_horas",a_fecha($ejercicio+"0101"),a_fecha($ejercicio+"1231"),$ch,0,"solicitadas");
  $fh=formatoHora(5,2,2,1,0,":");
  //informa("horas solicitadas "+formatea($horas_solicitadas,$fh));
  //informa("horas aprobadas "+formatea($horas_aprobadas,$fh));
  //informa("horas pendientes "+formatea($horas_pendientes,$fh));
  print("<tr><td></td><td>"+formatea($horas_aprobadas,$fh)+"</td><td>"+formatea($horas_solicitadas,$fh)+
  "</td><td>"+formatea($horas_pendientes,$fh)+"</td><td></td><td></td><td></td></tr>");
 FSI;
FSI;

/####/Interfaz:hay_planificacion_horas/####///$incid_dia=campoSimulacion("incidencia_dia");
//$dia=campoSimulacion("dia");
$planificado=campoSimulacion("planificado");
$valor_pendientes=a_entero(campoSimulacion("vc:"+$contador_pendientes))/100;
$valor_diario=a_entero(campoSimulacion("vc:"+$contador_diario))/100;

SI($planificado=="1") ENTONCES
 $horas_solicitadas=$horas_solicitadas+a_entero($valor_diario);
SINO
 $horas_aprobadas=$horas_aprobadas+a_entero($valor_diario);
FSI;
$horas_pendientes=a_entero($valor_pendientes);
/####/Interfaz:llena_lista_solicitadas_dias/####///el formato a incluir en la lista es
//insertaValor("solicitadas","P,20200110,20200113,1");
$inicio=campo("INICIO");
$fin=campo("FIN");
$planificacion="P,"+$inicio+","+$fin+","+$incid_a_verificar;
insertaValor("solicitadas",$planificacion);/####/Interfaz:hay_planificacion_dia/####/$incid_dia=campoSimulacion("incidencia_dia");
//$dia=campoSimulacion("dia");
//informa($dia+" id:"+$incid_dia+" pl:"+$planificado);
SI ($incid_dia==$incid_a_verificar) ENTONCES
 $planificado=campoSimulacion("planificado");
 SI($planificado=="1") ENTONCES
  $dias_solicitados=$dias_solicitados+1;
 SINO
  $dias_aprobados=$dias_aprobados+1;
 FSI;
 $dias_pendientes=a_entero(a_entero(campoSimulacion("vc:"+$contador_pendientes))/100);
FSI;
/####/Paquete:portal.informes/####/Interfaz:resumen/####/SI ($informe=="3") ENTONCES
 ponParametro("$informe",str("mListadosDisp",0),5,
 "0;Peticiones|1;Presentes|2;Absentismo|3;Resumen|4;Retrasos|5;Extras");
 clase_contenedor="";
 ponValorParametro("$informe",$informe);
 saltarFilaParametros();
 SI ((indefinido($f_inicio))+(indefinido($f_fin))) ENTONCES
  $f_inicio=a_texto(a_fecha(fecha)-30);$f_fin=a_texto(a_fecha(fecha)-1);
 FSI;
 SI ($f_inicio=="") ENTONCES $f_inicio=a_texto(a_fecha(fecha)-30);FSI;
 SI ($f_fin=="") ENTONCES $f_fin=a_texto(a_fecha(fecha)-1);FSI;
 ponParametro("$f_inicio", str("mDesde",0), 1,"");
 ponParametro("$f_fin", str("mHasta",0), 1,"");
 ponValorParametro("$f_inicio",$f_inicio);
 ponValorParametro("$f_fin",$f_fin);
 saltarFilaParametros();
 ponComponente("$imprimir",str("mLanzaListado",0),9,0,"");
FSI;/####/Interfaz:valor_informe/####/ SI ($informe=="1") ENTONCES
 ponParametro("$informe!",str("mListadosDisp",0),5,
 "0;Peticiones|1;Presentes|2;Absentismo|3;Resumen|4;Retrasos|5;Extras");
 clase_contenedor="";
 ponValorParametro("$informe",$informe);
 saltarFilaParametros();
 SI (indefinido($f_inicio)) ENTONCES
  $f_inicio=fecha;$f_fin=fecha;
 FSI;
 ponParametro("$f_inicio", "Fecha", 1,"");
 ponValorParametro("$f_inicio",$f_inicio);
print("Hora: ");
ponParametro("$f_hora", "", 8,"");
ponValorParametro("$f_hora","0000");
 saltarFilaParametros();
 ponComponente("$imprimir",str("mLanzaListado",0),9,0,"");
 FSI;
 SI ($informe=="2") ENTONCES
	lanzaInterfaz("portal.informes.absentismo","","");
 FSI;
 SI ($informe=="3") ENTONCES
	lanzaInterfaz("portal.informes.resumen","","");
 FSI;
 SI ($informe=="4") ENTONCES
	lanzaInterfaz("portal.informes.retrasos","","");
 FSI;
 SI ($informe=="5") ENTONCES
	lanzaInterfaz("portal.informes.extras","","");
 FSI;
/####/Interfaz:extras/####/ SI ($informe=="5") ENTONCES
 ponParametro("$informe!",str("mListadosDisp",0),5,
 "0;Peticiones|1;Presentes|2;Absentismo|3;Resumen|4;Retrasos|5;Extras");
 clase_contenedor="";
 ponValorParametro("$informe",$informe);
 saltarFilaParametros();
SI ((indefinido($f_inicio))+(indefinido($f_fin))) ENTONCES
  $f_inicio=a_texto(a_fecha(fecha)-30);$f_fin=a_texto(a_fecha(fecha)-1);
 FSI;
 SI ($f_inicio=="") ENTONCES $f_inicio=a_texto(a_fecha(fecha)-30);FSI;
 SI ($f_fin=="") ENTONCES $f_fin=a_texto(a_fecha(fecha)-1);FSI;
 ponParametro("$f_inicio", str("mDesde",0), 1,"");
 ponParametro("$f_fin", str("mHasta",0), 1,"");
 ponValorParametro("$f_inicio",$f_inicio);
 ponValorParametro("$f_fin",$f_fin);
 saltarFilaParametros();
 ponComponente("$imprimir",str("mLanzaListado",0),9,0,"");
 FSI;/####/Interfaz:informes/####/SI ($es_gestor) ENTONCES 
$opciones_combo_listados = "0;"+str("mListadoPlanificaciones",0)+"|1;"+str("mListPAusentes",0)+"|2;"+str("mContadores",0)+"|3;"+str("mDetDiario",0)+"|4;"+str("mRetrasos",0);
SINO
$opciones_combo_listados = "3;"+str("mDetDiario",0);

FSI;

SI (indefinido($informe)) ENTONCES 
 $informe="0"; 
 $f_inicio=a_texto(a_fecha(fecha)-30);$f_fin=a_texto(a_fecha(fecha)-1);
FSI;
$imprimir_listado = indefinido($imprimir);

print("<div class='row col-12'><table class='contenedor marges_taula'>");
print("<tbody><tr id=''><td class='contenedor'>");
clase_html="form-cal";
formularioHTML("form","0016_gen",0);
clase_html="";
SI ($es_gestor) ENTONCES
 lanzaInterfaz("portal.filtro_personas_informes","","");
FSI;
print("<div class='row col-12'><table class='contenedor marges_taula'>");
print("<tbody><tr id=''><td>");
print("<label class='numero2'>"+str("mListadosDisp",0)+"</label>");
print("<table class='tabla_datos' style='width: 100%;'><thead><tr>");
print("<th>"+str("mListado",0)+"</th><th>");
SI ($informe=="1") ENTONCES
 print(str("mFecha",0)+"</th><th>"+str("mHora",0)+"");
SINO
 print(str("mDesde",0)+"</th><th>"+str("mHasta",0));
FSI;
print("</th><th></th></tr></thead><tbody><tr><td>");
ponParametro("$informe!","",5,$opciones_combo_listados);
ponValorParametro("$informe",$informe);
print("</td><td>");

SI ($informe=="0") ENTONCES
 SI ((indefinido($f_inicio))+(indefinido($f_fin))) ENTONCES
  $f_inicio=fecha;$f_fin=a_texto(a_fecha(fecha)+30);
 FSI;
 SI ($f_inicio=="") ENTONCES $f_inicio=fecha;FSI;
 SI ($f_fin=="") ENTONCES $f_fin=a_texto(a_fecha(fecha)+30);FSI;
 ponParametro("$f_inicio", "", 1,"");print("</td><td>");
 ponParametro("$f_fin", "", 1,"");print("</td><td>");
 ponValorParametro("$f_inicio",$f_inicio);
 ponValorParametro("$f_fin",$f_fin);
FSI;
SI ($informe=="1") ENTONCES
 SI (indefinido($f_inicio)) ENTONCES
  $f_inicio=fecha;$f_fin=fecha;
 FSI;
 ponParametro("$f_inicio", "", 1,"");print("</td><td>");
 ponValorParametro("$f_inicio",$f_inicio);
 ponParametro("$f_hora", "", 8,"");print("</td><td>");
 ponValorParametro("$f_hora","0000");
FSI;
SI ( ($informe=="2") + ($informe=="3") + ($informe=="4") ) ENTONCES
 SI ((indefinido($f_inicio))+(indefinido($f_fin))) ENTONCES
  $f_inicio=a_texto(a_fecha(fecha)-30);$f_fin=a_texto(a_fecha(fecha)-1);
 FSI;
 SI ($f_inicio=="") ENTONCES $f_inicio=a_texto(a_fecha(fecha)-30);FSI;
 SI ($f_fin=="") ENTONCES $f_fin=a_texto(a_fecha(fecha)-1);FSI;
 ponParametro("$f_inicio", "", 1,"");print("</td><td>");
 ponParametro("$f_fin", "", 1,"");print("</td><td>");
 ponValorParametro("$f_inicio",$f_inicio);
 ponValorParametro("$f_fin",$f_fin);
FSI;

ponComponente("$imprimir",str("mLanzaListado",0),9,0,"");
print("</td></tr></tbody></table>");
print("</td></tr></tbody></table></div>");
cierraFormularioHTML("");
print("</td></tr></tbody></table></div>");

//finalmente se lanza el listado
SI ($imprimir_listado==0) ENTONCES
 SI ($informe=="0") ENTONCES
  lanzaInterfaz("portal.informes.imprime_incidencias","","");
 FSI;
 SI ($informe=="1") ENTONCES
  lanzaInterfaz("portal.informes.imprime_presentes","","");
 FSI;
 SI ($informe=="2") ENTONCES
  lanzaInterfaz("portal.informes.imprime_absentismo","","");
 FSI;
 SI ($informe=="3") ENTONCES
  lanzaInterfaz("portal.informes.imprime_resumen","","");
 FSI;
 SI ($informe=="4") ENTONCES
  lanzaInterfaz("portal.informes.imprime_retraso","","");
 FSI;
FSI;/####/Interfaz:imprime_extras/####/ abreEnNavegador("http:listado.html");
 $p1=a_fecha($f_inicio);
  $p2=a_fecha($f_fin);
  abreEnNavegador("");
  lanzaInterfaz("listados.extras.listado","","");/####/Interfaz:imprime_absentismo/####/abreEnNavegador("http:listado.html");
$p1=a_fecha($f_inicio);
$p2=a_fecha($f_fin);
abreEnNavegador("");
lanzaInterfaz("listados.contadores.listado","","");
/####/Interfaz:imprime_presentes/####/abreEnNavegador("http:listado.html");
$p1=a_fecha($f_inicio);
$p2=$p1;
$p3=0;
$p5=a_hora($f_hora);
abreEnNavegador("");
lanzaInterfaz("listados.presentes.listado","","");
/####/Interfaz:imprime_resumen/####/  abreEnNavegador("http:listado.html");
 $p1=a_fecha($f_inicio);
  $p2=a_fecha($f_fin);
  abreEnNavegador("");
  lanzaInterfaz("listados.resumendiario.listado","","");/####/Interfaz:imprime_incidencias/####/  abreEnNavegador("http:listado.html");
  $p1=a_fecha($f_inicio);
  $p2=a_fecha($f_fin);
  abreEnNavegador("");
  lanzaInterfaz("listados.incidencias.listado","","");
  determinaDestino("");
  encolaProceso("listados.incidencias.listado");/####/Interfaz:cambio_persona/####/SI (indefinido($pers_filtro)==0) ENTONCES
  setPropiedadFiltro("persona",$pers_filtro);
FSI;/####/Interfaz:imprime_retraso/####/  abreEnNavegador("http:listado.html");
 $p1=a_fecha($f_inicio);
  $p2=a_fecha($f_fin);
  abreEnNavegador("");
  lanzaInterfaz("listados.retrasos.listado","","");/####/Interfaz:absentismo/####/ SI ($informe=="2") ENTONCES
 ponParametro("$informe!",str("mListadosDisp",0),5,
 "0;Peticiones|1;Presentes|2;Absentismo|3;Resumen|4;Retrasos|5;Extras");
 clase_contenedor="";
 ponValorParametro("$informe",$informe);
 saltarFilaParametros();
SI ((indefinido($f_inicio))+(indefinido($f_fin))) ENTONCES
  $f_inicio=a_texto(a_fecha(fecha)-30);$f_fin=a_texto(a_fecha(fecha)-1);
 FSI;
 SI ($f_inicio=="") ENTONCES $f_inicio=a_texto(a_fecha(fecha)-30);FSI;
 SI ($f_fin=="") ENTONCES $f_fin=a_texto(a_fecha(fecha)-1);FSI;
 ponParametro("$f_inicio", str("mDesde",0), 1,"");
 ponParametro("$f_fin", str("mHasta",0), 1,"");
 ponValorParametro("$f_inicio",$f_inicio);
 ponValorParametro("$f_fin",$f_fin);
 saltarFilaParametros();
 ponComponente("$imprimir",str("mLanzaListado",0),9,0,"");
 FSI;/####/Interfaz:retrasos/####/ SI ($informe=="4") ENTONCES
 ponParametro("$informe!",str("mListadosDisp",0),5,
 "0;Peticiones|1;Presentes|2;Absentismo|3;Resumen|4;Retrasos|5;Extras");
 clase_contenedor="";
 ponValorParametro("$informe",$informe);
 saltarFilaParametros();
SI ((indefinido($f_inicio))+(indefinido($f_fin))) ENTONCES
  $f_inicio=a_texto(a_fecha(fecha)-30);$f_fin=a_texto(a_fecha(fecha)-1);
 FSI;
 SI ($f_inicio=="") ENTONCES $f_inicio=a_texto(a_fecha(fecha)-30);FSI;
 SI ($f_fin=="") ENTONCES $f_fin=a_texto(a_fecha(fecha)-1);FSI;
 ponParametro("$f_inicio", str("mDesde",0), 1,"");
 ponParametro("$f_fin", str("mHasta",0), 1,"");
 ponValorParametro("$f_inicio",$f_inicio);
 ponValorParametro("$f_fin",$f_fin);
 saltarFilaParametros();
 ponComponente("$imprimir",str("mLanzaListado",0),9,0,"");
 FSI;/####/Paquete:portal.informes.incidencias2/####/Interfaz:ampl_cabeceras_hoja_dept/####/$nc=$nc+1;
print($i);
print(campoPersona("nombre_completo"));
$i=$i+1;/####/Interfaz:calculo_persona/####/$inc=campoCalculo("incidencia_dia");
SI ($inc<>"0") ENTONCES
$scol=campoObjetoCalculo("incidencia","color");
$col=a_entero($scol);
//con una variable sabemos si ya hemos insertado el mapa para la leyenda o no
SI ($insertado==0) ENTONCES
  $insertado=1;
FSI;
ponValor("leyenda",campoObjetoCalculo("incidencia","nombre"),a_texto($col));
//aspectoCelda($a1,0,1,$col);
clase_contenedor="#h"+getRGB($scol,1);
SINO 
//los festivos los ponemos en gris
 SI (estadoDia()==3) ENTONCES
    //aspectoCelda($a1,0,1,$cg); 
clase_contenedor="#hddd";
  SINO  
clase_contenedor="#hfff";
 FSI;
FSI;
print("");
clase_contenedor="";/####/Interfaz:fila_personas/####/revisaCalculo("portal.informes.incidencias2.calculo_persona",a_fecha(fecha),a_fecha(fecha),"");/####/Interfaz:listado/####/$nc=1;
$cg=defineColor(230,230,230);
creaFuente("leyenda",13,"","");
creaFuente("tmp",7,a_fecha($f_inicio),a_fecha($f_fin));
tablaHTML(2,"tabla_datos,100");
print("");print("Nombre");
$i=1;
lanzaInterfaz("portal.informes.incidencias2.ampl_cabeceras_hoja_dept","seleccion_personas","");
cierraTablaHTML();
tablaHTML($nc,"tabla_datos,100");
print("Día");
$i=1;
lanzaInterfaz("portal.informes.incidencias2.cabeceras_hoja_dept","seleccion_personas","");
$insertado=0;
lanzaInterfaz("portal.informes.incidencias2.fila_dia","tmp","");
cierraTablaHTML();
tablaHTML(2,"tabla_datos,20");
print("Color");print("Indicencia");
lanzaInterfaz("portal.informes.incidencias2.imprime_leyenda","leyenda","");
cierraTablaHTML();/####/Interfaz:cabeceras_hoja_dept/####/print($i);
$i=$i+1;/####/Interfaz:fila_dia/####/print(a_fecha(fecha));
lanzaInterfaz("portal.informes.incidencias2.fila_personas","seleccion_personas","");

/####/Interfaz:imprime_leyenda/####/$n=campo();
$v=prop($n);
clase_contenedor="#h"+getRGB($v,1);
print("");
clase_contenedor="#hfff";
print($n);
clase_contenedor="";
/####/Paquete:portal.informes.incidencias/####/Interfaz:ampl_cabeceras_hoja_dept/####/$ac=$ac+",2";
$nc=$nc+1;/####/Interfaz:calculo_persona/####/$inc=campoCalculo("incidencia_dia");
SI ($inc<>"0") ENTONCES
$scol=campoObjetoCalculo("incidencia","color");
$col=a_entero($scol);
//con una variable sabemos si ya hemos insertado el mapa para la leyenda o no
SI ($insertado==0) ENTONCES
  $insertado=1;
FSI;
ponValor("leyenda",campoObjetoCalculo("incidencia","nombre"),a_texto($col));
//aspectoCelda($a1,0,1,$col);
clase_contenedor="#h"+getRGB($scol,1);
SINO 
//los festivos los ponemos en gris
 SI (estadoDia()==3) ENTONCES
    //aspectoCelda($a1,0,1,$cg); 
clase_contenedor="#hddd";
  SINO  
clase_contenedor="#hfff";
 FSI;
FSI;
print("");
clase_contenedor="";/####/Interfaz:hoja_dept_persona/####/print(campoPersona("nombre_completo"));
revisaCalculo("portal.informes.incidencias.calculo_persona",a_fecha($f_inicio),a_fecha($f_fin),"");/####/Interfaz:listado/####/$nc=1;
$cg=defineColor(230,230,230);
creaFuente("leyenda",13,"","");
creaFuente("tmp",7,a_fecha($f_inicio),a_fecha($f_fin));
lanzaInterfaz("portal.informes.incidencias2.ampl_cabeceras_hoja_dept","tmp","");
tablaHTML($nc,"tabla_datos,100");
print("Nombre");
$insertado=0;
lanzaInterfaz("portal.informes.incidencias2.cabeceras_hoja_dept","tmp","");
lanzaInterfaz("portal.informes.incidencias.hoja_dept_persona","seleccion_personas","");
cierraTablaHTML();
tablaHTML(2,"tabla_datos,20");
print("Color");print("Indicencia");
lanzaInterfaz("portal.informes.incidencias.imprime_leyenda","leyenda","");
cierraTablaHTML();
/####/Interfaz:cabeceras_hoja_dept/####/print(day(fecha));/####/Interfaz:imprime_leyenda/####/$n=campo();
$v=prop($n);
//aspectoCelda($a1,0,1,$v);
clase_contenedor="#h"+getRGB($v,1);
print("");
//aspectoCelda($a1,0,1,0);
clase_contenedor="#hfff";
print($n);
clase_contenedor="";/####/Paquete:portal.informes.presentes/####/Interfaz:impresion_ausentes/####/SI (inicioAgrupacion(1)) ENTONCES
  usarAspecto($acab);
  COMPRUEBA(a_entero(campo("estado")))
   CASO (1) ENTONCES print(str("mLPresentes",0)+CR+LF+CR+LF);
   FIN
   CASO (0) ENTONCES print(str("mAusentes",0)+CR+LF+CR+LF);
   FIN
  FIN;
  $total=0;
  tablaPDF("40,60");
FSI;
usarAspecto($a1);
print(campo("APELLIDOS")+", "+campo("NOMBRE"));
print(campo("DEPARTAMENTO"));
$total=$total+1;
SI (finalAgrupacion(1)) ENTONCES
  usarAspecto($acab);
  cierraTablaPDF(); 
  print("Total: "+$total+CR+LF+CR+LF);

FSI;/####/Interfaz:listado/####/
//TODO esto es necesario? -> buscaControlHorario("UAG");
definePagina("A4",0,30,30,30,30); 
creaDestino("*",3,"nombre varchar2(20),apellidos varchar2(80), 
  estado number(10),   codigo number(10), departamento varchar(200)");
$d=destinoActual();
$fd=formatoFecha("DDMMAAAA","/");
$fdh=formatoFecha("DDMMAAAAhhmm","/| |:");
$fhora=formatoHora(0,0,2,0,0,":");
lanzaInterfaz("portal.informes.presentes.proc_ausentes","seleccion_personas","");
creaFuente("TEMPORAL",1,$d,"ORDER BY apellidos,nombre");
agrupa("TEMPORAL","estado");
$total=0;
creaDestino("presencia",4,"*.pdf");
$a1=aspectoTexto("Helvetica",10,0,0,0);
$acab=aspectoTexto("Helvetica",10,2,0,0);
$a2=aspectoTexto("Helvetica",14,2,0,0);
usarAspecto($a2);
$p4=a_hora($p4);
$p5=a_hora($p5);
print(str("mListPAusentes",0));
usarAspecto($a1);
print(CR+LF);
print(str("mDiaFin:",0)+" "+formatea($p1,$fd));
print(CR+LF);
print(str("mFechaImpresion",0)+" "+formatea(ahora,$fdh));
print(CR+LF);
print(CR+LF);
lanzaInterfaz("portal.informes.presentes.impresion_ausentes","TEMPORAL","");
cierraDestino("presencia");
abreEnNavegador("presencia");/####/Interfaz:proc_ausentes/####/buscaDepartamentoPersona();
$dept=rutaDepartamento(1,3);
ponCampoRegistro("nombre",campoPersona("nombre"));
ponCampoRegistro("apellidos",campoPersona("apellidos"));
ponCampoRegistro("codigo",campoPersona("codigo"));
ponCampoRegistro("departamento",$dept);
$estado=2;
revisaCalculo("portal.informes.presentes.calculo_ausencia",$p1,$p1,"");
SI ($estado<2) ENTONCES
  ponCampoRegistro("estado",a_texto($estado));
  escribeRegistro();
FSI;/####/Interfaz:calculo_ausencia/####///los días en los que ha estado presente hay que examinarlos
SI (campoCalculo("estado_dia")=="1") ENTONCES
  SI ($p3==1) ENTONCES   revisaIntervalos("comprueba_intervalo");
  SINO  $estado=1;   FSI;
SINO 
  SI (campoCalculo("estado_dia")=="0") ENTONCES
//si se detecta que estuvo presente, no se hace nada; 
//si no, marcamos que ha estado ausente
  SI ($estado<>1) ENTONCES $estado=0; FSI;
  FSI;
FSI;/####/Interfaz:comprueba_intervalo/####/SI (int_flag(1)==1) ENTONCES
//la persona ha estado presente en este intervalo. vamos a ver las horas
  SI ((int_hora(0)<=$p4 Y int_hora(1)>=$p4) O (int_hora(0)<=$p5 Y int_hora(1)>=$p5) 
 O (int_hora(0)>=$p4 Y int_hora(1)<=$p5))
  ENTONCES
    $estado=1;
  SINO
    SI ($estado==2) ENTONCES $estado=0;FSI;
  FSI;
FSI;/####/Paquete:portal.evacuacion/####/Interfaz:monitor/####/propiedadUsuario("persona");
SI (indefinido($centro)==0) ENTONCES
setVariableGlobal("centro_evacuacion",$centro);FSI;
SI (indefinido($ver_em)==0) ENTONCES
setVariableGlobal("vista_evacuacion",$ver_em);FSI;
$c=getVariableGlobal("centro_evacuacion");
$v=getVariableGlobal("vista_evacuacion");
SI ($v=="") ENTONCES $v="0";FSI;
SI (indefinido($punto)==0) ENTONCES
setVariableGlobal("punto_evacuacion",$punto);
SINO $punto=getVariableGlobal("punto_evacuacion");
FSI;

creaFuente("ce",1,"CENTROS C, EQUIPOS E,EQUIPOS_PERSONAS P","ORDER BY CEN_NOM");
$scen="";
lanzaInterfaz("busca_centros","ce",
"EQ_PERS_TIPO="+campoPersona("tipo_persona")
+" AND EQ_PERS_CODIGO="+campoPersona("codigo")+
" AND P.EQ_ID=E.EQ_ID AND C.CEN_ID=E.EQ_CEN");
centro=$c;
$ze="";
$primero=1;
creaFuente("fze1",1,"PUNTOS_CONFIG","");
lanzaInterfaz("portal.evacuacion.llena_excluidas","fze1","CEN_ID="+$c);
$zp="";
$primero=1;
creaFuente("fze2",1,"ZONAS","");
lanzaInterfaz("portal.evacuacion.llena_puntos","fze2","ZONA_SEL=2 AND ZONA_CENTRO="+$c);
SI ($ze=="") ENTONCES $ze="-1,"; FSI;
SI ($zp=="") ENTONCES $zp="-1"; FSI;
formularioHTML("form","0015_gen",0);
ponParametro("$centro!",str("mCentro",0),5,$scen);

creaFuente("pr",22,"puntos_reunion","N");
ponParametro("$punto!",str("mPuntoReunion",0),5,"FUENTE:pr");
saltarFilaParametros();

ponParametro("$ver_em!",str("mVer",0),5,
"0;"+str("mPresentes",0)+
"|1;"+str("mSalvados",0)+
"|3;"+str("mListadoSalvados",0)+
"|2;"+str("mListadoQuemados",0));
ponValorParametro("$centro",$c);
ponValorParametro("$ver_em",$v);
ponValorParametro("$punto",$punto);
$cola="";
COMPRUEBA ($v)
CASO ("0") ENTONCES $cola=
"IN (SELECT ZONA_ID FROM ZONAS WHERE ZONA_TIPO IN (1,2,6))";FIN
CASO ("1") ENTONCES $cola="IN ("+$ze+"-1)";
FIN
CASO ("2") ENTONCES $cola="NOT IN ("+$ze+"-1) AND LOC_ZONA NOT IN ("+$zp+")";
FIN
CASO ("3") ENTONCES $cola="IN ("+$zp+")";FIN
FIN;
lanzaInterfaz("portal.evacuacion.crea_tabla","","");
cierraFormularioHTML("");
creaScriptHTML("evrefresco","");/####/Interfaz:envio/####/$tabla=recorta($s,1,1);
$orden=recorta($s,2,2);
$fila=recorta($s,3,1000);
SI ($orden=="b") ENTONCES
 $pos=buscaTexto($fila, "P");
 $z=0;
 SI ($pos>1) ENTONCES
 $z=a_entero(recorta($fila,1,$pos-1));
 FSI;
 $fila=recorta($fila,$pos+1,100);
 tipo_persona=a_entero(recorta($fila,1,1));
 codigo=a_entero(recorta($fila,2,100));
 SI (buscaPersonaPorCodigo()) ENTONCES
  moverPersona($z,a_entero(campoPersona("punto_reunion")));
 FSI;
 print("tabla"+$s);
FSI;/####/Interfaz:llena_puntos/####/SI ($primero) ENTONCES
 $zp=$zp+campo("ZONA_ID");
 $primero=0;
SINO
$ze=","+$zp+campo("ZONA_ID");
FSI;/####/Interfaz:crea_tabla/####/ponEnlace("e");
tablaHTML(7,"tabla_datos,100");
print(str("mNombre",0));
print(str("mTarjeta",0));
print(str("mUltmMarc",0));
print(str("mZona",0));
print(str("mDepartamento",0));
print(str("mEmpresa",0));
print(str("mSalvar",0));
creaFuente("presentes_em",1,"SELECT L.LOC_PERS,L.LOC_APP,L.LOC_ZONA,L.LOC_TMP,L.LOC_TARJ,"+
"P.PR_ID,PD.PR_ID,Z.ZONA_DESC FROM LOCALIZACION L LEFT JOIN ZONAS Z "+
"ON Z.ZONA_ID=L.LOC_ZONA LEFT JOIN PUNTOS_PERSONA P"+
" ON P.PERS_TIPO=L.LOC_APP AND P.PERS_CODIGO=L.LOC_PERS AND P.CEN_ID="+$c+
" LEFT JOIN PUNTOS_DEFECTO PD ON PD.APP_ID=L.LOC_APP"+
" AND PD.CEN_ID="+$c+" WHERE LOC_ZONA IN (SELECT ZONA_ID FROM ZONAS WHERE ZONA_CENTRO="+$c+") AND LOC_ZONA "+$cola,"");
lanzaInterfaz("portal.evacuacion.fila","presentes_em","");
cierraTablaHTML();/####/Interfaz:refresco/####/SI (compruebaNotificaciones(5,"")) ENTONCES print("r");
SINO
$ref=getVariableGlobal("refresco");
print("R"+a_texto(3+(a_entero(getVarHTTP("refresco")))));
FSI;/####/Interfaz:busca_centros/####/SI ($scen<>"") ENTONCES $scen=$scen+"|";FSI;
$scen=campo("CEN_ID")+";"+campo("CEN_NOM");
SI ($c=="") ENTONCES $c=campo("CEN_ID");FSI;/####/Interfaz:fila/####/tipo_persona=a_entero(campo("LOC_APP"));
codigo=a_entero(campo("LOC_PERS"));
SI (buscaPersonaPorCodigo()) ENTONCES
SI (($v<>"2") O (campoPersona("equipo_emergencia")=="0")) ENTONCES
SI (($punto=="") O ($punto=="0") 
O ($punto==campoPersona("punto_reunion"))) ENTONCES
$z=campo("LOC_ZONA");
$ids=$z+"P"+a_texto(tipo_persona)+a_texto(codigo);
setVariableEntorno("id_tr",$ids);
print(campoPersona("nombre_completo"));
print(campo("LOC_TARJ"));
print(a_fecha(campo("LOC_TMP")));
print(campo("ZONA_DESC"));
buscaDepartamentoPersona();
print(rutaDepartamento(1,10));
print(campoPersona("empresa"));
SI ($v=="2") ENTONCES
/* ponEnlace("ctxo"+$ids+"_salvar_gen");*/
 ponEnlace("envio:Eeb"+$ids);
 ponComponente("check.png","",16,0,"");
SINO print("");FSI;
FSI;
FSI;
FSI;/####/Interfaz:llena_excluidas/####/$ze=campo("PC_ZONAS_EXCLUIDAS");

/####/Paquete:portal.visitas/####/Interfaz:carga_visita/####/ponValorParametro("$apellidos",campo("AGV_VIS_COGNOMS"));
ponValorParametro("$nombre",campo("AGV_VIS_NOM"));
ponValorParametro("$empresa",campo("AGV_EMP_NOM"));
ponValorParametro("$fecha",campo("AGV_DATA"));
ponValorParametro("$comentario",campo("AGV_COMENT"));
setVariableGlobal("cod_visitante",campo("AGV_VIS_ID"));
setVariableGlobal("ap_visitante",campo("AGV_VIS_APP"));/####/Interfaz:fila_visita2/####/$e=campo("VIS_ESTADO");
SI ($e=="1") ENTONCES ponComponente("p_ledblau.png","",16,0,"");
SINO ponComponente("p_ledgris.png","",16,0,"");
FSI;
//ponEnlace("ctxoV"+campo("AGV_ID")+"_0013_gen");
print(campo("PERS_NOMBRE"));
print(campo("PERS_PILA"));
print(campo("VIS_AVIS"));
print(a_fecha(campo("VIS_INI")));
print(campo("VIS_OBSERVACIONES"));/####/Interfaz:visitas/####/formularioHTML("form","0009_gen",0);
SI (indefinido($f_inicio)) ENTONCES
 $f_inicio=fecha;$f_fin=fecha;
FSI;
/*SI ($f_inicio=="") ENTONCES $f_inicio="20000101";FSI;
SI ($f_fin=="") ENTONCES $f_fin="99991231";FSI;*/
ponParametro("$f_inicio", str("mDesde",0), 1,"");
ponParametro("$f_fin", str("mHasta",0), 1,"");
ponValorParametro("$f_inicio",$f_inicio);
ponValorParametro("$f_fin",$f_fin);
saltarFilaParametros();
SI (indefinido($chk_previstas)) ENTONCES $chk_previstas=0;
SINO $chk_previstas=a_entero($chk_previstas); FSI;
SI (indefinido($chk_en_curso)) ENTONCES $chk_en_curso=0;
SINO $chk_en_curso=a_entero($chk_en_curso);FSI;
SI (indefinido($chk_finalizadas)) ENTONCES $chk_finalizadas=0;
SINO $chk_finalizadas=a_entero($chk_finalizadas);FSI;
SI (($chk_previstas+$chk_en_curso+$chk_finalizadas)==0) ENTONCES
$chk_previstas=1;$chk_en_curso=0;$chk_finalizadas=0;
FSI;
ponParametro("$chk_previstas", str("mVisPrevistas",0), 4,"");
ponParametro("$chk_en_curso", str("mVisActual",0), 4,"");
ponParametro("$chk_finalizadas", str("mVisAcabadas",0), 4,"");
ponValorParametro("$chk_previstas",a_texto($chk_previstas));
ponValorParametro("$chk_en_curso",a_texto($chk_en_curso));
ponValorParametro("$chk_finalizadas",a_texto($chk_finalizadas));
saltarFilaParametros();
ponComponente("$aplicar",str("mAplicar",0),9,0,"");print(" ");
ponComponente("$nueva",str("mNVisPrevista",0),9,0,"");
tablaHTML(6,"tabla_datos,100");
lanzaInterfaz("portal.visitas.carga_tabla","","");
cierraTablaHTML();
cierraFormularioHTML("");
/####/Interfaz:form_visita/####/formularioHTML("form","0014_gen",0);
ponParametro("$apellidos", str("mApellidos",0), 2,"");saltarFilaParametros();
ponParametro("$nombre", str("mNombre",0), 2,"");saltarFilaParametros();
ponParametro("$mail", str("mEmail",0), 2,"");saltarFilaParametros();
ponParametro("$empresa", str("mEmpresa",0), 2,"");saltarFilaParametros();
$co=getVarHTTP("contexto");
$vid="";
setVariableGlobal("agv_id","");
SI ($co<>"") ENTONCES
  SI (recorta($co,1,1)=="V") ENTONCES
   $vid=recorta($co,2,100);
   setVariableGlobal("agv_id",$vid);
  SINO
   tipo_persona=a_entero(recorta($co,1,1));
   codigo=a_entero(recorta($co,2,100));
   SI (buscaPersonaPorCodigo()) ENTONCES
    ponValorParametro("$apellidos",campoPersona("apellidos"));
    ponValorParametro("$nombre",campoPersona("nombre"));
    ponValorParametro("$empresa",campoPersona("empresa"));
    setVariableGlobal("cod_visitante",a_texto(codigo));
    setVariableGlobal("ap_visitante",a_texto(tipo_persona));
   SINO
    setVariableGlobal("cod_visitante","");
    setVariableGlobal("ap_visitante","");
   FSI;
  FSI;
SINO
   setVariableGlobal("cod_visitante","");
   setVariableGlobal("ap_visitante","");
FSI;
ponParametro("$fecha", str("mFecha",0), 1,"");saltarFilaParametros();
creaFuente("p",22,"porterias","");
ponParametro("$porteria", str("mPorteria",0), 5,"FUENTE:p");saltarFilaParametros();
ponParametro("$hi", str("mHoraLlegadaEntre",0), 8,"");saltarFilaParametros();
ponParametro("$hf", str("malas",0), 8,"");saltarFilaParametros();
ponParametro("$comentario", str("mObservaciones",0), 2,"2,50");
saltarFilaParametros();
ponComponente("$crear",str("mGuardar",0),9,0,"");
SI ($vid<>"") ENTONCES
  print(" ");ponComponente("$borrar",str("mBorrar",0),9,0,"f=R");  
  creaFuente("visita",1,"AGENDA_VISITES","");
  lanzaInterfaz("portal.visitas.carga_visita","visita","AGV_ID="+$vid);
FSI;
cierraFormularioHTML("");/####/Interfaz:fila_visita/####/ponComponente("p_ledverd.png","",16,0,"");
ponEnlace("ctxoV"+campo("AGV_ID")+"_0013_gen");
print(campo("AGV_VIS_COGNOMS"));
print(campo("AGV_VIS_NOM"));
print(campo("AGV_EMP_NOM"));
print(a_fecha(campo("AGV_DATA")));
print(campo("AGV_COMENT"));
/####/Interfaz:carga_tabla/####/print("");
print(str("mApellidos",0));
print(str("mNombre",0));
print(str("mEmpresa",0));
print(str("mFecha",0));
print(str("mObservaciones",0));
propiedadUsuario("persona");
SI ($chk_previstas==1) ENTONCES
creaFuente("agenda",1,"AGENDA_VISITES","ORDER BY AGV_DATA");
lanzaInterfaz("portal.visitas.fila_visita","agenda",
"AGV_VISITAT_ID="+campoPersona("codigo")+
" AND AGV_VISITAT_APP="+
campoPersona("tipo_persona")+" AND AGV_DATA BETWEEN '"+
$f_inicio+"' AND '"+$f_fin+"'");
FSI;
SI ($chk_en_curso O $chk_finalizadas) ENTONCES
  creaFuente("agenda2",1,
"VISITAS V,VISITADOS VO,PERSONAS VISITANTE","ORDER BY V.VIS_INI");
$filtro_es="1,2";
SI ($chk_en_curso==0) ENTONCES $filtro_es="2"; FSI;
SI ($chk_finalizadas==0) ENTONCES $filtro_es="1"; FSI;
  lanzaInterfaz("portal.visitas.fila_visita2","agenda2",
"V.VIS_ESTADO IN ("+$filtro_es+
") and VISITANTE.PERS_CODIGO = V.VIS_VISITANTE and VISITANTE.PERS_TIPO = V.VIS_VISITANTE_APP"+
" AND VO.VIS_VISITADO="+campoPersona("codigo")+
" AND VO.VIS_VISITADO_APP="+campoPersona("tipo_persona")+
" AND V.VIS_INI BETWEEN '"+$f_inicio+"' AND '"+$f_fin+"'");
FSI;/####/Interfaz:borrar/####/eliminaVisitaProgramada(a_entero(getVariableGlobal("agv_id")));
lanzaInterfaz("portal.visitas.visitas","","");/####/Interfaz:form2/####/formularioHTML("form","0012_gen",0);
ponParametro("$visitante", str("mVisitante",0), 2,"");
ponComponente("$nuevo",str("mNuevo",0),9,0,"");
cierraFormularioHTML("");
tablaHTML(1,"tabla_datos,100");
print(str("mVisitante",0));
creaFuente("visitantes",1,"PERSONAS","ORDER BY PERS_NOMBRE,PERS_PILA");
lanzaInterfaz("portal.visitas.lista_visitantes","visitantes",
"UPPER (PERS_NOMBRE+', '+PERS_PILA) LIKE UPPER('%"+$visitante+"%')");
cierraTablaHTML();/####/Interfaz:form1/####/formularioHTML("form","0012_gen",0);
ponParametro("$visitante", str("mVisitante",0), 2,"");
ponComponente("$nuevo",str("mNuevo",0),9,0,"");
cierraFormularioHTML("");/####/Interfaz:crear/####/SI (indefinido($crear)==0) ENTONCES
 SI ($fecha<>"") ENTONCES
  fecha=$fecha;
  $agv_id=getVariableGlobal("agv_id");
  SI ($agv_id<>"") ENTONCES
   actualizaVisitaProgramada(a_entero($agv_id),$empresa,
$comentario,$nombre,$apellidos,a_entero($porteria));
   lanzaInterfaz("portal.visitas.visitas","","");
  SINO
   SI (propiedadUsuario("persona")==1) ENTONCES
    $cod=a_entero(campoPersona("codigo"));
    $ap=a_entero(campoPersona("tipo_persona"));
    $a=getVariableGlobal("ap_visitante");
    $c=getVariableGlobal("cod_visitante");
    SI ($a<>"") ENTONCES
     tipo_persona=a_entero($a);
     codigo=a_entero($c);
     buscaPersonaPorCodigo();
    FSI;
    mail=$mail;
    fecha_inicio="";fecha_fin="";
    fecha=$fecha;
    SI ($hi<>"") ENTONCES $i=a_hora($hi);FSI;
    SI ($hf<>"") ENTONCES $f=a_hora($hf);FSI;
    programaVisita($empresa,$comentario,$nombre,$apellidos,
 a_entero($porteria),$ap,$cod);
    lanzaInterfaz("portal.visitas.visitas","","");
   FSI;
  FSI;
 SINO lanzaInterfaz("portal.visitas.form_visita","","");
 FSI;
SINO
 lanzaInterfaz("portal.visitas.form_visita","","");
FSI;/####/Interfaz:lista_visitantes/####/$codigo=campo("PERS_CODIGO");
$ap=campo("PERS_TIPO");
ponEnlace("ctxo"+$ap+$codigo+"_0013_gen");
print(campo("PERS_NOMBRE")+", "+campo("PERS_PILA"));/####/Paquete:portal.personal/####/Interfaz:recorre_plantillas/####/$splantillas=$splantillas+"|"+campo("1")+";"+campo("2");/####/Interfaz:incluidos/####/$ids=campo("1");
SI ($cond=="6") ENTONCES
$ids=campo("3")+"_"+$ids;
FSI;
setVariableEntorno("id_tr",$ids);
ponEnlace("envio:P'+getT(this)+'m"+$ids);
$s=campo("2");
print($s);
ponEnlace("envio:P'+getT(this)+'b"+$ids);
ponComponente("delete.png","",16,0,"");/####/Interfaz:llena_condiciones/####/$idc=a_texto(propiedadCondicion("id"));
SI ($cond=="") ENTONCES 
  $cond=$idc;
  clase_contenedor="resaltado";
  $encontrada=1;
SINO
  SI ($cond==$idc)  ENTONCES 
clase_contenedor="resaltado";
$encontrada=1;
  FSI;
FSI;
ponEnlace("envio:Pcv"+$idc);
print(propiedadCondicion("nombre"));
ponEnlace("envio:Pcb"+$idc);
ponComponente("delete.png","",16,0,"");
clase_contenedor="";
/####/Interfaz:filtro_actual/####/tablaHTML(2,"tabla_datos,100");
print(str("mCondicion",0));print("");
//saltarFilaParametros();
creaFuente("condiciones",22,"condiciones_plantilla","");
$encontrada=0;
lanzaInterfaz("portal.personal.llena_condiciones","condiciones","");
SI ($encontrada==0) ENTONCES $cond=""; FSI;
cierraTablaHTML();
tablaHTML(2,"contenedor,100");

/*$lnoincluidas="0; ";
creaFuente("noconds",22,"condiciones_plantilla-","");
lanzaInterfaz("portal.personal.no_condiciones","noconds","");*/
$lnoincluidas="201;Filtrar por Jerarquía";

ponParametro("$condicion", "", 5,$lnoincluidas);
ponComponente("$incluir","Aplicar filtro",9,0,"");
cierraTablaHTML();
SI ($cond<>"") ENTONCES
lanzaInterfaz("portal.personal.carga_condicion","","");
FSI;
/####/Interfaz:carga_condicion/####/ setVariableGlobal("condicion_actual",$cond);
buscaCondicion(a_entero($cond),-1);
 SI (a_entero($cond)==4) ENTONCES
   ponParametro("$ab!a", "", 6,"0;"+str("mAltas",0)+
"|1;"+str("mBajas",0)+"|2;"+str("mTodos",0));
   ponValorParametro("$ab",a_texto(propiedadCondicion("altas")));
 SINO
   /*ponParametro("$pos_neg!Pp", "", 6,"!1;"+str("mSoloLosIndicados",0)+
"|0;"+str("mTodosMLosIndicados",0));
   ponValorParametro("$pos_neg",a_texto(propiedadCondicion("positivo")));
*/
 SI ((a_entero($cond)>=200)O
((a_entero($cond)>=100)Y(a_entero($cond)<150)Y(a_entero($cond)<>106))) ENTONCES
// ponParametro("$descendientes!envio('Pd')", str("mTbDescend",0), 4,"");
 ponParametro("$descendientes!envio('Pd')", "Incluir subordinados", 4,"");
 ponValorParametro("$descendientes",
a_texto(propiedadCondicion("descendientes")));
 FSI;
 ponEnlace("i");
 tablaHTML(2,"tabla_datos,100");
 print(str("mIncluidos",0));print("");

creaFuente("incluidos",22,"elementos_condicion_plantilla","");
lanzaInterfaz("portal.personal.incluidos","incluidos","");
 cierraTablaHTML();
 FSI; /####/Interfaz:no_incluidos/####/$ids=campo("1");
setVariableEntorno("id_tr",$ids);
ponEnlace("envio:P'+getT(this)+'m"+$ids);
$s=campo("2");
print($s);
ponEnlace("envio:P'+getT(this)+'b"+$ids);
ponComponente("delete.png","",16,0,"");/####/Interfaz:gestion_plantilla/####/SI (indefinido($guardar)) ENTONCES
formularioHTML("form","0017_gen",0);
ponParametro("$nombre", str("mNombre",0), 2,"");saltarFilaParametros();
ponValorParametro("$nombre",propiedadFiltro("nombre_plantilla"));
ponComponente("$guardar",str("mGuardar",0),9,0,"");print(" ");
cierraFormularioHTML("");
SINO
setPropiedadFiltro("nombre_plantilla",$nombre);
lanzaInterfaz("portal.personal.filtro","","");
FSI;/####/Interfaz:filtro/####/$cond=getVariableGlobal("condicion_actual");
formularioHTML("form_todos","0010_gen",0);
tablaHTML(0,"");
$chf=1;
ponParametro("$sfact!envio('Pf')", str("mSoloFAct",0), 4,"");
SI ($es_persona) ENTONCES
ponParametro("$yo_tb!envio('Py')", str("mInclS",0), 4,"");
ponValorParametro("$yo_tb",a_texto(propiedadFiltro("autoincluirse")));
FSI;
ponValorParametro("$sfact",a_texto(1-propiedadFiltro("sin_fechas")));
//saltarFilaParametros();
SI (propiedadUsuario("id_usuario")>0) ENTONCES
 creaFuente("plantillas",22,"plantillas","");
 $splantillas="0;"+str("mPredefinido>",0);
 lanzaInterfaz("portal.personal.recorre_plantillas","plantillas","");
 ponParametro("$plantillas!", str("mPlantilla",0), 5,$splantillas);
 ponValorParametro("$plantillas",a_texto(propiedadFiltro("plantilla")));
 ponComponente("$gestionar",str("mGestionar",0),9,0,"");
FSI;
cierraTablaHTML();
tablaHTML(2,"contenedor,100");
tablaHTML(1,"contenedor,100");
lanzaInterfaz("portal.personal.filtro_actual","","");
cierraTablaHTML();
SI (($cond<>"")Y($cond<>"4")) ENTONCES
 lanzaInterfaz("portal.personal.busqueda","","");
FSI;
cierraTablaHTML();
cierraFormularioHTML("");
creaScriptHTML("","");
/####/Interfaz:busqueda/####/tablaHTML(1,"contenedor,100");
tablaHTML(3,"contenedor,100");
ponComponente("$incluirT","Incluir todos",9,0,"");
print(str("mSearch",0));
ponComponente("$a_buscar", "", 2,1,"");
cierraTablaHTML();
ponEnlace("n");
tablaHTML(2,"tabla_datos,100"); 
print(str("mNoIncluidos",0));print("");
$ff=getVariableGlobal("filtro_plantilla");
SI (($ff=="")Y(a_entero($cond)>200)Y(a_entero($cond)<220)) ENTONCES
  SI (buscaJerarquiaPersona(1)) ENTONCES $ff=rutaJerarquia(1,10,"");FSI;
FSI;
creaFuente("no_incluidos",22,
"elementos_condicion_plantilla-",$ff);

lanzaInterfaz("portal.personal.no_incluidos","no_incluidos","");
cierraTablaHTML();
cierraTablaHTML();
/####/Interfaz:incluir/####/setPropiedadCondicion("elem+",campo("1"));/####/Interfaz:no_condiciones/####/$lnoincluidas=$lnoincluidas+"|"+
propiedadCondicion("id")+";"+propiedadCondicion("nombre");/####/Interfaz:accion/####/$chf=1;
setPropiedadFiltro("control_horario",1);
SI (indefinido($gestionar)==0) ENTONCES
lanzaInterfaz("portal.personal.gestion_plantilla","","");
SINO
SI (indefinido($sub_enter)) ENTONCES
 SI (indefinido($incluir)==0) ENTONCES
  setPropiedadFiltro("condicion","+"+$condicion);
  setVariableGlobal("condicion_actual",$condicion);
  setVariableGlobal("filtro_mod","1");
 FSI;
 SI (indefinido($incluirT)==0) ENTONCES
   $cond=getVariableGlobal("condicion_actual");
   buscaCondicion(a_entero($cond),-1);
   creaFuente("no_incluidos",22,
"elementos_condicion_plantilla-",getVariableGlobal("filtro_plantilla"));
   lanzaInterfaz("portal.personal.incluir","no_incluidos","");
   setVariableGlobal("filtro_mod","1");
 FSI;
 SI (indefinido($plantillas)==0) ENTONCES
   setPropiedadFiltro("plantilla",a_entero($plantillas));
 FSI;
FSI;
SI (indefinido($a_buscar)==0) ENTONCES
 setVariableGlobal("filtro_plantilla",$a_buscar);
SINO
 setVariableGlobal("filtro_plantilla","");
FSI;
lanzaInterfaz("portal.personal.filtro","","");
FSI;/####/Interfaz:envio/####/$tabla=recorta($s,1,1);
$orden=recorta($s,2,2);
$fila=recorta($s,3,1000);
SI ($tabla=="c") ENTONCES
 SI ($orden=="b") ENTONCES  
   setPropiedadFiltro("condicion","-"+$fila);
   setVariableGlobal("filtro_mod","1");
 SINO setVariableGlobal("condicion_actual",$fila);
 FSI;
 print("r");
SINO 
  $cond=getVariableGlobal("condicion_actual");
  SI ($cond<>"") ENTONCES
  buscaCondicion(a_entero($cond),-1);
  FSI;
  COMPRUEBA ($tabla)
  CASO ("y") ENTONCES
setPropiedadFiltro("autoincluirse",2);
setVariableGlobal("filtro_mod","1");
  FIN
  CASO ("f") ENTONCES
setPropiedadFiltro("sin_fechas",2);
setVariableGlobal("filtro_mod","1");
  FIN
  CASO ("a") ENTONCES
setPropiedadCondicion("altas",a_entero($orden));
setVariableGlobal("filtro_mod","1");
print("c1"+$fila);
  FIN
  CASO ("d") ENTONCES
setPropiedadCondicion("descendientes",2);
setVariableGlobal("filtro_mod","1");
  FIN
  CASO ("n") ENTONCES
   SI ($orden=="m") ENTONCES 
setPropiedadCondicion("elem+",$fila);
setVariableGlobal("filtro_mod","1");
   SINO
    SI ($orden=="b") ENTONCES
setPropiedadCondicion("elem-",$fila);
setVariableGlobal("filtro_mod","1");
    FSI;
   FSI;
   print("tabla"+$s);
  FIN
  CASO ("p") ENTONCES
   setPropiedadCondicion("positivo",$orden=="1");
   setVariableGlobal("filtro_mod","1");
   print("c1"+$fila);
  FIN
  DEFECTO
   SI ($orden=="b") ENTONCES
    setPropiedadCondicion("elem-",$fila);
setVariableGlobal("filtro_mod","1");
    print("tabla"+$s);
   FSI;
  FIN
  FIN;
FSI;
/####/Paquete:portal.peticion/####/Interfaz:pon_checks/####/SI (indefinido($chk)) ENTONCES 
 $chk="0";
FSI;
SI ($es_rrhh==1) ENTONCES
 ponParametro("$chk!", " style='width:90%;'", 5,"0;"+str("mPeticionesCol",0)+"|1;"+str("mPeticionesAAG",0)+"|2;"+str("mPeticionesRAG",0)+"|4;"+str("mPeticionesALL",0));
 ponValorParametro("$chk",getVariableGlobal("f_pet"));
 COMPRUEBA ($chk)
  CASO ("0") ENTONCES
   $flags=$flags+"S";
   setVariableGlobal("f_pet","0");
  FIN
  CASO ("1") ENTONCES
   $flags=$flags+"MOF";
   setVariableGlobal("f_pet","1");
  FIN
  CASO ("2") ENTONCES
   $flags=$flags+"RAF";
   setVariableGlobal("f_pet","2");
  FIN
  CASO ("3") ENTONCES
   $flags=$flags+"SFB";
   setVariableGlobal("f_pet","3");
  FIN
  CASO ("4") ENTONCES
   $flags=$flags+"SORAMF";
   setVariableGlobal("f_pet","4");
  FIN
 FSI;
SINO
 ponParametro("$chk!", " style='width:90%;'", 5,"0;"+str("mPeticionesCol",0)+"|1;"+str("mPeticionesAAG",0)+"|2;"+str("mPeticionesRAG",0)+"|4;"+str("mPeticionesALL",0));
 COMPRUEBA ($chk)
  CASO ("0") ENTONCES
   $flags=$flags+"S";
   setVariableGlobal("f_pet","0");
  FIN
  CASO ("1") ENTONCES
   $flags=$flags+"MO";
   setVariableGlobal("f_pet","1");
  FIN
  CASO ("2") ENTONCES
   $flags=$flags+"RA";
   setVariableGlobal("f_pet","2");
  FIN
  CASO ("3") ENTONCES
   $flags=$flags+"S";
   setVariableGlobal("f_pet","3");
  FIN
  CASO ("4") ENTONCES
   $flags=$flags+"SMORA";
   setVariableGlobal("f_pet","4");
  FIN
 FSI;
FSI;
ponValorParametro("$chk",getVariableGlobal("f_pet"));
/####/Interfaz:nombres_PM/####/SI ($valid) ENTONCES  
$pm=(campoObjetoCalculo("peticion","empleado"));
SI ($pm=="MARIN VALIENTE, SILVIA") ENTONCES
print("RRHH");
SINO
print(campoObjetoCalculo("peticion","empleado"));
FSI;
SINO 
$pm=(campoObjetoCalculo("peticion","pendiente"));
SI ($pm=="MARIN VALIENTE, SILVIA") ENTONCES
print("RRHH");
SINO
print(campoObjetoCalculo("peticion","pendiente"));
FSI; 
FSI;/####/Interfaz:edicion_movimiento/####/SI (mov_dato("id")==getVarHTTP("contexto")) ENTONCES
$tpet="1";
fecha=$j_marcaje;
SI ($borrar_mov==str("mBorrar",0)) ENTONCES
 $idpet=crearPeticion("M",$comentario,$f_incidencia,$h_marc,"B",0);
SINO
 $idpet=crearPeticion("M",$comentario,$f_incidencia,$h_marc,"",0);
FSI;

ponComponente("ctxo"+fecha+campoPersona("tipo_persona")+""+campoPersona("codigo")+"_0005_gen","",19,0,"");
FSI;
/####/Interfaz:peticion_jornada/####/$tp=campoObjetoCalculo("peticion","tipo_peticion_jornada");
COMPRUEBA ($tp)
CASO (1) ENTONCES
 clase_html="info";
 print(str("mJornada",0));
 clase_html="";
 print(campoObjetoCalculo("peticion","str_jornada"));
FIN/*
CASO (2) ENTONCES
 clase_html="info";
 print(str("mTiempo",0));
 clase_html="";
 print(a_hora(campoObjetoCalculo("peticion","inicio")));
 print(" - ");
 print(a_hora(campoObjetoCalculo("peticion","inicio")));
FIN*/
CASO (3) ENTONCES
 clase_html="info";
 print(str("mTiempo",0));
 clase_html="";
 print(a_hora(campoObjetoCalculo("peticion","hora")));
FIN
CASO (4) ENTONCES
 clase_html="info";
 print(str("mTiempo",0));
 clase_html="";
 print(str("mMediaJor",0));
FIN
FIN;/####/Interfaz:cambio_persona/####/SI (indefinido($pers_filtro)==0) ENTONCES
  SI ($pers_filtro<>"0") ENTONCES
  setPropiedadFiltro("persona",$pers_filtro);
  FSI;
FSI;
lanzaInterfaz("portal.peticion.lista","","");/####/Interfaz:peticion/####/$co=getVarHTTP("contexto");
$l=length($co);
$idpet=a_entero(recorta($co,1,$l-2));
$tpet=a_entero(recorta($co,$l,$l));
clase_html="";
cierraTablaHTML();
cierraTablaHTML();
print("</div><div class='row col-12'>");

print("<table class='contenedor marges_taula'><tbody><tr id><td>");
formularioHTML("form_pet","ctxo"+$co+"_0006_gen",0);
print("<label class='numero2'>"+str("mPeticion",0)+"</label>");
SI (buscaPeticion($idpet,$tpet)) ENTONCES
 lanzaInterfaz("portal.peticion.especifico_peticion","","");
 lanzaInterfaz("portal.peticion.peticion2","","");
 lanzaInterfaz("portal.peticion.peticion_comentarios","","");
SINO 
 error(getLastError());
FSI;
/####/Interfaz:print_fecha/####/$las_fechas=(campoObjetoCalculo("peticion","fechas"));
SI (length($las_fechas)>10) ENTONCES
// $f1=recorta($las_fechas,9,10)+"/"+
//recorta($las_fechas,6,7)+"/"+recorta($las_fechas,1,4);
// $f2=recorta($las_fechas,22,23)+"/"+
//recorta($las_fechas,19,20)+"/"+recorta($las_fechas,14,17);
//print($f1+" - "+$f2);
 print($las_fechas);
SINO 
 $tipus=campoObjetoCalculo("peticion","str_tipo");
 SI ($tipus=="Días") ENTONCES
  $f1=recorta($las_fechas,9,10)+"/"+
  recorta($las_fechas,6,7)+"/"+recorta($las_fechas,1,4);
  print($f1);
 SINO print($las_fechas);
 FSI;
FSI;
/####/Interfaz:vista_global/####/informa("vista_global");
lanzaInterfaz("portal.peticion.carga_peticiones","peticiones","");/####/Interfaz:lista/####/$operacion_global=1;
print("<div class='row col-12'><table class='contenedor marges_taula'><tbody><tr id><td>");
clase_html="form-top";
formularioHTML("form","0019_gen",0);
clase_html="";
SI ($es_gestor) ENTONCES
lanzaInterfaz("portal.filtro_personas","","");
FSI;
$ayer=a_fecha(fecha)-1;
$prox=a_fecha(fecha)+30;
SI (indefinido($f_inicio)) ENTONCES $f_inicio="20200101";$f_fin=$prox;
FSI;
SI ($f_inicio=="") ENTONCES $f_inicio="20200101";FSI;
SI ($f_fin=="") ENTONCES $f_fin="99991231";FSI;
print("<table width='100%'><tr><td><label class='label-select'>"+str("mDesde",0)+"</label>");
clase_html="date-edit";
ponParametro("$f_inicio", "", 1,"");
print("<label class='label-select'>"+str("mHasta",0)+"</label>");
ponParametro("$f_fin", "", 1,"");
ponValorParametro("$f_inicio",$f_inicio);
clase_html="";
print("</td><td>");
SI ($f_fin<>"99991231") ENTONCES ponValorParametro("$f_fin",$f_fin);FSI;
SI (indefinido($chk_pendiente)) ENTONCES $chk_pendiente=0;
SINO $chk_pendiente=a_entero($chk_pendiente); FSI;
SI (indefinido($chk_anulada)) ENTONCES $chk_anulada=0;
SINO $chk_anulada=a_entero($chk_anulada); FSI;
SI (indefinido($chk_aprobada)) ENTONCES $chk_aprobada=0;
SINO $chk_aprobada=a_entero($chk_aprobada); FSI;
SI (indefinido($chk_rechazada)) ENTONCES $chk_rechazada=0;
SINO $chk_rechazada=a_entero($chk_rechazada); FSI;
$flags="";
lanzaInterfaz("portal.peticion.pon_checks","","");
print("</td><td>");
ponComponente("$aplicar",str("mAplicar",0),9,0," style='width:90%;'");
print("</td></tr></table>");
//SI ($pers_filtro=="0") ENTONCES 
 tablaHTML(6,"tabla_datos,100");
//SINO 
// tablaHTML(4,"tabla_datos,100");
//FSI;
//print(str("mEstado",0));
print("");
print(str("mTipo",0));
print(str("mIncid",0));
clase_contenedor="numero";
print(str("mFecha",0));
clase_contenedor="";
print(str("mCreadoPor",0));
print(str("mPendiented",0));
creaFuente("peticiones",21,$f_inicio+","+$f_fin,$flags);
//SI ($pers_filtro=="0") ENTONCES print(str("mEmpleado",0));FSI;
SI ($pers_filtro=="0") ENTONCES
 lanzaInterfaz("portal.peticion.vista_global","filtro_pers","");
SINO
 lanzaInterfaz("portal.peticion.carga_peticiones","peticiones","");
FSI;
cierraTablaHTML();
cierraFormularioHTML("");
print("</td></tr></tbody></table></div>");/####/Interfaz:precarga_peticiones/####/$hr=campoObjetoCalculo("peticion","fecha")+
ponBlancos(
a_texto(campoObjetoCalculo("peticion","id"))+
a_texto(campoObjetoCalculo("peticion","tipo")),
20,1);
creaFuente($hr,13,"","");
ponValor($hr,"idpet",a_texto(campoObjetoCalculo("peticion","id")));
ponValor($hr,"tipo",a_texto(campoObjetoCalculo("peticion","tipo")));
ponValor($hr,"icono",campoObjetoCalculo("peticion","icono"));

ponValor($hr,"str_tipo",campoObjetoCalculo("peticion","str_tipo"));

SI ($tipo_pet==1) ENTONCES
 $ind = campoObjetoCalculo("peticion","str_ind");
 $horam = campoObjetoCalculo("peticion","hora");
 SI ($ind=="") ENTONCES $ind=$horam;
 SINO $ind = $ind +" "+$horam;
 FSI;
 ponValor($hr,"str_ind",$ind);
SINO
 ponValor($hr,"str_ind",campoObjetoCalculo("peticion","str_ind"));
FIN;

ponValor($hr,"hora",campoObjetoCalculo("peticion","hora"));
ponValor($hr,"fecha",campoObjetoCalculo("peticion","fecha"));
ponValor($hr,"empleado",campoObjetoCalculo("peticion","empleado"));
ponValor($hr,"estado",
a_texto(campoObjetoCalculo("peticion","estado")));
ponValor($hr,"pendiente",
a_texto(campoObjetoCalculo("peticion","pendiente")));
ponValor("mapa_pet",$hr,getFuente($hr));


/####/Interfaz:especifico_peticion/####/$fd=formatoFecha("DDMMAAAA","/");
print("<table class='tabla_datos' width='100%'><thead><tr id>");
print("<th>"+str("mEstado",0)+"</th>");
print("<th>"+str("mEmpleado",0)+"</th>");
print("<th>"+str("mPendiented",0)+"</th>");
print("<th>"+str("mTipo",0)+"</th>");
print("<th>"+str("mFecha",0)+"</th>");
SI ($tpet<>2) ENTONCES
 print("<th>"+str("mHora",0)+"</th>");
SINO
 print("<th></th>");
FSI;
print("<th></th>"); //fila para el botón anular
print("</tr></thead><tbody><tr id><td>");
$texto=campoObjetoCalculo("peticion","str_estado");
ponComponente(campoObjetoCalculo("peticion","icono"),$texto,16,0,"style='padding-bottom: 3px; margin-right: 5px;'");
print("</td><td>");
print(campoObjetoCalculo("peticion","empleado"));
print("</td><td>");
$estado_pet=campoObjetoCalculo("peticion","estado");
SI ($estado_pet==1) ENTONCES
 print(campoObjetoCalculo("peticion","pendiente"));
FSI;
print("</td><td>");

$masdatos = "";
SI ($tpet==1) ENTONCES
 $masdatos="("+campoObjetoCalculo("peticion","str_operacion")+")";
 print(str(campoObjetoCalculo("peticion","str_tipo"),0)+" "+$masdatos);
 print("</td><td>");
FSI;
SI ( ($tpet==2) + ($tpet==3) ) ENTONCES
 $i=campoObjetoCalculo("peticion","str_ind");
 SI ($i<>"") ENTONCES
  print($i);
 FSI;
 print("</td><td>");
FSI;
SI ($tpet==4) ENTONCES
 ponEnlace("0004_gen");
SINO
 ponEnlace("ctxo"+campoObjetoCalculo("peticion","fecha")+
campoObjetoCalculo("peticion","tipo_persona")+campoObjetoCalculo("peticion","codigo")+"_0005_gen");
FSI;
lanzaInterfaz("portal.peticion.print_fecha","","");
print("</td><td>");

COMPRUEBA ($tpet)
CASO (1) ENTONCES
 print(a_hora(campoObjetoCalculo("peticion","hora")));
 $desf=campoObjetoCalculo("peticion","desfase_diario");
 SI ($desf=="1")ENTONCES print(str("mDiaSiguiente",0));FSI;
 SI ($desf=="2")ENTONCES print(str("mDiaAnt",0));FSI;
FIN
CASO (3) ENTONCES
 lanzaInterfaz("portal.peticion.peticion_jornada","","");
FIN
FIN;
print("</td><td>");
$perm=campoPersona("permisos_peticion,"+$idpet+","+$tpet);
//las peticiones se pueden anular si 1.pendientes 2.aprobadas si eres gestor
SI ($estado_pet==1) ENTONCES
 SI (buscaTexto($perm,"N")>0) ENTONCES
  ponComponente("$anular",str("mAnular",0),9,0,"f=R");
 FSI;
FSI;
/*SI ($estado_pet==2) ENTONCES
 SI ($es_gestor) ENTONCES
  ponComponente("$anular",str("mAnular",0),9,0,"f=R");
 FSI;
FSI;*/
print("</td></tr>");
/####/Interfaz:mod_mov/####//*$tpet="1";
fecha=$j_marcaje;
$idpet=crearPeticion("M",$comentario,$h_marc,$f_incidencia,"",0);
$co=getVarHTTP("contexto");
ponComponente("ctxo"+fecha+campoPersona("tipo_persona")+
""+campoPersona("codigo")+"_0005_gen","",19,0,"");
SI (getVarHTTP("contexto")<>"") ENTONCES
revisaMovimientos("edicion_movimiento");
SINO  lanzaInterfaz("portal.diagrama.movimientos","","");
FSI;*/
$tpet="1";
fecha=$j_marcaje;
$co=getVarHTTP("contexto");
ponComponente("ctxo"+fecha+campoPersona("tipo_persona")+
""+campoPersona("codigo")+"_0005_gen","",19,0,"");
SI ($co<>"") ENTONCES
   revisaMovimientos("portal.peticion.edicion_movimiento");
SINO  
  lanzaInterfaz("portal.diagrama.movimientos","","");
FSI;
/####/Interfaz:movimientos/####/$co=getVarHTTP("contexto");
SI (mov_dato("id")==$co) ENTONCES
 print("<div class='row col-12'><table class='contenedor marges_taula'>");
 print("<tbody><tr id=''><td>");
 clase_html="";
 formularioHTML("form_pet","ctxo"+$co+"_0007_gen",0);
 print("<label class='numero2'>"+str("mModifMov",0)+"</label>");
 print("<table class='tabla_datos' width='100%'><thead><tr id>");
 print("<th>"+str("mOrigen",0)+"</th>");
 print("<th>"+str("mSentido",0)+"</th>");
 print("<th>"+str("mHora",0)+"</th>");
 print("<th>"+str("mJustificacio",0)+"</th>");
 print("<th></th><th></th></tr></thead><tbody><tr>");

 print("<td>"+mov_dato("str_origen")+"</td>");
 print("<td>"+mov_sentido(0)+"</td>");
 print("<td>");
 $t=mov_instante(0);
 print("<input class='time-edit' type='time' id='$h_marc' name='$h_marc' value='"+recorta($t,9,10)+":"+recorta($t,11,12)+"'>");
 //ponParametro("$h_marc", "", 8,"");
 //ponValorParametro("$h_marc",a_hora(recorta($t,9,12)));
 print("</td><td>");
 $i=mov_dato("NI");

 $opciones_lista_justificaciones = "";

 $sql_justificaciones = "select cti.incid as cod,coalesce(ij.just_nombre,'"+str("mEntraSale",0)+"') as nom from"+
" (select tabla_saldos,ch from contratos_ch where pers_codigo="+campoPersona("codigo")+
" and pers_tipo="+campoPersona("tipo_persona")+" and "+hoy()+" between inicio and fin) c "+
" join tablas_saldos ts on ts.ch=c.ch and ts.tabla=c.tabla_saldos"+
" join col_tablas_incid_portal cti on cti.tabla=ts.tabla"+
" left join i_justificaciones ij on ij.cod_id=cti.incid and ij.conv_id="+
"(select max(conv_id) from i_convenios where ua_id=ts.ch)";

 creaFuente("query_justificaciones",1,$sql_justificaciones,"");
 lanzaInterfaz("portal.llena_lista_justificaciones","query_justificaciones","");
 ponParametro("$f_incidencia", "style='width:100%;'",5,$opciones_lista_justificaciones);
 ponValorParametro("$f_incidencia",$i);
 print("</td><td></tr><tr><td colspan='4'>");
 ponParametro("$j_marcaje", "", 2,"invisible");
 ponValorParametro("$j_marcaje",campoCalculo("dia"));
 print("<textarea placeholder='"+str("mComentario.",0)+"' name='$comentario' spellcheck='false' rows='3' cols='80'></textarea>");
 print("</td><td>");
 ponComponente("$edit_mov",str("mModificar",0),9,0,"");
 print("</td><td>");
 ponComponente("$borrar_mov",str("mBorrar",0),9,0,"f=R");
 print("</td></tr></tbody></table>");
 cierraFormularioHTML("");
 print("</td></tr></tbody></table></div>");
FSI;/####/Interfaz:lista_tm/####/$operacion_global=1;
print("<div class='row col-12'><table class='contenedor marges_taula'><tbody><tr id><td>");
clase_html="form-top";
formularioHTML("form","0022_gen",0);
clase_html="";
//lanzaInterfaz("portal.filtro_personas","","");
propiedadUsuario("persona");
setPropiedadFiltro("persona",campoPersona("tipo_persona")+""+campoPersona("codigo"));
$ayer=a_fecha(fecha)-1;
SI (indefinido($f_inicio)) ENTONCES $f_inicio=a_texto($ayer-30);$f_fin=($ayer+30);FSI;
SI ($f_inicio=="") ENTONCES $f_inicio="20150101";FSI;
SI ($f_fin=="") ENTONCES $f_fin="99991231";FSI;
print("<table width='100%'><tr><td><label class='label-select'>"+str("mDesde",0)+"</label>");
clase_html="date-edit";
ponParametro("$f_inicio", "", 1,"");
print("<label class='label-select'>"+str("mHasta",0)+"</label>");
ponParametro("$f_fin", "", 1,"");
ponValorParametro("$f_inicio",$f_inicio);
clase_html="";
print("</td><td>");
SI ($f_fin<>"99991231") ENTONCES ponValorParametro("$f_fin",$f_fin);FSI;
$modpet=getVariableGlobal("filtro_pet");
SI ($modpet=="1") ENTONCES setPropiedadFiltro("refresco","");FSI;
//setVariableGlobal("f_pet","0");
$flags="";
//SI (indefinido($chk)) ENTONCES $chk="0"; FSI;
lanzaInterfaz("portal.peticion.pon_checks","","");
print("</td><td>");
ponComponente("$aplicar",str("mAplicar",0),9,0,"");
print("</td></tr></table>");
SI ($pers_filtro=="0") ENTONCES tablaHTML(5,"tabla_datos,100");
SINO tablaHTML(6,"tabla_datos,100");
FSI;
//print(str("mEstado",0));
print("");
print(str("mTipo",0));
print(str("mIncid",0));
clase_contenedor="numero";
print(str("mFecha",0));
clase_contenedor="";
print(str("mCreadoPor",0));
print(str("mPendiented",0));
clase_contenedor="";
$drdr=propiedadFiltro("persona");
SI (getVariableGlobal("f_pet")=="3") ENTONCES
setPropiedadFiltro("persona","9,9999999");
FSI;
//informa($flags);
creaFuente("peticiones",21,$f_inicio+","+$f_fin,$flags+"V");

SI ($pers_filtro=="0") ENTONCES print(str("mEmpleado",0));FSI;
SI ($pers_filtro=="0") ENTONCES lanzaInterfaz("portal.peticion.vista_global","filtro_pers","");
SINO
//lanzaInterfaz("carga_peticiones","peticiones","");
creaFuente("mapa_pet",13,"","");
lanzaInterfaz("portal.peticion.precarga_peticiones","peticiones","");
lanzaInterfaz("portal.peticion.carga_peticiones2","mapa_pet","");
FSI;
cierraTablaHTML();
cierraFormularioHTML("");
print("</td></tr></tbody></table></div>");/####/Interfaz:modifica_peticion/####/SI (buscaPeticion(a_entero($idpet),a_entero($tpet))) ENTONCES
 $perm=campoPersona("permisos_peticion,"+$idpet+","+$tpet);
 $link="ctxo"+$idpet+"T"+$tpet+"_0006_gen.html";
 $pers_pet=campoObjetoCalculo("peticion", "empleado");
 SI (indefinido($adjuntar)==0) ENTONCES
  modificarPeticion("C",0,str("mAdjuntar",0),0);
  lanzaInterfaz("portal.notificaciones","","");
 FSI;

 SI (indefinido($desadjuntar)==0) ENTONCES
  modificarPeticion("C",0,str("mEliminar",0),1);
  lanzaInterfaz("portal.notificaciones","","");
 FSI;

 SI (indefinido($nuevo_coment)==0) ENTONCES
  modificarPeticion("C",0,$comentario,a_entero($check_borrar));
  lanzaInterfaz("portal.notificaciones","","");
 FSI;

 SI (indefinido($vista)==0) ENTONCES
  informa("Paso por aquí");
  modificarPeticion("V",0,$comentario,0);
  lanzaInterfaz("portal.notificaciones","","");
 FSI;

 SI (indefinido($anular)==0) ENTONCES
  SI (campoObjetoCalculo("peticion", "estado")==2) ENTONCES
   $pers_pet=campoObjetoCalculo("peticion", "empleado");
   $idpet=crearPeticion("D","",a_entero($idpet),a_entero($tpet),0,0);
   $link="ctxo"+$idpet+"T"+$tpet+"_0006_gen.html";
  SINO 
   modificarPeticion("N",0,$comentario,0);
  FSI;
  lanzaInterfaz("portal.notificaciones","","");
 FSI;

 SI (indefinido($aprobar)==0) ENTONCES
  $def=2;
  SI (buscaTexto($perm,"D")>0) ENTONCES 
   $def=1;
  FSI;
  modificarPeticion("A",$def,$comentario,0);
  lanzaInterfaz("portal.notificaciones","","");
  FSI;
 SI (indefinido($rechazar)==0) ENTONCES
  modificarPeticion("R",0,$comentario,0);
  lanzaInterfaz("portal.notificaciones","","");
 FSI;
FSI;/####/Interfaz:peticion_comentarios/####/print("<div class='row col-12'><table class='contenedor marges_taula' >");
print("<tbody><tr><td><label class='numero2'>"+str("mHistoricoCam",0)+"</label>");
creaFuente("comentarios",22,"comentarios_peticion","");
tablaHTML(4,"tabla_datos,100");
print(str("mInstante",0));print(str("mOperacion",0));
print(str("mComentario",0));print(str("mUsuario",0));
lanzaInterfaz("portal.comentario","comentarios","");
cierraTablaHTML();
print("</td></tr></tbody></table></div>");/####/Interfaz:peticion2/####/$estPet=campoObjetoCalculo("peticion","estado");
$perm=campoPersona("permisos_peticion,"+$idpet+","+$tpet);

SI ($estPet==1) ENTONCES
 print("<tr id><td colspan='6'>");
 print("<textarea placeholder='"+str("mComentario.",0)+"' name='$comentario' spellcheck='false' rows='1' cols='80'></textarea>");
 print("</td><td><input type='submit' name='$nuevo_coment' value='"+str("mAfegirComentari",0)+"'></td>");
 print("</tr>");
FSI;
print("</tbody>");

SI ($estPet==1) ENTONCES
 //incluimos el resumen del máximo
 lanzaInterfaz("portal.utils.resumen_maximos_peticion","","");
FSI;

print("</table>");

//botones aprobar/rechazar (solo TM/PM)
print("<table class='contenedor marges_taula'><tbody>");
print("<td width='33%'>");
$perm=campoPersona("permisos_peticion,"+$idpet+","+$tpet);
setVariableGlobal("permisos_peticion",$perm);

$es_validador=propiedadUsuario("validador")=="1";
SI( $es_validador Y ($estPet==1) Y (buscaTexto($perm,"P")>0) ) ENTONCES
 ponComponente("$aprobar",str("mAprobar",0),9,0,""); 
 print("</td><td width='33%'></td><td width='33%'>");
 ponComponente("$rechazar",str("mRechazar",0),9,0,"f=R"); 
SINO

 SI( (propiedadUsuario("pmv")=="1") Y ($estPet==1)) ENTONCES
  ponComponente("$aprobar",str("mAprobar",0),9,0,""); 
  print("</td><td width='33%'></td><td width='33%'>");
  ponComponente("$rechazar",str("mRechazar",0),9,0,"f=R"); 
 FSI;
FSI;
print("</td></tbody></table>");
print("</form></td></tr>");
print("</tbody></table></div>");

print("<div class='row col-12'>");
print("<table class='contenedor marges_taula'><tbody><tr><td>");
formularioHTML("form_file","ctxo"+$co+"_0006_gen",1);

lanzaInterfaz("portal.peticion.peticion_adjunto","","");

cierraFormularioHTML("");
print("</td></tr></tbody></table></div>");/####/Interfaz:carga_peticiones/####/$fd=formatoFecha("DDMMAAAA","/");
$fdh=formatoFecha("DDMMAAAAhhmm","/| |:");
$idpet=campoObjetoCalculo("peticion","id");
$tipp=campoObjetoCalculo("peticion","tipo");
clase_contenedor="img-col";
ponComponente(campoObjetoCalculo("peticion","icono"),"",16,0,"");
clase_contenedor="";

SI ($tipp==4) ENTONCES
ponEnlace("ctxoM"+a_texto($idpet)+"_0004_gen");
SINO
ponEnlace("ctxo"+a_texto($idpet)+"T"+$tipp+"_0006_gen");
FSI;

//SI (($tipp==1)O($tipp==4)) ENTONCES
$tipo=campoObjetoCalculo("peticion","str_tipo");
SI (($tipo=="Movimiento")+($tipo=="Días")) ENTONCES
 print(str("mIncid",0));
SINO
 $masdatos = "";
 SI ($tipp==1) ENTONCES
  $masdatos="("+campoObjetoCalculo("peticion","str_operacion")+")";
 FSI; 
 print($tipo+" "+$masdatos);
FSI;

$motivo="";

SI ($tipp==1) ENTONCES
 $motivo=campoObjetoCalculo("peticion","hora");
FSI;
$motivo=$motivo+" "+campoObjetoCalculo("peticion","str_ind");
SI ($motivo=="") ENTONCES 
 print("-");
SINO 
 print($motivo);
FSI;
//FSI;
clase_contenedor="numero";

SI (($tipp==2)O($tipp==4)) ENTONCES
 $s2=a_fecha(campoObjetoCalculo("peticion","fecha"));
 print(formatea($s2,$fd));
SINO
 $s1=(a_fecha(campoObjetoCalculo("peticion","fecha")));
 print(formatea($s1,$fd));
FSI;

clase_contenedor="";

SI ($operacion_global) ENTONCES
 print(campoObjetoCalculo("peticion","empleado"));
FSI;
SI (campoObjetoCalculo("peticion","estado")==1) ENTONCES
 print(campoObjetoCalculo("peticion","pendiente"));
SINO 
 print("");
FSI;


/####/Interfaz:peticion_adjunto/####/
$adj=campoObjetoCalculo("peticion","adjunto");

//solo se debe poner si hay adjunto o la petición pendiente
SI ( ($estPet==1) + ($estPet==5) + ($adj<>"") ) ENTONCES

 print("<label class='numero2'>"+str("mJustificante",0)+"</label>");
 print("<table class='tabla_datos' width='100%'><thead><tr id=''>");
 print("<th>"+str("mArchivo",0)+"</th><th></th><th></th></tr></thead>");
 print("<tbody><tr><td width='50%'>");

 $esValidador = buscaTexto($perm,"P");

 SI ($adj<>"") ENTONCES
  //hay adjunto
  $docAdj="docs/"+$adj;
  $opcionesComp="f=EB|i=portal/view-file_brand.svg|s=float:left;width:30px;";
  ponComponente($docAdj,"",9,2,$opcionesComp);
  print("</td><td width='32%'></td><td>");
  SI ($esValidador>0) ENTONCES
   print("<br>"); 
  SINO
   SI ( ($estPet==1) + ($estPet==5) ) ENTONCES
    ponComponente("$desadjuntar",str("mEliminar",0),9,0,"f=R");
   SINO
    print("<br>");
   FSI;
  FSI;
 SINO
 //no hay adjunto
  SI ($esValidador>0) ENTONCES
   print("</td><td width='32%'></td><td>");
  SINO
   print("<label for='doc' class='inputfile'>"+str("mSelectFile",0)+"</label>");
   ponComponente("$adjunto","",24,0,"");
   print("</td><td width='32%'></td><td>");
   SI ( ($estPet==1) + ($estPet==5) ) ENTONCES
    ponComponente("$adjuntar",str("mAdjuntar",0),9,0,"");
   SINO
    print("<br>");
   FSI;
  FSI;
 FSI;
 print("</td></tr></tbody></table>");
FSI;/####/Interfaz:movimiento/####/revisaMovimientos("portal.peticion.movimientos");/####/Interfaz:carga_peticiones2/####/$mp=campo();
$fd=formatoFecha("DDMMAAAA","/");
$fdh=formatoFecha("DDMMAAAAhhmm","/| |:");
$idpet=getValor($mp,"idpet");
$tipp=a_entero(getValor($mp,"tipo"));
clase_html="";
ponComponente(getValor($mp,"icono"),"",16,0,"");

SI ($tipp==4) ENTONCES
ponEnlace("ctxoM"+a_texto($idpet)+"_0004_gen");
SINO
ponEnlace("ctxo"+a_texto($idpet)+"T"+$tipp+"_0006_gen");
FSI;

$tipo=getValor($mp,"str_tipo");
print($tipo);

$motivo=getValor($mp,"str_ind");
SI ($motivo=="") ENTONCES print("-");
SINO print($motivo);
FSI;
clase_contenedor="numero";

SI (($tipp==2)O($tipp==4)) ENTONCES
$s2=a_fecha(getValor($mp,"fecha"));
print(formatea($s2,$fd));
SINO
 $s1=(a_fecha(getValor($mp,"fecha")));
 SI ($tipp==1) ENTONCES
  print(formatea($s1,$fd)+" "+getValor($mp,"hora"));
 SINO
  print(formatea($s1,$fd));
 FSI;
FSI;

clase_contenedor="";

print(getValor($mp,"empleado"));
SI (getValor($mp,"estado")=="1") ENTONCES
print(getValor($mp,"pendiente"));
SINO print("");
FSI;
//lanzaInterfaz("nombres_PM","","");


/####/Interfaz:operacion/####/$co=getVarHTTP("contexto");
$l=length($co);
$idpet=a_entero(recorta($co,1,$l-2));
$tpet=a_entero(recorta($co,$l,$l));
lanzaInterfaz("portal.peticion.modifica_peticion","","");
$parte_anual=0;
SI (buscaPeticion($idpet,$tpet)) ENTONCES
 $parte_anual=campoObjetoCalculo("peticion","peticion_anual");
FSI;
SI ($parte_anual>0) ENTONCES
ponComponente("0004_gen","",19,0,"");
SINO
SI ($es_gestor) ENTONCES
ponComponente("ctxo"+campoObjetoCalculo("peticion","fecha")+
campoPersona("tipo_persona")+"C"+campoPersona("codigo")+
"_0022_gen","",19,0,"");
SINO
ponComponente("ctxo"+campoObjetoCalculo("peticion","fecha")+
campoPersona("tipo_persona")+campoPersona("codigo")+
"_0005_gen","",19,0,"");
FSI;
FSI;/####/Paquete:portal.jornada/####/Interfaz:ventana_jornada/####/$co=getVarHTTP("contexto");
$pos1=recorta($co,1,1);
SI ($co<>"") ENTONCES
/* SI ($pos1<>"_") ENTONCES
  fecha=recorta($co,1,8);
  $pjor=recorta($co,9,100);
 SINO
  fecha=recorta($co,2,9);
  $pjor=recorta($co,10,100);
 FSI; */
  fecha=recorta($co,1,8);
  $pjor=recorta($co,9,100);

  SI ($pjor<>"") ENTONCES
 setPropiedadFiltro("persona",$pjor);
  FSI;
SINO
  fecha=getVariableGlobal("fecha_jornada");
FSI;
setVariableGlobal("fecha_jornada",fecha);
$dia=a_fecha(fecha);

formularioHTML("form_pers","0005_gen",0);
SI ($es_gestor) ENTONCES lanzaInterfaz("portal.filtro_personas","",""); FSI;
cierraFormularioHTML("");

revisaCalculo("portal.jornada.tratamiento_jornada",$dia,$dia,"");

//SI ($planif_creada==0) ENTONCES
//  print("<script src='"+getURLManager()+"notie.js'></script>");
//  print("<script>notie.alert({ type: 3, text: 'Error: Supera el máximo', time: 2 })");  
//  print("</script>");
//FSI;

/####/Interfaz:nuevo_marcaje/####/print("<button id='nmovbtn' class='boton' style='width:auto;height:34px' type='button' onclick='showNewMov()' >"+str("mNuevoMarcaje",0)+"</button>");
print("<script>
function showNewMov() {
  var x = document.getElementById('nmovdiv'); x.style.display = 'block';
  x = document.getElementById('nmovbtn'); x.style.display = 'none';
}
function hideNewMov() {
  var x = document.getElementById('nmovdiv'); x.style.display = 'none';
  x = document.getElementById('nmovbtn'); x.style.display = 'block';
}</script>");
formularioHTML("mov","0005_gen",0);
print("<div id='nmovdiv' style='display:none;' class='row col-12'><table class='contenedor marges_taula'><tbody><tr id><td>");
print("<table class='tabla_datos' width='100%'><thead><tr id>");
print("<th>"+str("mHora",0)+"</th>");
print("<th>"+str("mMotivo",0)+"</th>");
print("<th>"+str("mComentario",0)+"</th><th width='10%'></th><th width='10%'></th></tr></thead><tbody>");
//tablaHTML(0,"contenedor");
print("<tr id><td>");
//ponParametro("$h_marc", "", 8,"");
//ponValorParametro("$h_marc","0000");
print("<input class='time-edit' type='time' id='$h_marc' name='$h_marc' value='00:00'>");
ponParametro("$d_marc", "",
5,"0;|1;"+str("mDiaSiguiente",0));
print("</td><td>");

$opciones_lista_justificaciones = "";

$sql_justificaciones = "select cti.incid as cod,coalesce(ij.just_nombre,'"+str("mEntraSale",0)+"') as nom from"+
" (select tabla_saldos,ch from contratos_ch where pers_codigo="+campoPersona("codigo")+
" and pers_tipo="+campoPersona("tipo_persona")+" and "+hoy()+" between inicio and fin) c "+
" join tablas_saldos ts on ts.ch=c.ch and ts.tabla=c.tabla_saldos"+
" join col_tablas_incid_portal cti on cti.tabla=ts.tabla"+
" left join i_justificaciones ij on ij.cod_id=cti.incid and ij.conv_id="+
"(select max(conv_id) from i_convenios where ua_id=ts.ch)";

creaFuente("query_justificaciones",1,$sql_justificaciones,"");
lanzaInterfaz("portal.llena_lista_justificaciones","query_justificaciones","");
ponParametro("$i_marc", "style='width:100%;'", 5, $opciones_lista_justificaciones);
print("</td><td>");
//ponParametro("$c_mac", "", 2,"");
print("<input class='input-comment' autocomplete='off' type='text' name='$c_mac' value='' placeholder='"+str("mComentario.",0)+"'>");
print("</td><td>");
//ponComponente("$nmov",str("mAplicar",0),9,0,"");
print("<input type='submit' name='$nmov' style='width:100%;height:34px;' value='"+str("mAplicar",0)+"'>");
print("</td><td>");
//ponComponente(getVarHTTP("ultima_url"),"Cancelar",9,1,"");
print("<button class='boton' type='button' style='width:100%;height:34px;'
onclick='hideNewMov()'>"+str("bCancelar",0)+"</button>");
print("</td></tr></tbody></table>");
print("</td></tr></tbody></table></div>");
cierraFormularioHTML("");/####/Interfaz:nueva_justificacion_dia/####/print("<button id='njdbtn' class='boton' style='width:auto;height:34px' type='button' onclick='showNewJD()' >"+str("mIncidenciaDE",0)+"</button>");
print("<script>
function showNewJD() {
 var x = document.getElementById('njddiv'); x.style.display = 'block';
 x = document.getElementById('njhbtn'); x.style.display = 'none';
 x = document.getElementById('njdbtn'); x.style.display = 'none';
}
function hideNewJD() {
 var x = document.getElementById('njddiv'); x.style.display = 'none';
 x = document.getElementById('njhbtn'); x.style.display = 'block';
 x = document.getElementById('njdbtn'); x.style.display = 'block';
}</script>");

formularioHTML("ind","0005_gen",0);
print("<div id='njddiv' style='display:none;' class='row col-12'>");

print("<table id='nplantab' class='tabla_datos' width='100%'><thead><tr id>");
print("<th width='25%'>"+str("mMotivo",0)+"</th>");
print("<th colspan='3'>"+str("mComentario",0)+"</th><th width='10%'></th><th width='10%'></th></tr></thead><tbody>");
print("<tr id><td>");

//solo justificaciones que pueda ver el tiparraco
 $mascosas = "cod_id in (select cti.incid from (select tabla_saldos,ch from contratos_ch where pers_codigo="+campoPersona("codigo")+
 "and pers_tipo="+campoPersona("tipo_persona")+" and "+hoy()+" between inicio and fin) c join tablas_saldos ts on ts.ch=c.ch and ts.tabla=c.tabla_saldos 
  join col_tablas_incid_portal cti on cti.tabla=ts.tabla)";
creaFuente("incids",22,"incidencias","W="+$mascosas);
ponParametro("$f_incidencia", " onchange='showRow(this)' style='width:100%;'", 5,"FUENTE:incids");

print("</td><td colspan='3'>");

print("<input class='input-comment' autocomplete='off' type='text' name='$f_comentario' value='' placeholder='"+str("mComentario.",0)+"'>");

ponParametro("$tipo_pet","",2,"invisible");
ponValorParametro("$tipo_pet","1");
print("</td><td>");
print("<input type='submit' name='$nind' style='width:100%;height:34px;' value='"+str("mAplicar",0)+"'>");
print("</td><td>");
print("<button class='boton' type='button' style='width:100%;height:34px;'
onclick='hideNewJD()'>"+str("bCancelar",0)+"</button>");
print("</td></tr></tbody>");
print("<thead><tr><th>"+str("mJustificacio",0)+"</th><th>"+str("mAprobadas",0)+"</th><th>"+str("mPorAprobar",0)+"</th>");
print("<th>"+str("mDisponibles",0)+"</th><th></th><th></th></tr></thead><tbody>");

$ejercicio=recorta($dia,1,4);

lanzaInterfaz("portal.utils.resumen_maximos_anuales","","");
print("</tbody></table>");
print("</div>");

//javascript para tratar el cambio en el combobox
print("<script>
 function showRow(selectItem) {
  var value= selectItem.value;
  var columnToShow = 'tmfila'+value;
  var table = document.getElementById('nplantab');
  for (var i = 0;  i<table.rows.length; i++) {
   var row = table.rows[i];
   if (row.id!='' && row.id!=columnToShow) {
    row.style.display='none';
   } else {
    row.style.display='table-row';
   }
  }
 }
</script>");

cierraFormularioHTML("");/####/Interfaz:nuevas_peticiones/####///saltarFilaParametros();
formularioHTML("ind","0005_gen",0);
lanzaInterfaz("portal.jornada.carga_peticiones_jor","peticiones_j","");
ponComponente("shc_in1a.html","Aviso (franja horaria)",9,1,"");
print(" ");
ponComponente("shc_in1b.html","Incidencia (día entero)",9,1,"");
cierraFormularioHTML("");/####/Interfaz:lista_movs/####/print("<tr id><td>");
$marcaje=campo();
$s=getValor($marcaje,"icono");
SI ($s<>"") ENTONCES 
 ponComponente($s,"",16,0,"");
FSI;
print("</td><td>");
clase_contenedor="numero";
SI (buscaTexto($perm_persona,"P")>0) ENTONCES 
 SI ($s=="") ENTONCES ponEnlace("ctxo"+getValor($marcaje,"id")+"_0007_gen");
 SINO ponEnlace("ctxo"+getValor($marcaje,"id")+"T"+
 getValor($marcaje,"tipo")+"_0006_gen");
 FSI;
FSI;
print(getValor($marcaje,"hora"));
print("</td><td>");
clase_contenedor="";
print(getValor($marcaje,"incidencia"));
print("</td><td>");
print(getValor($marcaje,"comentario"));
print("</td></tr>");/####/Interfaz:nueva_justificacion_horas/####/print("<button id='njhbtn' class='boton' style='width:auto;height:34px' type='button' onclick='showNewJH()' >"+str("mIncidenciaPH",0)+"</button>");
print("<script>
function showNewJH() {
 var x = document.getElementById('njhdiv'); x.style.display = 'block';
 x = document.getElementById('njhbtn'); x.style.display = 'none';
 x = document.getElementById('njdbtn'); x.style.display = 'none'; 
}
function hideNewJH() {
 var x = document.getElementById('njhdiv'); x.style.display = 'none';
 x = document.getElementById('njhbtn'); x.style.display = 'block';
 x = document.getElementById('njdbtn'); x.style.display = 'block';
}</script>");

formularioHTML("ind","0005_gen",0);
print("<div id='njhdiv' style='display:none;' class='row col-12'>");

print("<table id='nplantabhor' class='tabla_datos' width='100%'><thead><tr id>");
print("<th width='15%'>"+str("mMotivo",0)+"</th>");
print("<th width='25%'>"+str("mIntervalo",0)+"</th>");
print("<th colspan='2'>"+str("mComentario",0)+"</th><th width='10%'></th'><th width='10%'></th'></tr></thead><tbody>");
print("<tr id><td>");

//solo justificaciones de horas que pueda ver el tiparraco
 $mascosas = "cod_id in (select cti.incid from (select tabla_saldos,ch from contratos_ch where pers_codigo="+campoPersona("codigo")+
 "and pers_tipo="+campoPersona("tipo_persona")+" and "+hoy()+" between inicio and fin) c join tablas_saldos ts on ts.ch=c.ch and ts.tabla=c.tabla_saldos 
  join col_tablas_incid_portal cti on cti.tabla=ts.tabla)";
creaFuente("incids",22,"incidencias","S;W="+$mascosas);
ponParametro("$f_incidencia", " onchange='showRowHoras(this)' style='width:100%;'", 5,"FUENTE:incids");
print("</td><td>");

print(str("mDesde",0)+":  ");
print("<input class='time-edit' type='time' id='$f_inicio' name='$f_inicio' value='00:00'>");

print(str("mHasta",0)+":  ");
print("<input class='time-edit' type='time' id='$f_fin' name='$f_fin' value='00:00'>");

print("</td><td colspan='2'>");

print("<input class='input-comment' autocomplete='off' type='text' name='$f_comentario' value='' placeholder='"+str("mComentario.",0)+"'>");

ponParametro("$tipo_pet","",2,"invisible");
ponValorParametro("$tipo_pet","2");
print("</td><td>");

print("<input type='submit' name='$nindh' style='width:100%;height:34px;' value='"+str("mAplicar",0)+"'>");
print("</td><td>");
print("<button class='boton' type='button' style='width:100%;height:34px;'
onclick='hideNewJH()'>"+str("bCancelar",0)+"</button>");
print("</td></tr></tbody>");

print("<thead><tr><th>"+str("mJustificacio",0)+"</th><th>"+str("mAprobadas",0)+"</th><th>"+str("mPorAprobar",0)+"</th>");
print("<th>"+str("mDisponibles",0)+"</th><th></th><th></th></tr></thead><tbody>");

$ejercicio=recorta($dia,1,4);

lanzaInterfaz("portal.utils.resumen_maximos_anuales_horas","","");
print("</tbody></table>");
print("</div>");

//javascript para tratar el cambio en el combobox
print("<script>
 function showRowHoras(selectItem) {
  var value= selectItem.value;
  var columnToShow = 'tmfila'+value;
  var table = document.getElementById('nplantabhor');
  for (var i = 0;  i<table.rows.length; i++) {
   var row = table.rows[i];
   if (row.id!='' && row.id!=columnToShow) {
    row.style.display='none';
   } else {
    row.style.display='table-row';
   }
  }
 }
</script>");

cierraFormularioHTML("");/####/Interfaz:tratamiento_jornada/####/
fijaCalculoDia();
$fdia=formatoFecha("DDMMAAAA","/");
$fhora=formatoHora(0,0,2,0,0,":");
$f=sprintf($dia,$fdia);
lanzaInterfaz("portal.jornada.cabecera_dia","","");

$perm=campoPersona("permisos_peticion,0,4");
SI (buscaTexto($perm,"S")>0) ENTONCES
  botonesAdjuntos("mov,shc_mv1;ind,shc_in1");
SINO botonesAdjuntos(",");
FSI;

print("<div class='row col-12'><table class='contenedor marges_taula'>");
print("<tbody><tr id><td>");
clase_html="";
print("<label class='numero2'>"+str("mMarcajes",0)+"</label>");
print("<table class='tabla_datos' width='100%'><thead><tr id>");
print("<th>"+str("mEstado",0)+"</th>");
print("<th>"+str("mHora",0)+"</th>");
print("<th>"+str("mMotivo",0)+"</th>");
print("<th style='width:45%;'>"+str("mComentario",0)+"</th></tr></thead><tbody>");
creaFuente("mapa_movs",13,"","");
revisaMovimientos("portal.jornada.movimientos_diarios");
creaFuente("peticiones_m",21,fecha+","+fecha+",T=F","SRAOM");
lanzaInterfaz("portal.jornada.carga_peticiones_mov","peticiones_m","");
lanzaInterfaz("portal.jornada.lista_movs","mapa_movs","");
print("</tbody></table>");
SI (buscaTexto($perm_persona,"P")>0) ENTONCES
 lanzaInterfaz("portal.jornada.nuevo_marcaje","","");
FSI;
print("</td></tr></tbody></table></div>");

$nomAnomalias = campoCalculo("anomalias");
SI ($nomAnomalias<>"") ENTONCES
 print("<div class='row col-12'><table class='contenedor marges_taula'>");
 print("<tbody><tr id><td>");
 print("<label class='numero2'>"+str("mLisAnomal",0)+"</label></td></tr>");
 revisaAnomalias("portal.jornada.pon_anomalia");
 print("</tr></tbody></table></div>");
FSI;

print("<div class='row col-12'><table class='contenedor marges_taula'>");
print("<tbody><tr id><td>");
print("<label class='numero2'>"+str("mPeticiones",0)+"</label>");
print("<table class='tabla_datos' width='100%'><thead><tr id>");
print("<th class='img-col'></th><th>"+str("mTipo",0)+"</th>");
print("<th>"+str("mInformacion",0)+"</th>");
print("<th style='width:45%;'>"+str("mComentario",0)+"</th></tr></thead><tbody>");
creaFuente("peticiones_j",21,fecha+","+fecha+",T=JP","SRAOM");
lanzaInterfaz("portal.jornada.carga_peticiones_jor","peticiones_j","");
print("</tbody></table>");

SI (buscaTexto($perm_persona,"P")>0) ENTONCES
 lanzaInterfaz("portal.jornada.nueva_justificacion_horas","","");
 lanzaInterfaz("portal.jornada.nueva_justificacion_dia","","");
FSI;

print("</td></tr></tbody></table></div>");
/####/Interfaz:carga_peticiones_jor/####/$idpet=campoObjetoCalculo("peticion","id");

print("<tr id><td class='img-col'>");
ponComponente(campoObjetoCalculo("peticion","icono"),"",16,0,"");
print("</td><td>");
ponEnlace("ctxo"+a_texto($idpet)+"T"+campoObjetoCalculo("peticion","tipo")+"_0006_gen");
print(campoObjetoCalculo("peticion","str_ind"));
print("</td><td>");
clase_contenedor="numero";
print(campoObjetoCalculo("peticion","fechas"));
clase_contenedor="";
print("</td><td>");
print(campoObjetoCalculo("peticion","comentario"));
print("</td></tr>");

/####/Interfaz:cambio_tipo_indicador/####/tratamientoCambioComponente("$tipo_pet","1");
modificaComponente("$f_inicio",0,"");
modificaComponente("$f_fin",0,"");
modificaComponente("$f_incidencia",2,"incidencias");
tratamientoCambioComponente("$tipo_pet","2");
modificaComponente("$f_inicio",1,"");
modificaComponente("$f_fin",1,"");
modificaComponente("$f_incidencia",2,"incidencias");
tratamientoCambioComponente("$tipo_pet","3");
modificaComponente("$f_inicio",0,"");
modificaComponente("$f_fin",0,"");
modificaComponente("$f_incidencia",2,"incidencias");
tratamientoCambioComponente("$tipo_pet","4");
modificaComponente("$f_inicio",1,"");
modificaComponente("$f_fin",0,"");
modificaComponente("$f_incidencia",2,"incidencias");
tratamientoCambioComponente("$tipo_pet","5");
modificaComponente("$f_inicio",0,"");
modificaComponente("$f_fin",0,"");
modificaComponente("$f_incidencia",2,"jornadas");
tratamientoCambioComponente("","");/####/Interfaz:pon_anomalia/####/SI ((anom_propiedad("tipo")==0)*(!campoCalculo("anomalias")))  ENTONCES
 print("<td>");
 ponComponente(anom_propiedad("icono"),"",16,0,"");
 //print(str("mAnomalia",0)+": ");
 print("<label>  "+anom_propiedad("nombre")+"</label></td>");

SINO
 print("<td>"+str("mSinAnom",0)+"</td>");
FSI;
/####/Interfaz:movimientos_diarios/####/$mi=mov_minuto(0);
$pref="";
SI ($mi>1439) ENTONCES $mi=$mi-1440;$pref=">";FSI;
SI ($mi<0) ENTONCES $mi=$mi+1440;$pref="-";FSI;
$hora=sprintf($mi,$fhora);
$hr=$pref+$hora+"P";
creaFuente($hr,13,"","");
ponValor($hr,"hora",$hora);
ponValor($hr,"icono","");
$idm=mov_dato("id");
ponValor($hr,"id",$idm);
$sind=mov_dato("NI");
ponValor($hr,"incidencia",$sind);
ponValor($hr,"comentario","");
ponValor("mapa_movs",$hr,getFuente($hora));

/####/Interfaz:carga_peticiones_mov/####/$hora=campoObjetoCalculo("peticion","hora");
$desfase=campoObjetoCalculo("peticion","desfase_diario");
$hr=$hora;
SI ($desfase=="1") ENTONCES
$hr=">"+$hr;
FSI;
SI ($desfase=="2") ENTONCES
$hr="-"+$hr;
FSI;
$cop=campoObjetoCalculo("peticion","operacion");
SI ($cop==4) ENTONCES $hr=$hr+"D";
SINO $hr=$hr+"P";
FSI;
creaFuente($hr,13,"","");
ponValor($hr,"hora",$hora);
$idpet=campoObjetoCalculo("peticion","id");
ponValor($hr,"id",a_texto($idpet));
$tip=campoObjetoCalculo("peticion","tipo");
ponValor($hr,"tipo",$tip);
$ico=campoObjetoCalculo("peticion","icono");
ponValor($hr,"icono",$ico);
$sind=campoObjetoCalculo("peticion","str_ind");
ponValor($hr,"incidencia",$sind);
$com=campoObjetoCalculo("peticion","comentario");
ponValor($hr,"comentario",$com);
ponValor("mapa_movs",$hr,getFuente($hora));/####/Interfaz:respuesta/####/$idpet=0;
$tpet="3";
$f=a_entero(recorta(fecha,1,4));
fecha=getVariableGlobal("fecha_jornada");
$n=0;


SI ($f_incidencia<>"") ENTONCES $n=a_entero($f_incidencia);FSI;
SI (indefinido($nindh)==0) ENTONCES 
  lanzaInterfaz("portal.utils.crea_justificacion_horas","","");
  //$idpet=crearPeticion("H",$f_comentario,$n,$f_inicio,$f_fin,$f);
FSI;
SI (indefinido($nind)==0) ENTONCES
  lanzaInterfaz("portal.utils.crea_justificacion_1_dia","","");
  //$idpet=crearPeticion("P",$f_comentario,$n,a_fecha(fecha),a_fecha(fecha),$f);
FSI;
  /*$n=0;

  COMPRUEBA($tipo_pet)
  CASO ("1") ENTONCES 
    $idpet=crearPeticion("P",$f_comentario,$n,a_fecha(fecha),a_fecha(fecha),$f);
    $tpet="2";
  FIN
  CASO ("2") ENTONCES
    $idpet=crearPeticion("H",$f_comentario,$n,$f_inicio,$f_fin,$f);
  FIN
  CASO ("3") ENTONCES
    $idpet=crearPeticion("C",$f_comentario,$n,0,0,$f);
  FIN
  CASO ("4") ENTONCES
    $idpet=crearPeticion("C",$f_comentario,$n,$f_inicio,0,$f);
  FIN
  CASO ("5") ENTONCES
    $idpet=crearPeticion("J",$f_comentario,$n,0,0,$f);
  FIN
  FIN;
//Las del tipo que no necesita aprobación, se aprueban ya
  SI (campoObjetoCalculo("incidencia","tipo")=="nav") ENTONCES
   modificarPeticion("A",1,"",0);
  FSI;*/

SI (indefinido($nmov)==0) ENTONCES
  $tpet="1";
  $idpet=crearPeticion("M",$c_mac,$i_marc,$h_marc,$d_marc,$f);
FSI;
SI (indefinido($nintervalo)==0) ENTONCES
  $tpet="2";
  $idpet=crearPeticion("P",$f_comentario,a_entero($f_incidencia),
a_fecha(fecha),a_fecha(fecha),$f);
FSI;
SI ($idpet>0) ENTONCES
 $idpet=a_texto($idpet);
 $pers_pet=campoObjetoCalculo("peticion", "empleado");
 $link="ctxo"+$idpet+"T"+$tpet+"_0006_gen.html";
 lanzaInterfaz("portal.notificaciones","","");
FSI;
SI (indefinido($pers_filtro)==0) ENTONCES
  setPropiedadFiltro("persona",$pers_filtro);
FSI;/####/Interfaz:cabecera_dia/####/print("<div class='row col-12'>");
print("<table class='contenedor marges_taula'>");
print("<tbody><tr id><td class='contenedor'>");
print("<div class='row background'>");
$url=getURLPortal();
$urlMan=getURLManager();
$yesterday=a_texto(a_fecha($dia)-1);
$uid=campoPersona("tipo_persona")+campoPersona("codigo");
print("<a href='"+$url+"ctxo"+$yesterday+$uid+"_0005_gen.html'><img class='btn' src='"+$urlMan+"iconos/portal/izqg.svg'></a>");
print("<label class='info-any centered'>"+str(diaDeLaSemana($dia,0),0)+" "+$f+"</label>");
$tomorrow=a_texto(a_fecha($dia)+1);
print("<a href='"+$url+"ctxo"+$tomorrow+$uid+"_0005_gen.html'><img class='btn' src='"+$urlMan+"iconos/portal/derg.svg'></a>");
print("</div></td></tr>");
print("<tr><td>");
clase_html="tooltip-movs bottom";
ponComponente("","",21,1,campoPersona("tipo_persona")+campoPersona("codigo")+"_0005_gen");
print("</td></tr></tbody></table></div>");/####/Lanzador:peticion_mov/####/cierraTablaHTML();
lanzaInterfaz("portal.jornada.nuevo_marcaje","","");/####/Lanzador:jornada/####/lanzaInterfaz("portal.jornada.ventana_jornada","","");/####/Lanzador:respuesta/####/lanzaInterfaz("portal.jornada.respuesta","","");
lanzaInterfaz("portal.jornada.ventana_jornada","","");/####/Lanzador:peticion_fila2/####/print("");
creaFuente("i",22,"incidencias","");
creaFuente("j",22,"jornadas","");
ponParametro("$tipo_pet!canviCombo()", "", 5,"1;"+str("mDia",0)+
"|2;Aviso"); 
$modf=getVariableGlobal("modo_fila");
ponValorParametro("$tipo_pet",$modf);
tablaHTML(0,"");
ponParametro("$f_incidencia", "", 5,"FUENTE:i");
ponComponente("$f_inicio", "", 8,1,"");
ponValorParametro("$f_inicio","0000");
ponComponente("$f_fin", "", 8,1,"");
ponValorParametro("$f_fin","0000");
cierraTablaHTML();
ponParametro("$f_comentario", "", 2,"");
cierraTablaHTML();
clase_html="boton";
ponComponente("$nind",str("mAplicar",0),9,0,"");
ponComponente("incidencias", "", 5,1,"FUENTE:i");
ponComponente("jornadas", "", 5,1,"FUENTE:j");
creaScriptHTML("canviCombo","cambio_tipo_indicador");/####/Lanzador:peticion_fila/####/cierraTablaHTML();
$tipo=getVarHTTP("fichero");

$opciones_lista_justificaciones = "";
 $sql_justificaciones = "select cti.incid as cod,ij.just_nombre as nom from"+
" (select tabla_saldos,ch from contratos_ch where pers_codigo="+campoPersona("codigo")+
" and pers_tipo="+campoPersona("tipo_persona")+" and "+hoy()+" between inicio and fin) c "+
" join tablas_saldos ts on ts.ch=c.ch and ts.tabla=c.tabla_saldos"+
" join col_tablas_incid_portal cti on cti.tabla=ts.tabla"+
" join i_justificaciones ij on ij.cod_id=cti.incid and ij.conv_id="+
"(select max(conv_id) from i_convenios where ua_id=ts.ch)";

 creaFuente("query_justificaciones",1,$sql_justificaciones,"");
 lanzaInterfaz("portal.llena_lista_justificaciones","query_justificaciones","");

SI ($tipo=="shc_in1a.html") ENTONCES
 lanzaInterfaz("portal.jornada.nueva_justificacion_horas","","");
FSI;

SI ($tipo=="shc_in1b.html") ENTONCES
 lanzaInterfaz("portal.jornada.nueva_justificacion_dia","","");
FSI;

//cierraTablaHTML();
//clase_html="boton";
//ponComponente("$nind",str("mAplicar",0),9,0,"");
//ponComponente(getVarHTTP("ultima_url"),"Cancelar",9,1,"");

/####/Lanzador:modo_fila/####/SI (indefinido($tipo_pet)==0) ENTONCES
setVariableGlobal("modo_fila",$tipo_pet);FSI;
lanzaInterfaz("portal.jornada.ventana_jornada","","");/####/Paquete:portal.diagrama/####/Interfaz:intervalos_dias/####/clase_html="";
SI ($mes==recorta(campoCalculo("dia"),5,6)) ENTONCES
 ponComponente("","",21,0,campoPersona("tipo_persona")+campoPersona("codigo")+"_0005_gen");
FSI;/####/Interfaz:cambio_persona/####/SI (indefinido($pers_filtro)==0) ENTONCES
  setPropiedadFiltro("persona",$pers_filtro);
FSI;
lanzaInterfaz("portal.diagrama.movimientos","","");/####/Interfaz:movimientos/####/print("<div class='row col-12'>");
print("<table class='contenedor marges_taula'><tbody><tr id><td class='contenedor'>");

setPropiedadFiltro("persona",propiedadFiltro("persona"));
clase_html="form-cal";
formularioHTML("form_todos","0003_gen",0);
SI ($es_gestor) ENTONCES
 lanzaInterfaz("portal.filtro_personas","","");
FSI;
print("<div class='centre'>");
print("<div class='panels'>");
print("<div class='panel movs background'>");
print("<div class='panel-content'>");
print("<table class='contenedor' style='width: 100%;'><tbody><tr id>");
ponComponente("cal","",20,0,"");
print("</tr></tbody></table></div></div></div></div>");

print("<div class='centre'>");
print("<div class='panels'>");
print("<div class='panel movs'>");
print("<div class='panel-content'>");
print("<table class='lista_movs'>");

//tablaHTML(1,"lista_movs");
//print("");
$fecha=getVariableGlobal("fecha_calendario");
$f=a_fecha(recorta($fecha,1,6)+"01");
$mes=recorta($fecha,5,6);
revisaCalculo("portal.diagrama.intervalos_dias",$f-1,$f+"1M",propiedadUsuario("ch"));
//cierraTablaHTML();
//cierraFormularioHTML("");
print("</table></div></div></div></div></form>");
print("</td></tr></tbody></table></div>");
/####/Paquete:portal.resumen/####/Interfaz:carga_peticiones/####/
$fd=formatoFecha("DDMMAAAA","/");
$fdh=formatoFecha("DDMMAAAAhhmm","/| |:");
$idpet=campoObjetoCalculo("peticion","id");
$tipp=campoObjetoCalculo("peticion","tipo");

$tipo=campoObjetoCalculo("peticion","str_tipo");
$masdatos = "";
SI ($tipp==1) ENTONCES
 $masdatos="("+campoObjetoCalculo("peticion","str_operacion")+")";
 $tipo=$tipo+" "+$masdatos;
FSI;

$motivo=(campoObjetoCalculo("peticion","str_ind"));
ponComponente(campoObjetoCalculo("peticion","icono"),"",16,0,"");

SI ($tipp==4) ENTONCES
ponEnlace("ctxoM"+a_texto($idpet)+"_0004_gen");
SINO
ponEnlace("ctxo"+a_texto($idpet)+"T"+$tipp+"_0006_gen");
FSI;

SI (($tipo=="Movimiento")+($tipo=="Días")) ENTONCES
 print("Incidencia");
SINO 
 print("Aviso");
FSI;
SI ($motivo=="") ENTONCES 
 print("-");
SINO 
 print($motivo);
FSI;

clase_contenedor="numero";

SI (($tipp==2)O($tipp==4)) ENTONCES
 $s2=a_fecha(campoObjetoCalculo("peticion","fecha"));
 print(formatea($s2,$fd));
SINO
 $s1=(a_fecha(campoObjetoCalculo("peticion","fecha")));
 print(formatea($s1,$fd));
FSI;

SI (campoObjetoCalculo("peticion","estado")==1) ENTONCES
 print(campoObjetoCalculo("peticion","pendiente"));
SINO 
 print("");
FSI;
clase_contenedor="";
/####/Interfaz:resumen/####/$chk_error=1;
$chk_avis=0;
$chk_info=0;

print("<div class='row col-12'>");
print("<table class='contenedor marges_taula'><tbody><tr id><td>");
clase_html="form-top";
formularioHTML("form_todos","0001_gen",0);
SI ($es_gestor) ENTONCES
lanzaInterfaz("portal.filtro_personas","","");
FSI;
print("<div class='centre'>");
print("<div class='panels ie'>");
print("<div class='panel ie' style='max-width:400px;'>");
print("<div class='panel-content'>");
$ayer=a_fecha(fecha)-1;
print("<div class='numero2'>"+str("mContadores",0)+"</div>");
clase_html="";
print("<table class='flex-table tabla_datos' width='100%'><thead><tr id>");
print("<th>"+str("mTipo",0)+"</th>");
print("<th class='numero'>"+str("mVal",0)+"</th></tr></thead><tbody>");
revisaCalculo("portal.resumen.calculo_portal",$ayer,$ayer,"");
print("</tbody></table></div></div>");

print("<div class='panel ie' style='max-width:400px;'>");
print("<div class='panel-content'>");
print("<div class='numero2'>"+str("mAnomalias",0)+"</div>");
clase_html="boton";
ponComponente("0018_gen.html",str("mVerTodas",0),9,1,"");

clase_contenedor="";
clase_html="";

print("<table class='flex-table tabla_datos' width='100%'><thead><tr id>");
print("<th class='img-col'></th><th class='numero'>"+str("mDia",0)+"</th>");
print("<th>"+str("mAnomalia",0)+"</th></tr></thead><tbody>");
revisaCalculo("portal.resumen.calculo_portal2",$ayer-30,$ayer,"");
print("</tbody></table>");

print("</div></div>");

saltarFilaParametros();
$valid=0;
clase_html="numero2";
print("<div class='panel ie'>");
print("<div class='panel-content'>");
print("<div class='numero2'>"+str("mPeticiones",0)+"</div>");
clase_html="boton";
ponComponente("0019_gen.html",str("mVerTodas",0),9,1,"");
clase_html="";
tablaHTML(5,"flex-table tabla_datos,100");
clase_contenedor="img-col";
print("");
clase_contenedor="";
print(str("mTipo",0));
print(str("mMotivo",0));
clase_contenedor="numero";
print(str("mDia",0));
clase_contenedor="";
print(str("mPendiented",0));
creaFuente("peticiones",21,a_texto($ayer-15)+","+a_texto($ayer+300)+",AntiguasPendientes","SORM");
lanzaInterfaz("portal.peticion.carga_peticiones","peticiones","");
cierraTablaHTML();
print("</div></div>");
print("</div></div>");
clase_contenedor="numero";

SI ($es_gestor) ENTONCES
saltarFilaParametros();
$valid=1;
FSI;
cierraFormularioHTML("");
print("</td></tr></tbody></table></div>");
/####/Interfaz:lista_peticiones/####/
$nominci=campo("nom");
$idinci=campo("cod");
$per=recorta(campo("per"),2,5);
$ncarr = campo("nc");
$ncdisp = recorta($ncarr,1,length($ncarr)-1)+"$";
$ncreal = recorta($ncarr,1,length($ncarr)-1)+"+";
$td = campo("td");
$fhora=formatoHora(0,0,2,0,0,":");

print("<tr id><td>");
print("<table class='tabla_datos' width='100%'>");
print("<thead><tr id><th width='40%'>"+$nominci+"</th>");
print("<th>"+str("mDisponibles",0)+"</th><th>"+str("mAprobadas",0)+"</th><th>"+str("mPendientes",0)+"</th></tr></thead>");
print("<tbody>");

$anyActual = recorta($any,1,4);
$anyAnterior = a_entero($anyActual)-1;
$mesreinici = a_entero(recorta($per,1,2))+1;
$diareinici = recorta($per,3,4);
$mesreinici = a_texto($mesreinici);
SI (length($mesreinici)==1) ENTONCES $mesreinici = "0"+$mesreinici; FSI;
$reinici=$anyActual+$mesreinici+$diareinici;

$rei = a_texto(a_fecha($reinici)-1);
$ini = a_texto($anyAnterior)+"1231";
$fin = $anyActual+"1231";

$valarr = 0; //valor disponible 31/12
$valarrR = 0; //valor disponible arrastrado antes reinicio
$valFP = 0; //valor disponible a fin periodo
creaFuente("solicitadas",5,"","");
codigo=$codigo;
tipo_persona=$app;
buscaPersonaPorCodigo();
buscaContrato();
$ch = campoContrato("ch");
compruebaPlanificaciones("portal.resumen.consumos_periodo",a_fecha($ini),a_fecha($fin),$ch,0,"solicitadas");

SI (a_entero($mesreinici)>1) ENTONCES
 $valarrC = a_texto(a_entero($valarr)-a_entero($valarrR));
 SI ($td=="1") ENTONCES 
  $valarr=formatea($valarr,$fhora);
  $valarrR=formatea($valarrR,$fhora);
  $valarrC=formatea($valarrC,$fhora);
 SINO
  $valarr=a_texto(a_entero($valarr)-0);
  $valarrR=a_texto(a_entero($valarrR)-0);
 FSI;
 
 print("<tr id><td>"+str("mArrastradasH",0)+" "+formatea($reinici,$fd)+"</td><td>"+$valarr+"</td><td>"+$valarrC+"</td><td>"+$valarrR+"</td></tr>");
FSI;

$sql = "select valor from valores_periodo where pers_codigo="+$codigo+" and pers_tipo="+$app+" and periodo="+$anyActual+" and contador in (select contador from contadores where nom_c='"+$ncdisp+"')";

$val = a_entero(ejecutaSql($sql))/100;
$valC = a_texto(a_entero($val)-a_entero($valFP));
SI ($td=="1") ENTONCES 
 $val=formatea($val,$fhora);
 $valFP=formatea($valFP,$fhora);
 $valC=formatea($valC,$fhora);
SINO
 $val=a_texto(a_entero($val)-0);
 $valFP=a_texto(a_entero($valFP)-0);
FSI;
print("<tr id><td>"+str("mMaxAnual",0)+"</td><td>"+$val+"</td><td>"+$valC+"</td><td>"+$valFP+"</td></tr>");

print("<tr id style='font-weight:bold;'><td>"+str("mFechasSol",0)+"</td><td>"+str("mEstado",0)+"</td><td></td><td></td></tr>");

$sql="select 0 as tipo,inicio as dia,inicio,fin,estado from peticiones_intervalo where empleado_codigo="+$codigo+" and empleado_app="+$app+" and nueva_incidencia="+$idinci+" and inicio between "+$anyActual+"0101 and "+$anyActual+"1231"; 
$sql = $sql + "union select 1 as tipo,jornada as dia,inicio,fin,estado from peticiones_jornada where empleado_codigo="+$codigo+" and empleado_app="+$app+" and nueva_incidencia="+$idinci+" and jornada between "+$anyActual+"0101 and "+$anyActual+"1231";
creaFuente("peti",1,$sql,"");
lanzaInterfaz("portal.resumen.llena_peticiones","peti","");

print("</tbody>");
print("</table></td></tr>");
print("<tr id><td><label class='numero2'>  </label></td></tr>");
/####/Interfaz:calculo_portal/####///saldo mensual
SI ((campoPersona("grupo_opcional7")<>"NO")) ENTONCES $sh=1;
SINO $sh=0;
FSI;

$sql = "select cd.nom_c as nc,cd.nom as nom from (select tabla_saldos,ch from contratos_ch c where pers_codigo="+campoPersona("codigo")+" and pers_tipo="+campoPersona("tipo_persona")+" and "+hoy()+" between inicio and fin) c join i_convenios i on c.ch=i.ua_id and i.conv_fecha=(select max(conv_fecha) from i_convenios where ua_id=c.ch) join tablas_saldos t on t.tabla=c.tabla_saldos join i_plantilles_elements e on e.plant_id=t.plantilla_portal join contadores cd on cd.convenio=i.conv_id and cd.contador=e.elem_id";

creaFuente("query_contadores",1,$sql,"");
lanzaInterfaz("portal.resumen.llena_lista_valores_contadores","query_contadores","");

/####/Interfaz:calculo_anomalias/####/SI (anom_propiedad("tipo")==0)  ENTONCES
$hay=$hay+1;
FSI;
/####/Interfaz:revision_anomalias/####/$fd=formatoFecha("DDMMAAAA","/");
$fdh=formatoFecha("DDMMAAAAhhmm","/| |:");
SI (anom_propiedad("tipo")==0)  ENTONCES
 ponComponente(anom_propiedad("icono"),"",16,0,"");
 ponEnlace("ctxo"+fecha+"_0005_gen");
 print(formatea(a_fecha(fecha),$fd));
 print(anom_propiedad("nombre"));
FSI;
/####/Interfaz:calculo_portal3/####/revisaAnomalias("portal.resumen.calculo_anomalias");/####/Interfaz:calculo_portal2/####/revisaAnomalias("portal.anomalias.revision_anomalias");/####/Interfaz:grafico/####/tablaHTML(3,"tabla_datos,60,10,10,80");
clase_contenedor="numero";
print("Día");
print("Valor");
print("");
clase_contenedor="";
$ayer=a_fecha(fecha)-1;
revisaCalculo("portal.resumen.calculo_grafico",$ayer-30,$ayer,"");
cierraTablaHTML();/####/Interfaz:nombres_PM/####/SI ($valid) ENTONCES  
$pm=(campoObjetoCalculo("peticion","empleado"));
SI ($pm=="MARIN VALIENTE, SILVIA") ENTONCES
print("RRHH");
SINO
print(campoObjetoCalculo("peticion","empleado"));
FSI;
SINO 
$pm=(campoObjetoCalculo("peticion","pendiente"));
SI ($pm=="MARIN VALIENTE, SILVIA") ENTONCES
print("RRHH");
SINO
print(campoObjetoCalculo("peticion","pendiente"));
FSI; 
FSI;/####/Interfaz:cambio_persona/####/SI (indefinido($pers_filtro)==0) ENTONCES
  setPropiedadFiltro("persona",$pers_filtro);
FSI;
lanzaInterfaz("portal.resumen.resumen","","");/####/Interfaz:calculo_grafico/####/clase_contenedor="numero";
$d=campoCalculo("dia");
ponEnlace($d+"_jornada");
print(a_fecha($d));
$co=getVarHTTP("contexto");
$v=valorContador($co);
print($v);
clase_html="";
ponComponente("","",15,0,"400,-500,500,"+a_entero($v));/####/Interfaz:peticiones/####/
SI (indefinido($pers_filtro)==0) ENTONCES
  setPropiedadFiltro("persona",$pers_filtro);
FSI;

print("<div class='row col-12'><table class='contenedor marges_taula'>");
print("<tbody><tr id=''><td class='contenedor'>");
clase_html="form-cal";
formularioHTML("form","0023_gen",0);
clase_html="";
SI ($es_gestor) ENTONCES
 lanzaInterfaz("portal.filtro_personas","","");
FSI;
cierraFormularioHTML("");
$codigo = campoPersona("codigo");
$app = campoPersona("tipo_persona");

print("<div class='centre'>");
print("<div class='panels'>");
print("<div class='panel calendar background'>");
print("<div class='panel-content'>");
print("<table class='contenedor' style='width: 100%;'><tbody><tr id>");
ponComponente("sel","",20,1,"");
print("<td></td>");
print("<td></td>");
print("</tr></tbody></table>");
print("</div></div></div></div>");

$fd=formatoFecha("DDMMAAAA","/");

print("<div class='row col-12'>");
print("<table class='contenedor marges_taula'>");
print("<tbody><tr id><td>");
print("<label class='numero2'>"+str("mIcidAFecha",0)+" "+formatea(ahora,$fd)+"</label>");
print("</td></tr>");

$any = getVariableGlobal("fecha_calendario");

$sql_justificaciones = "select cti.incid as cod,ij.just_nombre as nom,o.acu_periodicidad as per,o.nom_c as nc,o.tipo_dato as td from"+
" (select tabla_saldos,ch from contratos_ch where pers_codigo="+campoPersona("codigo")+
" and pers_tipo="+campoPersona("tipo_persona")+" and "+hoy()+" between inicio and fin) c "+
" join tablas_saldos ts on ts.ch=c.ch and ts.tabla=c.tabla_saldos"+
" join col_tablas_incid_portal cti on cti.tabla=ts.tabla"+
" join i_justificaciones ij on ij.cod_id=cti.incid and ij.conv_id="+
"(select max(conv_id) from i_convenios where ua_id=ts.ch) "+
" join contadores o on o.contador=ij.acu_anyprev_id and o.convenio="+
"(select max(conv_id) from i_convenios where ua_id=ts.ch) "+
" where ij.acu_id>0 order by 2";

creaFuente("query_justificaciones",1,$sql_justificaciones,"");
lanzaInterfaz("portal.resumen.lista_peticiones","query_justificaciones","");

print("</tbody></table></div>");
print("</td></tr></tbody></table></div>");
/####/Interfaz:consumos_periodo/####/
$dia = a_texto(campoSimulacion("dia"));
//informa($dia);
SI ($dia==$ini) ENTONCES 
 $valarr=a_entero(campoSimulacion("vc:"+$ncdisp))/100;
 //informa($dia+" "+$ncdisp+": "+a_texto($valarr));
FSI;
SI ($dia==$fin) ENTONCES 
 $valFP=a_entero(campoSimulacion("vc:"+$ncdisp))/100;
 //informa($dia+" "+$ncdisp+": "+a_texto($valFP));
FSI;
SI ($dia==$rei) ENTONCES 
 $valarrR=a_entero(campoSimulacion("vc:"+$ncarr))/100;
 //informa($dia+" "+$ncarr+": "+a_texto($valFP));
FSI;
/####/Interfaz:llena_lista_valores_contadores/####/$nomc = campo("nc");
$nom = campo("nom");
$n=valorContador($nomc);

//print($nom);
//clase_html="numero";print($n);clase_html="";
print("<tr id><td>"+$nom+"</td><td class='numero'>");
print($n);
print("</td></tr>");
/####/Paquete:portal.ficha/####/Interfaz:lista_candidatos/####/$codigo=campo("PERS_CODIGO");
$ap=campo("PERS_TIPO");
ponEnlace("ctxo"+$co+"N"+$ap+$codigo+"_0021_gen");
print(campo("PERS_NOMBRE")+", "+campo("PERS_PILA"));/####/Interfaz:cambia_ficha/####/$campwd = getVariableGlobal("cambia_password");
SI ($pwd1<>"") ENTONCES 
 SI ($campwd=="1") ENTONCES setVariableGlobal("cambia_password","2"); FSI;
 $msg = "";
 $type = 1;
 SI ($pwd1==$pwd2) ENTONCES
  setPropiedadUsuario("password",$pwd1,1);
  $msg=htmlEscape(str("mSalvado",0));
 SINO
  $msg=htmlEscape(str("ePasswnocoinciden",0));
  $type = 3;
 FSI;
 //print("<script type='text/javascript'>alert('"+htmlEscape(str("mSalvado",0))+"');</script>");
 print("<script src='"+getURLManager()+"notie.js'></script>");
 //print("<script>notie.setOptions({alertTime: 2})</script>");
 print("<script>notie.alert({ type: "+$type+", text: '"+$msg+"', time: 2 })");  
 print("</script>");
 //setPropiedadUsuario("idioma",$idioma,1);
SINO
 setVariableGlobal("cambia_password","1");
FSI;
lanzaInterfaz("portal.ficha.ficha","","");/####/Interfaz:edicion_tm/####/$co=getVarHTTP("contexto");
$nf=buscaTexto($co,"F");
$fecha_1="";
SI ($nf>0) ENTONCES
  $fecha_1=recorta($co,1,$nf-1);
  $co=recorta($co,$nf+1,100);
FSI;
$nf=buscaTexto($co,"F");
$fecha_2="";
SI ($nf>0) ENTONCES
  $fecha_2=recorta($co,1,$nf-1);
  $co=recorta($co,$nf+1,100);
FSI;
$nodo="";
$nf=buscaTexto($co,"N");
SI ($nf>0) ENTONCES
  $nodo=recorta($co,1,$nf-1);
  $co=recorta($co,$nf+1,100);
FSI;
tipo_persona=a_entero(recorta($co,1,1));
codigo=a_entero(recorta($co,2,100));
SI (buscaPersonaPorCodigo()) ENTONCES
 SI ($params) ENTONCES lanzaInterfaz("portal.ficha.modificar_tm","","");
 SINO
 formularioHTML("tms","ctxo"+getVarHTTP("contexto")+"_0021_gen",0);
 clase_html="info";
 print(campoPersona("nombre_completo"));
 clase_html="";
 saltarFilaParametros();
 SI ($fecha_1=="") ENTONCES $fecha_1=fecha;FSI;
 SI ($fecha_2=="") ENTONCES $fecha_2="99991231";FSI;
 ponComponente("$f_inicio", str("mDesde",0), 1,0,"");
 ponValorParametro("$f_inicio",$fecha_1);
 ponComponente("$f_fin", str("mHasta",0), 1,0,"");
 saltarFilaParametros();
 ponValorParametro("$f_fin",$fecha_2);
 clase_html="boton";
 ponComponente("$ntm",str("mAplicar",0),9,0,"");print(" ");
 ponComponente("$borrar",str("mBorrar",0),9,0,"f=R");
 FSI;
 cierraFormularioHTML("");
FSI;/####/Interfaz:ver_nodo/####/$co=getVarHTTP("contexto");
creaFuente("nodos",22,"nodos_jerarquia",
"a="+campoPersona("tipo_persona")+"|c="+campoPersona("codigo"));
lanzaInterfaz("portal.ficha.trata_nodo","nodos","");/####/Interfaz:modificar_tm/####/fecha_inicio=$f_inicio;
fecha_fin=$f_fin;
SI (indefinido($borrar)==0) ENTONCES
 gestionaTM(2,a_entero($nodo),"");
SINO
 SI (fecha_fin=="") ENTONCES fecha_fin="99991231";FSI;
 SI ($fecha_1=="") ENTONCES
 //nuevo
 gestionaTM(0,a_entero($nodo),"");
 SINO
 //editar: primero recortamos y luego asignamos por si hay que fusionar intervalos
 gestionaTM(1,a_entero($nodo),$fecha_1);
 gestionaTM(0,a_entero($nodo),"");
 FSI;
FSI;
ponComponente("ctxo"+$nodo+"_0020_gen","",19,0,"");/####/Interfaz:muestra_nodo/####/ponEnlace("ctxo"+campoObjetoCalculo("nodo_jerarquia","id")+"_0020_gen");
print(campoObjetoCalculo("nodo_jerarquia","nombre"));/####/Interfaz:muestra_tm/####/tipo_persona=a_entero(campo("PERS_TIPO"));
codigo=a_entero(campo("PERS_CODIGO"));
SI (buscaPersonaPorCodigo()) ENTONCES
  ponEnlace("ctxo"+campo("INICIO")+"F"+campo("FIN")+"F"+
$co+"N"+a_texto(tipo_persona)+a_texto(codigo)+"_0021_gen");
  print(campoPersona("nombre_completo"));
  print(a_fecha(campo("INICIO")));
  $f=campo("FIN");
  SI ($f=="99991231") ENTONCES print("");
  SINO print(a_fecha($f));
  FSI;
FSI;/####/Interfaz:trata_nodo/####/SI (campoObjetoCalculo("nodo_jerarquia","id")==$co) ENTONCES
clase_html="info";
print(campoObjetoCalculo("nodo_jerarquia","nombre"));
clase_html="";
tablaHTML(3,"tabla_datos,100");
print(str("mNom",0));
print(str("mDesde",0));
print(str("mHasta",0));
creaFuente("tms",1,"HST_ORG_EMPRESA",
"ORDER BY FIN DESC");
lanzaInterfaz("portal.ficha.muestra_tm","tms","CH="+
a_texto(propiedadUsuario("idch"))+" AND NODO="+$co);
cierraTablaHTML();
formularioHTML("tms","ctxo"+$co+"_0020_gen",0);
SI ($params) ENTONCES
 tablaHTML(1,"tabla_datos,100");
 print(str("mNuevo",0));
 creaFuente("candidatos",1,"PERSONAS","ORDER BY PERS_NOMBRE,PERS_PILA");
 lanzaInterfaz("portal.ficha.lista_candidatos","candidatos",
 "UPPER (PERS_NOMBRE+', '+PERS_PILA) LIKE UPPER('%"+$nombre+"%')");
 cierraTablaHTML();
SINO
 ponParametro("$nombre", "", 2,"");
 ponComponente("$ntm",str("mNuevo",0),9,0,"");
FSI;
cierraFormularioHTML("");
FSI;/####/Interfaz:ficha/####/propiedadUsuario("persona");

print("<div class='row col-12'><table class='contenedor marges_taula'>");
print("<tbody><tr id><td class='contenedor'>");
formularioHTML("form_pers","0011_gen",0);
print("<div class='row'>");
print("<div class='col-10'>");
print("<table class='contenedor marges_taula'><tbody><tr id><td>");
print("<label class='numero2'>"+str("mMisDatos",0)+"</label>");
print("<table class='tabla_datos' style='width:100%'>");
print("<thead><tr><th>"+str("mNombre",0)+"</th><th></th><th>"+str("mApellidos",0)+"</th><th></th></tr></thead>");
print("<tbody><tr id>");
print("<td colspan='2'><label>"+campoPersona("nombre")+"</label></td>");
print("<td colspan='2'><label>"+campoPersona("apellidos")+"</label></td><td></td>");
print("</tr></tbody>");
print("<thead><tr><th>"+str("mDepartamento",0)+"</th><th></th><th>"+str("mJerarquia",0)+"</th><th></th></tr></thead>");
print("<tbody><tr id>");
buscaDepartamentoPersona();
print("<td colspan='2'><label>"+rutaDepartamento(1,10)+"</label></td>");
SI (buscaJerarquiaPersona(0)) ENTONCES
 print("<td><label>"+rutaJerarquia(1,10,"0")+" ("+campoObjetoCalculo("nodo_jerarquia","tms")+")</label></td>");
SINO
 print("<td></td>");
FSI;
print("</tr></tbody>");
print("<thead><tr><th>"+str("mPassword",0)+"</th><th>"+str("mConfPWD",0)+"</th><th></th><th></th></tr></thead>");
print("<tbody><tr id><td>");
clase_html="input-login";
ponParametro("$pwd1", "", 2,"oculto");
print("</td><td>");
ponParametro("$pwd2", "", 2,"oculto");
clase_html="input-login";
print("</td><td></td><td>");
ponComponente("$guardar",str("mGuardar",0),9,0,"");
print("</td></tr></tbody></table></td></tr></tbody></table></div>");

//creaFuente("idioma",22,"idiomas","");
//ponParametro("$idioma",str("mIdioma",0),5,"FUENTE:idioma");
//ponValorParametro("$idioma",propiedadUsuario("idioma"));

//la fotaca
print("<div class='col-2' style='overflow: hidden;'>");
print("<table class='contenedor marges_taula'><tbody><tr id><td class='photo'>");
$dni=campoPersona("dni");
ponComponente("/iconos/emple/"+campoPersona("id")+".jpg","",16,0,"");
print("</td></tr></tbody></table></div>");


print("</div>");
cierraFormularioHTML("");
print("</td></tr></tbody></table></div>");

$cambia_password=getVariableGlobal("cambia_password");
SI ($cambia_password=="1") ENTONCES
 print("<script src='"+getURLManager()+"notie.js'></script>");
 print("<script>notie.alert({ type: 4, text: '"+str("mDebeCambiarPwd",0)+"', time: 5 })");  
 print("</script>");
FSI;/####/Paquete:portal.calendario/####/Interfaz:comentarios/####/SI (buscaPeticion(a_entero($p),4)) ENTONCES
formularioHTML("form_com","0004_gen",0);
ponParametro("$comentario", "", 2,"2,50");
saltarFilaParametros();
ponComponente("$nuevo_coment",str("mComentar",0),9,0,"");
cierraFormularioHTML("");
lanzaInterfaz("portal.lista_comentarios","","");
FSI;/####/Interfaz:busca_plan_anual/####/$e=getValor("planes","estado");
$p2=getValor("planes","codigo");
COMPRUEBA ($e)
CASO ("1") ENTONCES 
  SI ($hay_solicitada==0) ENTONCES
SI ($smodosplan<>"") ENTONCES $smodosplan=$smodosplan+"|";FSI;
$smodosplan=$smodosplan+"1;"+str("mSolicitada",0);
  FSI;
  $hay_solicitada=1;
FIN
CASO ("2") ENTONCES
  SI ($hay_aprobada==0) ENTONCES
SI ($smodosplan<>"") ENTONCES $smodosplan=$smodosplan+"|";FSI;
$smodosplan=$smodosplan+"2;"+str("mAprobada",0);
  FSI;
  $hay_aprobada=1;
FIN
DEFECTO
  SI ($hay_descartada==0) ENTONCES
SI ($smodosplan<>"") ENTONCES $smodosplan=$smodosplan+"|";FSI;
$smodosplan=$smodosplan+"4;"+str("mAnulada",0);
  FSI;
  $hay_descartada=1;
FIN
FIN;
SI ($mp=="") ENTONCES 
$mp=$e;
FSI;
SI ($mp==$e) ENTONCES
$p=$p2;
FSI;

/####/Interfaz:buscar_maximo/####/$pl=getValor("maximos","codigo");/####/Interfaz:ventana_calendario/####/lanzaInterfaz("portal.calendario.trata_prefijo","","");
$m=getVariableGlobal("modo_calendario");//estado, incidencias, planificiaciones..
SI ($v=="") ENTONCES $v="0";FSI;
$v=getVariableGlobal("vista_calendario");//por mes, por año...
SI ($m=="") ENTONCES $m="1";FSI;
$bc=getVariableGlobal("ver_cal");//calendario o lista de comentarios
SI ($bc=="") ENTONCES $bc="0";FSI;
$pl=getVariableGlobal("planificacion");//id del máximo
SI ($pl=="") ENTONCES $pl="0";FSI;
$mp=getVariableGlobal("modo_plan");//solicitada, anulada, aprobada
$p=getVariableGlobal("peticion_anual");//id de la petición
SI ($v=="3") ENTONCES SI ($p=="") ENTONCES $p="0";FSI;FSI;
print("<div class='row col-12'><table class='contenedor marges_taula'><tbody>");
print("<tr id><td>");
clase_html="form-cal";
formularioHTML("form_cal","0004_gen",0);
clase_html="";
SI ($es_gestor) ENTONCES lanzaInterfaz("portal.filtro_personas","","");FSI;

$op1s=" "; $op2s=" ";$op3s=" ";
SI ($v=="1") ENTONCES $op1s=" selected ";FSI;
SI ($v=="2") ENTONCES $op2s=" selected ";FSI;
SI ($v=="3") ENTONCES $op3s=" selected ";FSI;
$options="<option"+$op1s+"value='1'>"+str("mJorEfect",0)+"</option><option"+$op2s+"value='2'>"+str("mJustific",0)+"</option>";
creaFuente("maximos",22,"maximos","");
SI (medidaFuente("maximos")>0) ENTONCES
  $options=$options+"<option"+$op3s+"value='3'>"+str("mPlans",0)+"</option>";
FSI;
print("<div class='centre'>");
print("<div class='panels'>");
print("<div class='panel calendar background'>");
print("<div class='panel-content'>");
print("<table class='contenedor' style='width: 100%;'><tbody><tr id>");
ponComponente("sel","",20,a_entero($m),"");
print("<td class='numero'><label class='label-select txt-right'>"+str("mVer",0)+"</label>");
print("<select class='user-select' name='$ver' id='$ver' onchange='form_cal.submit();'>"+$options+"</select></td>");
print("<td class='numero'><label class='label-select'>"+str("mTipo",0)+"</label>");

$op1s=" "; $op2s=" ";
SI ($m=="0") ENTONCES $op1s=" selected ";FSI;
SI ($m=="1") ENTONCES $op2s=" selected ";FSI;
$options="<option"+$op1s+"value='0'>"+str("mPorMes",0)+"</option><option"+$op2s+"value='1'>"+str("mPorAño",0)+"</option>";
print("<select class='user-select' name='$modo' id='$modo' onchange='form_cal.submit();'>0;"+$options+"</select></td>");
print("</tr></tbody></table>");
print("</div></div></div></div>");

$ep="";
SI ($v=="3") ENTONCES 
  lanzaInterfaz("portal.calendario.tabla_maximos","","");
SINO
  SI ($v<>"0") ENTONCES 
    obtenerDatosCalculo(recorta(getVariableGlobal("fecha_calendario"),1,4)+"0101",recorta(getVariableGlobal("fecha_calendario"),1,4)+"1231"); 
  FSI;
FSI;
cierraFormularioHTML("");
SI (($v=="3")O($v=="2")) ENTONCES 
  SI (($v=="3") Y ($p=="0")) ENTONCES
  SINO
    lanzaInterfaz("portal.calendario.lista_incidencias","","");
  FSI;
SINO
  botonesAdjuntos("");
FSI;

SI ($v=="3") ENTONCES lanzaInterfaz("portal.calendario.botones_calendario","","");FSI;
SI (($v=="3") Y ($p=="0")) ENTONCES
//nada que pintar
SINO
 SI (($v<>"3")O($bc=="0")) ENTONCES
  formularioHTML("form_modo;class='form-modo' style='margin-left: 20px;'","0004_gen",0);
  SI ($m=="0") ENTONCES
   print("<div class='centre' style='padding-right: 10%'><div class='panels ie'><div class='panel calendario_mensual centered'><div class='panel-content'>");
  SINO
   print("<div class='centre'><div class='panels'><div class='panel ie calendar' style='background-color: transparent;'><div class='panel-content'>");
  FSI;
  ponComponente("","",22,a_entero($p),$m+","+$v);
  print("</div></div></div></div>");
  cierraFormularioHTML("");
 SINO
  lanzaInterfaz("portal.calendario.comentarios","","");
 FSI;
FSI;
print("</td></tr></tbody></table></div>");/####/Interfaz:comprobacion_solicitud/####/SI ((campoCalculo("plan_inicio")<>"")Y
(campoCalculo("estado_dia")=="1")) ENTONCES
SI ($errores_sol==0) ENTONCES
 tablaHTML(3,"tabla_datos,100");
print("");print(str("mFecha",0));print(str("mDescripcion",0));
FSI;
ponComponente("anomalia.png","",16,0,"");
print(a_fecha(campoCalculo("dia")));
print("Empleado presente");
$errores_sol=1;
FSI;/####/Interfaz:carga_peticiones2/####/$idpet=campoObjetoCalculo("peticion","id");
//print("<tr id><td>");
ponComponente(campoObjetoCalculo("peticion","icono"),"",16,0,"");
ponEnlace("ctxo"+a_texto($idpet)+"T"+campoObjetoCalculo("peticion","tipo")+"_0006_gen");
//print("</td><td>"+campoObjetoCalculo("peticion","str_ind")+"</td>");
print(campoObjetoCalculo("peticion","str_ind"));
clase_contenedor="numero";
$las_fechas=(campoObjetoCalculo("peticion","fechas"));
//print("<td class='numero'>"+$las_fechas+"</td>");
print($las_fechas);
print("");
clase_contenedor="";
//print("<td>"+campoObjetoCalculo("peticion","comentario")+"</td>");
//print("</tr>");
print(campoObjetoCalculo("peticion","comentario"));
/####/Interfaz:botones_calendario/####/formularioHTML("form_calb","0004_gen",0);
SI (($v=="3") Y ($p=="0")) ENTONCES
SINO
SI ($bc=="0") ENTONCES  ponComponente("$detalles",str("mDetalls",0),9,0,"");
SINO ponComponente("$calendario",str("mCalendari",0),9,0,"");
FSI;
FSI;
$perm=campoPersona("permisos_peticion,"+$p+",4");
SI (($hay_solicitada==0)Y
((buscaTexto($perm,"N")>0)O(buscaTexto($perm,"S")>0))) ENTONCES
print(" ");
ponComponente("$solicitar",str("mSolicitar",0),9,0,"");
FSI;
SI (buscaTexto($perm,"A")>0) ENTONCES
print(" ");
ponComponente("$aprobar",str("mAprobar",0),9,0,"");
FSI;
SI (buscaTexto($perm,"R")>0) ENTONCES
print(" ");
ponComponente("$rechazar",str("mRechazar",0),9,0,"f=R");
FSI;
SI (buscaTexto($perm,"N")>0) ENTONCES
print(" ");
ponComponente("$anular",str("mAnular",0),9,0,"f=R");
FSI;
cierraFormularioHTML("");
/####/Interfaz:dibuja_tabla_maximos/####/print(getValor("tabla_bolsas","nombre"));
clase_contenedor="numero";
print(getValor("tabla_bolsas","maximo"));
print(getValor("tabla_bolsas","pendientes"));
print(getValor("tabla_bolsas","realizadas"));
print(getValor("tabla_bolsas","disponibles"));
clase_contenedor="";/####/Interfaz:lista_incidencias/####/SI (($v<>"3")O($mp=="1")) ENTONCES 
 $perm=campoPersona("permisos_peticion,0,4");
 SI (buscaTexto($perm,"S")>0) ENTONCES
botonesAdjuntos("pet,shc_pet");
 SINO
 botonesAdjuntos(",");
 FSI;
SINO
 botonesAdjuntos(",");
FSI;
clase_html="form-modo";
formularioHTML("pet","0008_gen",0);
clase_html="";
//print("<table class='tabla_datos' width='100%'><thead><tr id>");
//print("<th></th>");
//print("<th>"+str("mPeticion",0)+"</th>");
//print("<th class='numero'>"+str("mDias",0)+"</th>");
//print("<th>"+str("mComentario",0)+"</th>");
//print("</thead><tbody>");
tablaHTML(5,"tabla_datos,100");print("");
print(str("mPeticion",0));
clase_contenedor="numero";
print(str("mDias",0));
clase_contenedor="";
print("");
print(str("mComentario",0));
fecha_inicio=recorta(fecha,1,4)+"0101";
fecha_fin=recorta(fecha,1,4)+"1231";
$pc="0";
SI ($v=="3") ENTONCES $pc=$p;FSI;
creaFuente("peticiones",21,fecha_inicio+","+fecha_fin+
",T=Pj,M="+$pl+",P="+$pc,"SO");
lanzaInterfaz("portal.calendario.carga_peticiones2","peticiones","");
cierraTablaHTML();
//print("</tbody></table>");
SI (buscaTexto($perm,"S")>0) ENTONCES
//ponComponente("shc_pet.html",str("mIncidenciaDS",0),9,1,"");
//lanzaInterfaz("portal.calendario.calculo_solicitadas_dias","","");
lanzaInterfaz("portal.calendario.nueva_planificacion","","");
FSI;
cierraFormularioHTML("");
/####/Interfaz:nueva_planificacion/####/print("<button id='nplanbtn' class='boton' style='width:auto;height:34px' type='button' onclick='showNewPlan()' >"+str("mIncidenciaDS",0)+"</button>");
print("<script>
function showNewPlan() {
  var x = document.getElementById('nplantab'); x.style.display = 'table';
  x = document.getElementById('nplanbtn'); x.style.display = 'none';
}
function hideNewPlan() {
  var x = document.getElementById('nplantab'); x.style.display = 'none';
  x = document.getElementById('nplanbtn'); x.style.display = 'block';
}</script>");
print("<div style='margin:8px;'>");
print("<table id='nplantab' style='display: none;' class='tabla_datos' width='100%'><thead><tr id>");
print("<th width='20%'>"+str("newJust",0)+"</th><th>"+str("mDesde",0)+"</th><th>"+str("mHasta",0)+"</th>");
print("<th width='35%'>"+str("mComentario",0)+"</th>");
print("<th width='10%'></th><th width='10%'></th>");
print("</tr></thead><tbody><tr id>");
$v=getVariableGlobal("vista_calendario");

SI ($v<>"3") ENTONCES 
 //solo justificaciones que pueda ver el empleado
 $mascosas = "cod_id in (select cti.incid from (select tabla_saldos,ch from contratos_ch where pers_codigo="+campoPersona("codigo")+
 "and pers_tipo="+campoPersona("tipo_persona")+" and "+hoy()+" between inicio and fin) c join tablas_saldos ts on ts.ch=c.ch and ts.tabla=c.tabla_saldos 
  join col_tablas_incid_portal cti on cti.tabla=ts.tabla)";
 creaFuente("incids",22,"incidencias","W="+$mascosas);
SINO 
 creaFuente("incids",22,"incidencias","P="+getVariableGlobal("planificacion"));
FSI;

print("<td>");
ponParametro("$f_incidencia", " onchange='showRow(this)' style='width:100%;'", 5,"FUENTE:incids");
print("</td><td>");
clase_html="date-edit";
ponParametro("$f_inicio", "", 1,"");
print("</td><td>");
ponParametro("$f_fin", "", 1,"");

print("</td><td><input class='input-comment' autocomplete='off' type='text' name='$f_comentario' value='' placeholder='"+str("mComentario.",0)+"'></td>");

print("<td><input type='submit' name='$nintervalo' value='"+str("mAplicar",0)+"' style='width:100%;height:34px;'></td>");

print("<td><button class='boton' type='button' style='width:100%;height:34px;'onclick='hideNewPlan()'>"+str("bCancelar",0)+"</button>");
print("</td></tr></tbody>");
print("<thead><tr><th>"+str("mJustificacio",0)+"</th><th>"+str("mAprobadas",0)+"</th><th>"+str("mPorAprobar",0)+"</th>");
print("<th>"+str("mDisponibles",0)+"</th><th></th><th></th></tr></thead><tbody>");
$ejercicio=recorta(getVariableGlobal("fecha_calendario"),1,4);
lanzaInterfaz("portal.utils.resumen_maximos_anuales","","");
print("</tbody></table></div>");

//javascript para tratar el cambio en el combobox
print("<script>
 function showRow(selectItem) {
  var value= selectItem.value;
  var columnToShow = 'tmfila'+value;
  var table = document.getElementById('nplantab');
  for (var i = 0;  i<table.rows.length; i++) {
   var row = table.rows[i];
   if (row.id!='' && row.id!=columnToShow) {
    row.style.display='none';
   } else {
    row.style.display='table-row';
   }
  }
 }
</script>");

/####/Interfaz:tabla_maximos/####/SI ($pl=="0") ENTONCES
lanzaInterfaz("portal.calendario.buscar_maximo","maximos","");
setVariableGlobal("planificacion",$pl);
FSI;
ponParametro("$plan!", str("mPlanificacio",0), 5,"FUENTE:maximos"); 
ponValorParametro("$plan",$pl);
creaFuente("planes",22,"planes",$pl);
$p=0;
$smodosplan="";
SI ($mp=="") ENTONCES $mp="2";FSI;
$hay_solicitada=0;
$hay_descartada=0;
$hay_aprobada=0;
lanzaInterfaz("busca_plan_anual","planes","");
ponParametro("$modo_plan!", "", 5,$smodosplan); 
SI ($mp=="2") ENTONCES
  obtenerDatosCalculo(recorta(getVariableGlobal("fecha_calendario"),1,4)+"0101",
recorta(getVariableGlobal("fecha_calendario"),1,4)+"1231"); 
SINO
  $errores_sol=0;
  compruebaPlanificaciones("comprobacion_solicitud",recorta(fecha,1,4)+"0101",
recorta(fecha,1,4)+"1231",propiedadUsuario("ch"),1,a_texto($p)); 
  SI ($errores_sol) ENTONCES cierraTablaHTML();FSI;
FSI;
ponValorParametro("$modo_plan",$mp);
setVariableGlobal("peticion_anual",$p);
creaFuente("tabla_bolsas",22,"tabla_anual",recorta(fecha,1,4)+","+$pl);
tablaHTML(5,"tabla_datos,100");
clase_contenedor="numero";
print(str("mBolsa",0));print(str("mMaxim",0));  print(str("mPendiente",0));
print(str("mRealizado",0));print(str("mDisponible",0));
clase_contenedor="";
lanzaInterfaz("portal.calendario.dibuja_tabla_maximos","tabla_bolsas","");
cierraTablaHTML();
/####/Interfaz:trata_prefijo/####/$co=getVarHTTP("contexto");
SI (recorta($co,1,1)=="M") ENTONCES
$idpet=a_entero(recorta($co,2,100));
SI (buscaPeticion(a_entero($idpet),4)) ENTONCES
setVariableGlobal("vista_calendario","3");
setVariableGlobal("planificacion",campoObjetoCalculo("peticion","maximo"));
setVariableGlobal("peticion_anual",$idpet);
setVariableEntorno("fecha",campoObjetoCalculo("peticion","fecha")+"0101");
setVariableGlobal("modo_plan",a_texto(campoObjetoCalculo("peticion","estado")));
FSI;
FSI;/####/Interfaz:modo_cal/####/SI (indefinido($pers_filtro)==0) ENTONCES
  setPropiedadFiltro("persona",$pers_filtro);
FSI;
SI (indefinido($modo)==0) ENTONCES
setVariableGlobal("modo_calendario",$modo);FSI;
SI (indefinido($ver)==0) ENTONCES
setVariableGlobal("vista_calendario",$ver);FSI;
SI (indefinido($detalles)==0) ENTONCES
setVariableGlobal("ver_cal","1");FSI;
SI (indefinido($calendario)==0) ENTONCES
setVariableGlobal("ver_cal","0");FSI;
SI (indefinido($plan)==0) ENTONCES
setVariableGlobal("planificacion",$plan);FSI;
SI (indefinido($modo_plan)==0) ENTONCES
setVariableGlobal("modo_plan",$modo_plan);FSI;
$idpet=getVariableGlobal("peticion_anual");
$tpet="4";
SI (indefinido($solicitar)==0) ENTONCES
 $f=recorta(fecha,1,4);
 crearPeticion("A","",getVariableGlobal("planificacion"),$f,buscaPeticion(0,4),a_entero($f));
 setVariableGlobal("modo_plan","1");
 $perm=campoPersona("permisos_peticion,"+$idpet+","+$tpet);
 $link="ctxo"+$idpet+"T"+$tpet+"_0006_gen.html";
 $pers_pet=campoObjetoCalculo("peticion", "empleado");
 lanzaInterfaz("portal.notificaciones","","");
 setVariableGlobal("modo_plan","1");
SINO
SI (indefinido($nintervalo)==0) ENTONCES
  $n=0;
  SI ($f_incidencia<>"") ENTONCES $n=a_entero($f_incidencia);FSI;
  lanzaInterfaz("portal.utils.crea_justificacion_dias","","");
  //$idpet=crearPeticion("P",$f_comentario,$n,a_fecha($f_inicio),a_fecha($f_fin),0);
  $tpet="2";
SINO
  lanzaInterfaz("portal.peticion.modifica_peticion","","");
  SI (indefinido($rechazar)+indefinido($anular)==0) ENTONCES
   setVariableGlobal("modo_plan","4");
  FSI;
  SI (indefinido($aprobar)==0) ENTONCES setVariableGlobal("modo_plan","2"); FSI;
FSI;
FSI;
lanzaInterfaz("portal.calendario.ventana_calendario","","");/####/Interfaz:respuesta/####/SI (indefinido($nintervalo)==0) ENTONCES
$f=recorta(fecha,1,4);
lanzaInterfaz("portal.utils.crea_justificacion_dias","","");
//crearPeticion("P",$f_comentario,$f_incidencia,a_fecha($f_inicio),a_fecha($f_fin),a_entero($f));
FSI;/####/Lanzador:calendario/####/lanzaInterfaz("portal.calendario.ventana_calendario","","");/####/Lanzador:form_incid/####/cierraTablaHTML();
print("<table class='tabla_datos' width='100%'><thead><tr id>");
print("<th>"+str("mNuevaPeticion",0)+"</th><th class='numero'>"+str("mDesde",0)+"</th><th class='numero'>"+str("mHasta",0)+"</th><th width='10%'></th><th width='10%'></th>");
print("</tr></thead><tbody><tr id>");
$v=getVariableGlobal("vista_calendario");
SI ($v<>"3") ENTONCES creaFuente("incids",22,"incidencias","");
SINO 
creaFuente("incids",22,"incidencias","P="+getVariableGlobal("planificacion"));
FSI;
//print("");
print("<td>");
ponParametro("$f_incidencia", " style='width:100%;'", 5,"FUENTE:incids");
print("</td><td class='numero'>");
//tablaHTML(0,"");
ponParametro("$f_inicio", "", 1,"");
print("</td><td class='numero'>");
ponParametro("$f_fin", "", 1,"");
//cierraTablaHTML();
//ponParametro("$f_comentario", "", 2,"");
print("</td><td>");
clase_html="boton";
ponComponente("$nintervalo",str("mAplicar",0),9,0,"");
print("</td><td>");
ponComponente("0004_gen.html",str("bCancelar",0),9,1,"");
print("</td></tr></tbody></table>");
//cierraTablaHTML();
/####/Lanzador:lista_incids/####/lanzaInterfaz("portal.calendario.lista_incidencias","","");/####/Paquete:portal.anomalias/####/Interfaz:calculo_portal2/####/SI (anom_propiedad("tipo")==0)  ENTONCES
 print("<tr id><td>");
 ponComponente(anom_propiedad("icono"),"",16,0,"");
 print("</td><td class='numero'>");
 ponEnlace("ctxo"+fecha+"_0005_gen");
 print(a_fecha(fecha));
 print("</td><td>");
 print(anom_propiedad("nombre"));
 print("</td></tr>");
FSI;/####/Interfaz:cambio_persona/####/SI (indefinido($pers_filtro)==0) ENTONCES
  SI ($pers_filtro<>"0") ENTONCES
  setPropiedadFiltro("persona",$pers_filtro);
  FSI;
FSI;
lanzaInterfaz("portal.anomalias.lista","","");/####/Interfaz:revision_anomalias/####/$fd=formatoFecha("DDMMAAAA","/");
$fdh=formatoFecha("DDMMAAAAhhmm","/| |:");
$ta=anom_propiedad("tipo");
SI ((($ta==0)Y($chk_error))O
(($ta==1)Y($chk_avis))O
(($ta==2)Y($chk_info))) ENTONCES
 print("<tr id><td class='img-col'>");
 ponComponente(anom_propiedad("icono"),"",16,0,"");
 print("</td><td class='numero'>");
 ponEnlace("ctxo"+fecha+campoPersona("tipo_persona")+campoPersona("codigo")+"_0005_gen");
 print(formatea(a_fecha(fecha),$fd));
 print("</td><td>"+anom_propiedad("nombre"));
 SI ($pers_filtro=="0") ENTONCES 
  print("</td><td>"+campoPersona("nombre_completo"));
 FSI;
 print("</td></tr>");
FSI;
/####/Interfaz:lista/####/$operacion_global=1;
print("<div class='row col-12'><table class='contenedor marges_taula'><tbody>");
print("<tr id><td>");
clase_html="form-top";
formularioHTML("form","0018_gen",0);
clase_html="";
SI ($es_gestor) ENTONCES
lanzaInterfaz("portal.filtro_personas","","");
FSI;
$ayer=a_fecha(fecha)-1;

SI (indefinido($f_inicio)) ENTONCES
 $f_inicio=a_texto($ayer-30);$f_fin=fecha;
FSI;
print("<table width='100%'><tbody><tr><td>");
print("<label class='label-select'>"+str("mDesde",0)+"</label>");
clase_html="date-edit";
ponParametro("$f_inicio", "", 1,"");
print("<label class='label-select'>"+str("mHasta",0)+"</label>");
ponParametro("$f_fin", "", 1,"");
clase_html="";
ponValorParametro("$f_inicio",$f_inicio);
ponValorParametro("$f_fin",$f_fin);


SI (indefinido($chk_error)) ENTONCES $chk_error=0;
SINO $chk_error=a_entero($chk_error); FSI;
SI (indefinido($chk_avis)) ENTONCES $chk_avis=0;
SINO $chk_avis=a_entero($chk_avis); FSI;
SI (indefinido($chk_info)) ENTONCES $chk_info=0;
SINO $chk_info=a_entero($chk_info); FSI;

//informa($f_inicio+","+$f_fin+","+$chk_error+","+$chk_avis+","+$chk_info);

SI (($chk_error+$chk_avis+$chk_info)==0) ENTONCES
$chk_error=1;
FSI;

print("</td><td>");
$errchecked="";
SI ($chk_error==1) ENTONCES $errchecked="checked"; FSI;
$avichecked="";
SI ($chk_avis==1) ENTONCES $avichecked="checked"; FSI;
$infchecked="";
SI ($chk_info==1) ENTONCES $infchecked="checked"; FSI;

print("<label class='control control-checkbox'>"+str("mError",0));
print("<input type='checkbox' name='$chk_error' "+$errchecked+" value='1'>");
print("<div class='control_indicator'></div></label>");
print("</td><td>");

print("<label class='control control-checkbox'>"+str("mAviso",0));
print("<input type='checkbox' name='$chk_avis' "+$avichecked+" value='1'>");
print("<div class='control_indicator'></div></label>");
print("</td><td>");

print("<label class='control control-checkbox'>"+str("mInformacion",0));
print("<input type='checkbox' name='$chk_info' "+$infchecked+" value='1'>");
print("<div class='control_indicator'></div></label>");
print("</td><td>");

//ponParametro("$chk_error", str("mError",0), 4,""); print("</td><td>");
//ponParametro("$chk_avis", str("mAviso",0), 4,""); print("</td><td>");
//ponParametro("$chk_info", str("mInformacion",0), 4,""); print("</td><td>");
//ponValorParametro("$chk_error",a_texto($chk_error));
//ponValorParametro("$chk_avis",a_texto($chk_avis));
//ponValorParametro("$chk_info",a_texto($chk_info));
clase_html="boton";
ponComponente("$aplicar",str("mAplicar",0),9,0,",");
clase_html="";
print("</td></tr></tbody></table>");
print("<table class='tabla_datos' width='100%'><thead><tr id>");
print("<th></th><th class='numero'>"+str("mDia",0)+"</th><th>"+str("mAnomalia",0)+"</th>");
SI ($pers_filtro=="0") ENTONCES print("<th>"+str("mEmpleado",0)+"</th>"); FSI;
print("</tr></thead><tbody>");
SI ($pers_filtro=="0") ENTONCES
lanzaInterfaz("portal.anomalias.vista_global","filtro_pers","");
SINO
revisaCalculo("portal.anomalias.calculo_anomalias",a_fecha($f_inicio),a_fecha($f_fin),"");
FSI;
//cierraTablaHTML();
print("</tbody></table>");
cierraFormularioHTML("");
print("</td></tr></tbody></table>");/####/Interfaz:calculo_anomalias/####/revisaAnomalias("portal.anomalias.revision_anomalias");
/####/Interfaz:vista_global/####/revisaCalculo("portal.anomalias.calculo_anomalias",$ayer-15,$ayer,"");/####/Paquete:listados/####/Paquete:listados.presentes/####/Interfaz:listado/####/creaDestino("*",3,"dia VARCHAR2(8), dep VARCHAR2(200), nombre VARCHAR2(100), estado NUMBER(10), matricula NUMBER(10), jornada VARCHAR2(200), marcaje VARCHAR2(100)");
$d=destinoActual();
$fd=formatoFecha("DDMMAAAA","/");
$fdh=formatoFecha("DDMMAAAAhhmm","/| |:");
$fhora=formatoHora(0,0,2,0,0,":");
$h_actual=$p5;
creaFuente("tmp",7,$p1,$p2);
informa("Fecha ini: "+$p1+" Fecha fin: "+$p2);
lanzaInterfaz("listados.presentes.proc_ausentes","seleccion_personas","");
creaFuente("TEMPORAL",1,$d,"ORDER BY nombre");
agrupa("TEMPORAL","dia,estado");
creaDestino("presencia",4,"*.pdf");
$a9=aspectoTexto("Helvetica",7,0,0,0);
$a1=aspectoTexto("Helvetica",10,0,0,0);
$acab=aspectoTexto("Helvetica",10,2,0,0);
$a2=aspectoTexto("Helvetica",14,2,0,0);
usarAspecto($a1);
ponNumeroPagina(str("mPagina",0)+" ",0);
usarAspecto($a2);
print(str("mListPAusentes",0));
usarAspecto($a1);
print(CR+LF);
print(str("mFechaImpresion",0)+" "+formatea(ahora,$fdh));
$total=0;
lanzaInterfaz("listados.presentes.impresion_ausentes","TEMPORAL","");
cierraDestino("presencia");
abreEnNavegador("presencia");
/####/Interfaz:proc_ausentes/####/$cambio_dia=0;
$marcaje_posterior="";
$jornada="";
$estado_posterior=0;
$no_obligado_posterior=0;
$n=campoPersona("apellidos")+", "+campoPersona("nombre");
$c=campoPersona("matricula");
buscaDepartamentoPersona();
$de=rutaDepartamento(3,5);
revisaCalculo("listados.presentes.calculo_ausencia",a_fecha($p1)-1,a_fecha($p2),"");
/####/Interfaz:dia_justificado/####/$h=a_entero($h_actual);
$dia=campoCalculo("dia");
SI (($h2>a_entero(23:59))*($h2>$h)) 
ENTONCES
  $h=$h+a_entero(24:00); 
  $dia=a_texto(a_fecha($dia)+1);
FSI;
SI (($estado==2) Y (($h2>=$h)O(a_texto($p2)<$dia)) Y (a_texto($p1)<=$dia))
ENTONCES
  ponCampoRegistro("jornada", $jornada);
  ponCampoRegistro("marcaje", campoObjetoCalculo("incidencia","nombre")); 
  SI (a_texto($p2)<$dia)
  ENTONCES
    ponCampoRegistro("dia", a_texto($p2));
  SINO 
    ponCampoRegistro("dia", $dia);
  FSI;
  ponCampoRegistro("estado","0"); 
  escribeRegistro();
FSI;/####/Interfaz:volcado_fichero/####/print(campo("matricula")+TAB);
print(campo("nombre")+TAB);
printf(campo("dia"),$fd);print(TAB);
print(campo("dep")+TAB);
print(campo("jornada")+TAB);
$m=campo("marcaje");
SI ($m<>"")
ENTONCES
  print(a_hora(campo("marcaje")));
SINO
  print(""); 
FSI;
print(TAB+campo("estado"));
print(CR+LF);/####/Interfaz:comprueba_intervalo/####/$h=$h_actual;
SI ((int_hora(1)>23:59)*(int_hora(0)>$h)) 
ENTONCES
  $h=$h+24:00; 
FSI;
SI ((int_hora(0)<=$h)*(int_hora(1)>=$h)) 
ENTONCES
  SI (int_flag(0)==0) 
  ENTONCES
    SI ($cambio_dia==0) 
    ENTONCES  
      $no_obligado=1; 
    SINO 
      $no_obligado_posterior=1;
    FSI;
  FSI;
FSI;/####/Interfaz:calculo_ausencia/####/$marcaje="";
$marcaje_provisional="";
$estado=a_entero(campoCalculo("estado_dia"));
$no_obligado=1;
ponCampoRegistro("dep",$de);
ponCampoRegistro("matricula",$c);
ponCampoRegistro("nombre",$n);
SI ($cambio_dia==1) 
ENTONCES
  $marcaje=$marcaje_posterior;
  $estado=$estado_posterior;
  $no_obligado=$no_obligado_posterior;
  $cambio_dia=0;
  SI ((($estado==1)+(($estado==0)*($no_obligado==0))) * (a_fecha(campoCalculo("dia"))>=$p1)) 
  ENTONCES
    ponCampoRegistro("jornada", $jornada);
    ponCampoRegistro("marcaje", $marcaje);
    ponCampoRegistro("dia", campoCalculo("dia"));
    ponCampoRegistro("estado",a_texto($estado));
    ponCampoRegistro("dep",$de);
    ponCampoRegistro("matricula",$c);
    ponCampoRegistro("nombre",$n);
  FSI;
FSI;
SI (a_fecha(campoCalculo("dia"))<=$p2) 
ENTONCES
  $jornada=campoCalculo("jornada_efectiva");
  $marcaje_posterior="";
  $estado_posterior=0;
  $no_obligado_posterior=1;
  $h1=campoObjetoCalculo("jornada_efectiva","inicio_bloques");
  $h2=campoObjetoCalculo("jornada_efectiva","fin_bloques");
  SI ($estado<2) 
  ENTONCES
    SI ($cambio_dia==0) 
    ENTONCES 
      $estado=0;
    FSI;
    $cambio_dia=0;
    revisaMovimientos("listados.presentes.comprueba_marcaje");
    SI($estado==0) 
    ENTONCES
      SI (($h1<>0)O($h2<>0)) 
      ENTONCES
        lanzaInterfaz("listados.presentes.comprueba_jornada","","");
      FSI;
    FSI;
  SINO
    $cambio_dia=0;
  FSI;
  SI ((($estado==1)+(($estado==0)*($no_obligado==0))) * (a_fecha(campoCalculo("dia"))>=$p1)) 
  ENTONCES
    ponCampoRegistro("jornada", $jornada);
    ponCampoRegistro("marcaje", $marcaje);
    ponCampoRegistro("dia", campoCalculo("dia"));
    ponCampoRegistro("estado",a_texto($estado));
    escribeRegistro();
  SINO
    lanzaInterfaz("listados.presentes.dia_justificado","","");
  FSI;
FSI;
/####/Interfaz:plantilla_email/####/$correo=campo();
SI (enviaCorreo("presencia",$correo,"",$asunto_email,"Adjuntamos listado del personal ausente y presente a fecha de hoy en su jornada correspondiente."+CR+LF+"Area RRHH","imagen.jpg")) 
ENTONCES
  informa("Datos:"+$asunto_email+","+$correo);
SINO
  error("Error email:"+getLastError());
FSI;/####/Interfaz:listado_manager_programado/####/creaDestino("*",3,"dia VARCHAR2(8), dep VARCHAR2(200), nombre VARCHAR2(100), estado NUMBER(10), matricula NUMBER(10), jornada VARCHAR2(200), marcaje VARCHAR2(100)");
$d=destinoActual();
$fd=formatoFecha("DDMMAAAA","/");
$fdh=formatoFecha("DDMMAAAAhhmm","/| |:");
$fhora=formatoHora(0,0,2,0,0,":");
$p1=a_fecha(fecha);
$p2=$p1;
$p3=0;
$p5=a_hora(recorta(ahora,9,12));//formatea(ahora,$fdh);
$h_actual=$p5;
creaFuente("tmp",7,$p1,$p2);
creaFuente("plantilla",2,$plantilla_personas,"");
lanzaInterfaz("proc_ausentes","plantilla","");
creaFuente("TEMPORAL",1,$d,"ORDER BY nombre");
agrupa("TEMPORAL","dia,estado");
$total=0;
$a9=aspectoTexto("Helvetica",7,0,0,0);
ponPiePagina("","Página "," de",0,0,$a9);
creaDestino("presencia",4,"*.pdf");
$a1=aspectoTexto("Helvetica",8,0,0,0);
$acab=aspectoTexto("Helvetica",10,2,0,0);
$a2=aspectoTexto("Helvetica",14,2,0,0);
usarAspecto($a2);
print("Listado de Ausentes y Presentes");
usarAspecto($a1);
//print("   Lanzado en "+formatea(ahora,$fdh)+CR+LF);
$total=0;
lanzaInterfaz("impresion_ausentes","TEMPORAL","");
cierraDestino("presencia");
//abreEnNavegador("presencia");
creaFuente("miplantilla",22,"plantilla_emails",$plantilla_email);
lanzaInterfaz("plantilla_email","miplantilla","");
/####/Interfaz:comprueba_marcaje/####/$h=a_hora(mov_minuto(0));
SI (($h>23:59)*(a_fecha(campoCalculo("dia"))<$p2)) 
ENTONCES 
  $h=$h-24:00;
  $cambio_dia=1;
FSI;
SI ($h<=$h_actual) 
ENTONCES
  SI ($cambio_dia==1)
  ENTONCES
    $marcaje_posterior=a_texto($h);
  SINO
    $marcaje=a_texto($h);
  FSI;
  SI (mov_dato("I")<>"78") 
  ENTONCES
    SI ($estado==2) 
    ENTONCES
      $estado=1;
    SINO
      SI ($cambio_dia==0) 
      ENTONCES
        SI ($estado==1)
        ENTONCES
          $estado=0;
        SINO $estado=1;
        FSI;
      FSI;
    FSI;
  FSI;
  $estado_posterior=$estado;
SINO
  SI ($cambio_dia==1)
  ENTONCES 
    SI ($estado_posterior==2)
    ENTONCES
      $estado_posterior=1;
    SINO
      SI ($estado_posterior==1)
      ENTONCES
        $estado_posterior=0;
      SINO
        $estado_posterior=1;
      FSI;
    FSI;
  SINO
    $marcaje_posterior=a_texto($h); 
  FSI;
FSI;
/####/Interfaz:impresion_ausentes/####/SI (inicioAgrupacion(1)) 
ENTONCES
  usarAspecto($a1);
  print(CR+LF+str("mEstadoA",0));print(" ");
  printf(campo("dia"),$fd);print(" "+str("malas",0)+" "+recorta($p5,1,2)+":"+recorta($p5,3,4)+CR+LF);
FSI;
SI (inicioAgrupacion(2))
ENTONCES
  usarAspecto($acab);
  COMPRUEBA(a_entero(campo("estado")))
    CASO (1) ENTONCES print(CR+LF+str("mLPresentes",0));
    FIN
    CASO (0) ENTONCES print(CR+LF+str("mAusentes",0));
    FIN
  FIN;
  tablaPDF("8,20,20,20,20");
  print(str("mCodigo",0));
  print(str("mNombre",0));
  print(str("mDepartamento",0));
  print(str("Jornada",0));
  print(str("mUltmMarc",0));
  $total=0;
FSI;
usarAspecto($a1);
print(campo("matricula"));
print(campo("nombre"));
print(campo("dep"));
print(campo("jornada"));
$m=campo("marcaje");
SI ($m<>"") 
ENTONCES
  print(a_hora(campo("marcaje")));
SINO
  print(""); 
FSI;
$total=$total+1;
SI (finalAgrupacion(2)) 
ENTONCES
  usarAspecto($acab);
  print("Total:");print($total);print("");print("");
  cierraTablaPDF(); 
FSI;/####/Interfaz:comprueba_jornada/####/$h=$h_actual;
SI (($h2>a_entero(23:59))*($h1>a_entero($h))) 
ENTONCES 
  $h=$h+24:00;
FSI;
SI (($h1<=a_entero($h))*($h2>=a_entero($h)))
ENTONCES
  SI ($cambio_dia==0)
  ENTONCES
    $no_obligado=0; 
  SINO
    $no_obligado_posterior=0;
  FSI;
FSI;/####/Interfaz:listado_manager/####/creaDestino("*",3,"dia VARCHAR2(8), dep VARCHAR2(200), nombre VARCHAR2(100), estado NUMBER(10), matricula NUMBER(10), jornada VARCHAR2(200), marcaje VARCHAR2(100)");
$d=destinoActual();
$fd=formatoFecha("DDMMAAAA","/");
$fdh=formatoFecha("DDMMAAAAhhmm","/| |:");
$fhora=formatoHora(0,0,2,0,0,":");
$h_actual=$p5;
$p1=a_fecha(fecha);
$p2=$p1;
creaFuente("tmp",7,$p1,$p2);
lanzaInterfaz("proc_ausentes","seleccion_personas","");
creaFuente("TEMPORAL",1,$d,"ORDER BY nombre");
agrupa("TEMPORAL","dia,estado");
$total=0;
$a9=aspectoTexto("Helvetica",7,0,0,0);
ponPiePagina("","Página "," de",0,0,$a9);
creaDestino("presencia",4,"*.pdf");
$a1=aspectoTexto("Helvetica",10,0,0,0);
$acab=aspectoTexto("Helvetica",10,2,0,0);
$a2=aspectoTexto("Helvetica",14,2,0,0);
usarAspecto($a2);
print("Listado de Ausentes y Presentes");
usarAspecto($a1);
$f1=recorta(ahora,1,2)+":"+recorta(ahora,3,4);
$total=0;
lanzaInterfaz("impresion_ausentes","TEMPORAL","");
//lanzaInterfaz("impresion_ausentes","seleccion_personas","");
cierraDestino("presencia");
abreEnNavegador("presencia");/####/Lanzador:ausentes_y_presentes/####/alAceptar("listado_presentes");
//alAceptar("programado_MOD_7h");

ponParametro("$p1","Fecha :",1,"");
//ponParametro("$p2","Fecha de Fin:",1,"");
 ponParametro("$p5","A las ",8,"");
 saltarFilaParametros();
 ponParametro("$p3","",6,"0;Listado|1;Exportación");
 saltarFilaParametros();
ponParametro("$p4","Ruta del Fichero",3,"");
 ponValorParametro("$p1",fecha);
// ponValorParametro("$p2",fecha);
 ponValorParametro("$p3","1");
 ponValorParametro("$p5",recorta(ahora,9,12));
 persistencia("$p4");
$p6=0;
/####/Paquete:listados.contadores/####/Interfaz:export_absentismo/####/usarAspecto($acab);
print(campo("codigo"));
print(campo("apellidos"));
print(campo("nombre"));
usarAspecto($anum);
SI ($con01<>"") 
ENTONCES
  SI ($tip01=="H")
  ENTONCES printf(a_entero(campo("c1"))/100,$fh);
  SINO printf(a_entero(campo("c1"))/100,$fd);
  FSI;
SINO print("");
FSI;
SI ($con02<>"") 
ENTONCES
  SI ($tip02=="H")
  ENTONCES printf(a_entero(campo("c2"))/100,$fh);
  SINO printf(a_entero(campo("c2"))/100,$fd);
  FSI;
SINO print("");
FSI;
SI ($con03<>"") 
ENTONCES
  SI ($tip03=="H")
  ENTONCES printf(a_entero(campo("c3"))/100,$fh);
  SINO printf(a_entero(campo("c3"))/100,$fd);
  FSI;
SINO print("");
FSI;
SI ($con04<>"") 
ENTONCES
  SI ($tip04=="H")
  ENTONCES printf(a_entero(campo("c4"))/100,$fh);
  SINO printf(a_entero(campo("c4"))/100,$fd);
  FSI;
SINO print("");
FSI;
SI ($con05<>"") 
ENTONCES
  SI ($tip05=="H")
  ENTONCES printf(a_entero(campo("c5"))/100,$fh);
  SINO printf(a_entero(campo("c5"))/100,$fd);
  FSI;
SINO print("");
FSI;
SI ($con06<>"") 
ENTONCES
  SI ($tip06=="H")
  ENTONCES printf(a_entero(campo("c6"))/100,$fh);
  SINO printf(a_entero(campo("c6"))/100,$fd);
  FSI;
SINO print("");
FSI;
SI ($con07<>"") 
ENTONCES
  SI ($tip07=="H")
  ENTONCES printf(a_entero(campo("c7"))/100,$fh);
  SINO printf(a_entero(campo("c7"))/100,$fd);
  FSI;
SINO
  print("");
FSI;
SI ($con08<>"") 
ENTONCES
  SI ($tip08=="H")
  ENTONCES printf(a_entero(campo("c8"))/100,$fh);
  SINO printf(a_entero(campo("c8"))/100,$fd);
  FSI;
SINO print("");
FSI;
SI ($con09<>"") 
ENTONCES
  SI ($tip09=="H")
  ENTONCES printf(a_entero(campo("c9"))/100,$fh);
  SINO printf(a_entero(campo("c9"))/100,$fd);
  FSI;
SINO print("");
FSI;
SI ($con10<>"") 
ENTONCES
  SI ($tip10=="H")
  ENTONCES printf(a_entero(campo("c10"))/100,$fh);
  SINO printf(a_entero(campo("c10"))/100,$fd);
  FSI;
SINO print("");
FSI;
SI ($con11<>"") 
ENTONCES
  SI ($tip11=="H")
  ENTONCES printf(a_entero(campo("c11"))/100,$fh);
  SINO printf(a_entero(campo("c11"))/100,$fd);
  FSI;
SINO print("");
FSI;
SI ($con12<>"") 
ENTONCES
  SI ($tip12=="H")
  ENTONCES printf(a_entero(campo("c12"))/100,$fh);
  SINO printf(a_entero(campo("c12"))/100,$fd);
  FSI;
SINO print("");
FSI;
/####/Interfaz:listado/####///lanzamos la inicialización de contadores
lanzaInterfaz("listados.contadores.inicializa_contadores","","");
creaDestino("*",3,"nombre VARCHAR2(20),apellidos VARCHAR2(80), codigo NUMBER(10), c1 VARCHAR2(10), c2 VARCHAR2(10), c3 VARCHAR2(10), c4 VARCHAR2(10), c5 VARCHAR2(10), c6 VARCHAR2(10), c7 VARCHAR2(10), c8 VARCHAR2(10), c9 VARCHAR2(10), c10 VARCHAR2(10), c11 VARCHAR2(10), c12 VARCHAR2(10), c13 VARCHAR2(10)");
$d=destinoActual();
$fd=formatoFecha("DDMMAAAA","/");
$fdh=formatoFecha("DDMMAAAAhhmm","/| |:");
$fhora=formatoHora(0,0,2,0,0,":");
$h_actual=$p5;
creaFuente("tmp",7,$p1,$p2);

SI ($pers_filtro=="0") ENTONCES 
 lanzaInterfaz("listados.contadores.proc_previo_absentismo","seleccion_personas","");
SINO
 lanzaInterfaz("listados.contadores.proc_previo_absentismo","seleccion_personas","actual");
FSI;

//lanzaInterfaz("listados.contadores.proc_previo_absentismo","seleccion_personas","");
creaFuente("TEMPORAL",1,$d,"ORDER BY apellidos,nombre");
$total=0;
$a9=aspectoTexto("Helvetica",7,0,0,0);
creaDestino("contadores",4,"*.pdf");
$a1=aspectoTexto("Helvetica",10,0,0,0);
$a11=aspectoTexto("Helvetica",10,2,0,0);
$acabnum=aspectoTexto("Helvetica",10,2,2,0);
$acab=aspectoTexto("Helvetica",9,0,0,0);
$anum=aspectoTexto("Helvetica",8,0,2,0);
$a2=aspectoTexto("Helvetica",14,2,0,0);
$fh=formatoHora(0,0,2,0,0,":");
$fd=formatoNumero(5,3,2,1,0,".");
$ff=formatoFecha("DDMMAAAA","/");
usarAspecto($a1);
ponNumeroPagina(str("mPagina",0)+" ",0);
usarAspecto($a2);
print(str("mContadores",0));
usarAspecto($a1);
print(CR+LF+str("mPeriodoSol:",0)+" "+formatea($p1,$ff)+" - "+formatea($p2,$ff)+CR+LF+CR+LF);
$total=0;
tablaPDF("6,15,10,6,6,6,6,6,6,6,6,6,6,6,6");
usarAspecto($a11);
print(str("mCodigo",0));
print(str("mApellidos",0));
print(str("mNombre",0));
usarAspecto($acabnum);
SI ($cap01<>"") ENTONCES  print($cab01); FSI;
SI ($cap02<>"") ENTONCES  print($cab02); FSI;
SI ($cap03<>"") ENTONCES  print($cab03); FSI;
SI ($cap04<>"") ENTONCES  print($cab04); FSI;
SI ($cap05<>"") ENTONCES  print($cab05); FSI;
SI ($cap06<>"") ENTONCES  print($cab06); FSI;
SI ($cap07<>"") ENTONCES  print($cab07); FSI;
SI ($cap08<>"") ENTONCES  print($cab08); FSI;
SI ($cap09<>"") ENTONCES  print($cab09); FSI;
SI ($cap10<>"") ENTONCES  print($cab10); FSI;
SI ($cap11<>"") ENTONCES  print($cab11); FSI;
SI ($cap12<>"") ENTONCES  print($cab12); FSI;
lanzaInterfaz("listados.contadores.export_absentismo","TEMPORAL","");
cierraTablaPDF(); 
cierraDestino("contadores");
abreEnNavegador("contadores");
/####/Interfaz:inicializa_contadores/####/// Cabeceras y contadores;
// Tipo de contador: H Horas D Decimal;
$sql="SELECT C.NOM_C FROM CONTADORES_LISTADOS_PORTAL CLP LEFT JOIN CONTADORES C ON C.CONTADOR=CLP.CONTADOR AND 
C.CONVENIO=" + propiedadUsuario("convenio") + " WHERE CLP.TABLA="+propiedadUsuario("tabla_saldos")+" AND CLP.NUM=";
$sqlcab="SELECT CABECERA FROM CONTADORES_LISTADOS_PORTAL WHERE TABLA="+propiedadUsuario("tabla_saldos")+" AND NUM=";
$sqltipo="SELECT TIPO_DATO FROM CONTADORES_LISTADOS_PORTAL WHERE TABLA="+propiedadUsuario("tabla_saldos")+" AND NUM=";

$cab01=ejecutaSql($sqlcab+"1");
$con01=ejecutaSql($sql+"1");
$tip01=ejecutaSql($sqltipo+"1");
$cab02=ejecutaSql($sqlcab+"2");
$con02=ejecutaSql($sql+"2");
$tip02=ejecutaSql($sqltipo+"2");
$cab03=ejecutaSql($sqlcab+"3");
$con03=ejecutaSql($sql+"3");
$tip03=ejecutaSql($sqltipo+"3");
$cab04=ejecutaSql($sqlcab+"4");
$con04=ejecutaSql($sql+"4");
$tip04=ejecutaSql($sqltipo+"4");
$cab05=ejecutaSql($sqlcab+"5");
$con05=ejecutaSql($sql+"5");
$tip05=ejecutaSql($sqltipo+"5");
$cab06=ejecutaSql($sqlcab+"6");
$con06=ejecutaSql($sql+"6");
$tip06=ejecutaSql($sqltipo+"6");
$cab07=ejecutaSql($sqlcab+"7");
$con07=ejecutaSql($sql+"7");
$tip07=ejecutaSql($sqltipo+"7");
$cab08=ejecutaSql($sqlcab+"8");
$con08=ejecutaSql($sql+"8");
$tip08=ejecutaSql($sqltipo+"8");
$cab09=ejecutaSql($sqlcab+"9");
$con09=ejecutaSql($sql+"9");
$tip09=ejecutaSql($sqltipo+"9");
$cab10=ejecutaSql($sqlcab+"10");
$con10=ejecutaSql($sql+"10");
$tip10=ejecutaSql($sqltipo+"10");
$cab11=ejecutaSql($sqlcab+"11");
$con11=ejecutaSql($sql+"11");
$tip11=ejecutaSql($sqltipo+"11");
$cab12=ejecutaSql($sqlcab+"12");
$con12=ejecutaSql($sql+"12");
$tip12=ejecutaSql($sqltipo+"12");/####/Interfaz:proc_previo_absentismo/####/SI ($tip01=="H") ENTONCES $c1=00:00;SINO $c1=0.00;FSI;
SI ($tip02=="H") ENTONCES $c2=00:00;SINO $c2=0.00;FSI;
SI ($tip03=="H") ENTONCES $c3=00:00;SINO $c3=0.00;FSI;
SI ($tip04=="H") ENTONCES $c4=00:00;SINO $c4=0.00;FSI;
SI ($tip05=="H") ENTONCES $c5=00:00;SINO $c5=0.00;FSI;
SI ($tip06=="H") ENTONCES $c6=00:00;SINO $c6=0.00;FSI;
SI ($tip07=="H") ENTONCES $c7=00:00;SINO $c7=0.00;FSI;
SI ($tip08=="H") ENTONCES $c8=00:00;SINO $c8=0.00;FSI;
SI ($tip09=="H") ENTONCES $c9=00:00;SINO $c9=0.00;FSI;
SI ($tip10=="H") ENTONCES $c10=00:00;SINO $c10=0.00;FSI;
SI ($tip11=="H") ENTONCES $c11=00:00;SINO $c11=0.00;FSI;
SI ($tip12=="H") ENTONCES $c12=00:00;SINO $c12=0.00;FSI;
revisaCalculo("listados.contadores.calculo_absentismo",$p1,$p2,"");
ponCampoRegistro("codigo",campoPersona("codigo"));
ponCampoRegistro("apellidos",campoPersona("apellidos"));
ponCampoRegistro("nombre",campoPersona("nombre"));
ponCampoRegistro("c1",$c1);
ponCampoRegistro("c2",$c2);
ponCampoRegistro("c3",$c3);
ponCampoRegistro("c4",$c4);
ponCampoRegistro("c5",$c5);
ponCampoRegistro("c6",$c6);
ponCampoRegistro("c7",$c7);
ponCampoRegistro("c8",$c8);
ponCampoRegistro("c9",$c9);
ponCampoRegistro("c10",$c10);
ponCampoRegistro("c11",$c11);
ponCampoRegistro("c12",$c12);
escribeRegistro();
/####/Interfaz:calculo_absentismo/####/$c1=$c1+valorContador($con01);
$c2=$c2+valorContador($con02);
$c3=$c3+valorContador($con03);
$c4=$c4+valorContador($con04);
$c5=$c5+valorContador($con05);
$c6=$c6+valorContador($con06);
$c7=$c7+valorContador($con07);
$c8=$c8+valorContador($con08);
$c9=$c9+valorContador($con09);
$c10=$c10+valorContador($con10);
$c11=$c11+valorContador($con11);
$c12=$c12+valorContador($con12);
/####/Tarea:listado_contadores/####/lanzaInterfaz("listado","","");/####/Lanzador:contadores_libs/####/alAceptar("listado_contadores");
ponParametro("$p1","Fecha de inicio:",1,"");
ponParametro("$p2","Fecha de Fin:",1,"");
persistencia("$p1,$p2");/####/Paquete:listados.resumendiario/####/Interfaz:listado/####///lanzamos la inicialización de contadores
lanzaInterfaz("listados.resumendiario.inicializa_contadores","","");
//creamos una tabla temporal para el preproceso
$cols="nombre VARCHAR2(20),apellidos VARCHAR2(80), codigo NUMBER(10), dni VARCHAR2(20),departamento VARCHAR2(200), dia NUMBER(10), jornada VARCHAR2(60),movimientos VARCHAR2(100), saldo NUMBER(10)";
creaDestino("*",3,$cols);
$d=destinoActual();
$fhora=formatoHora(0,0,2,0,0,":");
//hacemos un preproceso con los valores del calculo
creaFuente("tmp",7,$p1,$p2);
$seleccion="seleccion_personas";

SI ($pers_filtro=="0") ENTONCES 
 lanzaInterfaz("listados.resumendiario.proc_previo_diario",$seleccion,"");
SINO
 lanzaInterfaz("listados.resumendiario.proc_previo_diario",$seleccion,"actual");
FSI;

//ahora creamos el pdf y definimos fdormatos y variables
creaDestino("salida_diario",4,"*.pdf");
$c1=defineColor(200,200,200);
$a=1;
$a1=aspectoTexto("Courier",9,0,0,0);
$a1h=aspectoTexto("Hevetica",10,0,0,0);
$a2=aspectoTexto("Helvetica",10,2,0,0);
$a3=aspectoTexto("Helvetica",10,0,2,0);
$a4=aspectoTexto("Helvetica",10,2,2,0);
$at=aspectoTexto("Helvetica",14,2,0,0);
$fd=formatoFecha("DDMMAAAA","/");
$fdh=formatoFecha("DDMMAAAAhhmm","/| |:");
usarAspecto($a1h);
ponNumeroPagina(str("mPagina",0)+" ",0);
usarAspecto($at);
print(str("mDetDiario",0));
usarAspecto($a1h);
print("          "+str("mPeriodoSol:",0)+" "+formatea($p1,$fd)+" - "+formatea($p2,$fd)+" / "+str("mFechaImpresion",0)+"  "+formatea(ahora,$fdh)+CR+LF);
//leemos de la tabla temporal e imprimimos
creaFuente("TEMPORAL",1,$d,"ORDER BY dia");
agrupa("TEMPORAL","codigo");
$ac="10,20,20,10";
creaEstructuraTotales("TEMPORAL",1);
lanzaInterfaz("listados.resumendiario.export_diario","TEMPORAL","");
cierraDestino("salida_diario");
abreEnNavegador("salida_diario");/####/Interfaz:totales_diario/####/$h=a_hora(obtenTotal("TEMPORAL",1,1));
printf($h,$fhora);/####/Interfaz:inicializa_contadores/####/// Saldo diario;
$sql="SELECT C.NOM_C FROM CONTADORES_LISTADOS_PORTAL CLP LEFT JOIN CONTADORES C ON C.CONTADOR=CLP.CONTADOR AND 
C.CONVENIO=" + propiedadUsuario("convenio") + " WHERE CLP.TABLA="+propiedadUsuario("tabla_saldos")+" AND CLP.NUM=21";
$con1=ejecutaSql($sql);
/####/Interfaz:calculo_diario/####/$ok=1;
SI (esPorPlantilla("seleccion_personas")) 
ENTONCES
  $ok=personaEnPlantilla("seleccion_personas");
FSI;
SI ($ok) 
ENTONCES
  ponCampoRegistro("dia",campoCalculo("dia"));
  ponCampoRegistro("jornada",campoCalculo("jornada_efectiva"));
  ponCampoRegistro("nombre",$nombre_pers);
  ponCampoRegistro("apellidos",$apellidos_pers);
  ponCampoRegistro("codigo",$codigo_pers);
  ponCampoRegistro("departamento",$dept);
  ponCampoRegistro("dni",$dni);
  $movs="";
  COMPRUEBA (a_entero(campoCalculo("estado_dia")))
    CASO (0) 
    ENTONCES 
      ponCampoRegistro("saldo",valorContador($con1));
      SI (campoCalculo("anomalias")<>"")
      ENTONCES
        $movs="<"+campoCalculo("anomalias")+">";
      FSI;
      ponCampoRegistro("movimientos",$movs);
    FIN
    CASO (1) 
    ENTONCES 
      ponCampoRegistro("saldo",valorContador($con1));
      $nmovs = 0;
      revisaMovimientos("listados.resumendiario.movimientos_diarios");
      SI (campoCalculo("anomalias")<>"")
      ENTONCES
        $movs=$movs+CR+LF+"<"+campoCalculo("anomalias")+">";
      FSI;
      ponCampoRegistro("movimientos",$movs);
    FIN
    CASO (2) 
    ENTONCES 
      ponCampoRegistro("saldo",valorContador($con1));
      $movs=campoObjetoCalculo("incidencia","nombre");
      ponCampoRegistro("movimientos",$movs);
    FIN
  FIN;
  escribeRegistro();
FSI;/####/Interfaz:export_diario/####/SI (inicioAgrupacion(1)) 
ENTONCES
  usarAspecto($a2);
  print(CR+LF+campo("apellidos")+", "+campo("nombre"));
  tablaPDF($ac);
  print(str("mDia",0));print(str("mJornada",0));print(str("mMarcajes",0));
  usarAspecto($a4);
  print("Saldo");  
FSI;
usarAspecto($a1);
printf(campo("dia"),$fd);
print(campo("jornada"));
print(campo("movimientos"));
usarAspecto($a3);  
lanzaInterfaz("listados.resumendiario.columnas_diario","","");
SI (finalAgrupacion(1)) 
ENTONCES
  usarAspecto($a2);
  print("Total");
  print("");print("");
  usarAspecto($a4);
  lanzaInterfaz("listados.resumendiario.totales_diario","","");
  cierraTablaPDF();
FSI;/####/Interfaz:movimientos_diarios/####/SI (mov_dato("I")=="0")
ENTONCES
  $incid=" ";
SINO
  $incid=mov_dato("I");
FSI;
SI ((mov_flags(0)==0)+(mov_flags(0)==4))
ENTONCES
 SI ((a_texto(mov_instante(1))<>a_texto(mov_instante(0)))+(mov_dato("IO")<>mov_dato("I")))
  ENTONCES
    COMPRUEBA (mov_sentido(0))
      CASO ("E") ENTONCES $sentido="e "; FIN
      CASO ("S") ENTONCES $sentido="s "; FIN
      CASO ("B") ENTONCES $sentido="b "; FIN
    FIN;
  SINO
    $sentido=mov_sentido(0)+" ";
  FSI;
SINO
  COMPRUEBA (mov_sentido(0))
    CASO ("E") ENTONCES $sentido="e "; FIN
    CASO ("S") ENTONCES $sentido="s "; FIN
    CASO ("B") ENTONCES $sentido="b "; FIN
  FIN;
FSI;
SI (mov_minuto(0)>1439)
ENTONCES
  $movs=$movs+$sentido+"+"+formatea(mov_minuto(0)-1440,$fhora)+" "+$incid+" ";
SINO
  $movs=$movs+$sentido+" "+formatea(mov_minuto(0),$fhora)+" "+$incid+" ";
FSI;
$nmovs = $nmovs + 1;
SI ($nmovs>=4) ENTONCES
 $nmovs = 0;
 $movs=$movs+CR+LF;
FSI;
/####/Interfaz:proc_previo_diario/####/$nombre_pers=campoPersona("nombre");
$apellidos_pers=campoPersona("apellidos");
$codigo_pers=campoPersona("codigo");
$dni=campoPersona("dni");
buscaDepartamentoPersona();
$dept=rutaDepartamento(1,3);
revisaCalculo("listados.resumendiario.calculo_diario",$p1,$p2,"");
/####/Interfaz:columnas_diario/####/$cont=campo("saldo");
SI (($cont=="")+($cont=="0")) 
ENTONCES 
  print("-");
SINO 
  $h=a_hora(a_entero($cont) div 100);
  sumaTotal("TEMPORAL",1, $h);
  printf($h,$fhora);
FSI;/####/Lanzador:resDiario/####/alAceptar("trabajo_diario");
ponParametro("$p1","Fecha de inicio:",1,"");
ponParametro("$p2","Fecha de Fin:",1,"");
saltarFilaParametros();
ponParametro("$p3","Contadores",7,"");
saltarFilaParametros();
ponParametro("$p4","Ruta del fichero",3,"");
ponValorParametro("$p1",a_texto(extrae_fecha(fecha)-7));
ponValorParametro("$p2",fecha);
persistencia("$p3,$p4");/####/Tarea:trabajo_diario/####/lanzaInterfaz("listado","","");/####/Paquete:listados.retrasos/####/Interfaz:listado/####///lanzamos la inicialización de contadores
lanzaInterfaz("listados.retrasos.inicializa_contadores","","");
$cols="nombre VARCHAR2(20),apellidos VARCHAR2(80), codigo NUMBER(10), dni VARCHAR2(20),departamento VARCHAR2(200), dia NUMBER(10), jornada VARCHAR2(60),movimientos VARCHAR2(100), saldo NUMBER(10)";
creaDestino("*",3,$cols);
$d=destinoActual();
$fhora=formatoHora(0,0,2,0,0,":");
//hacemos un preproceso con los valores del calculo
creaFuente("tmp",7,$p1,$p2);
$seleccion="seleccion_personas";

SI ($pers_filtro=="0") ENTONCES 
 lanzaInterfaz("listados.retrasos.proc_previo_diario",$seleccion,"");
SINO
 lanzaInterfaz("listados.retrasos.proc_previo_diario",$seleccion,"actual");
FSI;

//lanzaInterfaz("listados.retrasos.proc_previo_diario",$seleccion,"");
//ahora creamos el pdf y definimos fdormatos y variables
creaDestino("salida_diario",4,"*.pdf");
ponNumeroPagina("pág.",0);
$c1=defineColor(200,200,200);
$a=1;
$a1=aspectoTexto("Courier",9,0,0,0);
$a1h=aspectoTexto("Hevetica",10,0,0,0);
$a2=aspectoTexto("Helvetica",10,2,0,0);
$a3=aspectoTexto("Helvetica",10,0,2,0);
$a4=aspectoTexto("Helvetica",10,2,2,0);
$at=aspectoTexto("Helvetica",14,2,0,0);
$fd=formatoFecha("DDMMAAAA","/");
$fdh=formatoFecha("DDMMAAAAhhmm","/| |:");
usarAspecto($a1h);
ponNumeroPagina(str("mPagina",0)+" ",0);
usarAspecto($at);
print(str("mRetrasos",0));
usarAspecto($a1h);
print("          "+str("mPeriodoSol:",0)+" "+formatea($p1,$fd)+" - "+formatea($p2,$fd)+" / "+str("mFechaImpresion",0)+"  "+formatea(ahora,$fdh)+CR+LF);
//leemos de la tabla temporal e imprimimos
creaFuente("TEMPORAL",1,$d,"ORDER BY dia");
agrupa("TEMPORAL","codigo");
$ac="10,20,20,10";
creaEstructuraTotales("TEMPORAL",1);
lanzaInterfaz("listados.retrasos.export_diario","TEMPORAL","");
cierraDestino("salida_diario");
abreEnNavegador("salida_diario");/####/Interfaz:totales_diario/####/$h=a_hora(obtenTotal("TEMPORAL",1,1));
printf($h,$fhora);/####/Interfaz:inicializa_contadores/####/// Retraso diario;
$sql="SELECT C.NOM_C FROM CONTADORES_LISTADOS_PORTAL CLP LEFT JOIN CONTADORES C ON C.CONTADOR=CLP.CONTADOR AND 
C.CONVENIO=" + propiedadUsuario("convenio") + " WHERE CLP.TABLA="+propiedadUsuario("tabla_saldos")+" AND CLP.NUM=20";
$con1=ejecutaSql($sql);
/####/Interfaz:calculo_diario/####/$ok=1;
SI (esPorPlantilla("seleccion_personas")) 
ENTONCES
  $ok=personaEnPlantilla("seleccion_personas");
FSI;
SI ($ok) 
ENTONCES
  ponCampoRegistro("dia",campoCalculo("dia"));
  ponCampoRegistro("jornada",campoCalculo("jornada_efectiva"));
  ponCampoRegistro("nombre",$nombre_pers);
  ponCampoRegistro("apellidos",$apellidos_pers);
  ponCampoRegistro("codigo",$codigo_pers);
  ponCampoRegistro("departamento",$dept);
  ponCampoRegistro("dni",$dni);
  $movs="";
  COMPRUEBA (a_entero(campoCalculo("estado_dia")))
    CASO (0) 
    ENTONCES 
      ponCampoRegistro("saldo",valorContador($con1));
      $movs="<"+campoCalculo("anomalias")+">";
      ponCampoRegistro("movimientos",$movs);
    FIN
    CASO (1) 
    ENTONCES 
      ponCampoRegistro("saldo",valorContador($con1));
      $nmovs = 0;
      revisaMovimientos("listados.retrasos.movimientos_diarios");
      SI (campoCalculo("anomalias")<>"")
      ENTONCES
        $movs=$movs+CR+LF+"<"+campoCalculo("anomalias")+">";
      FSI;
      ponCampoRegistro("movimientos",$movs);
    FIN
    CASO (2) 
    ENTONCES 
      ponCampoRegistro("saldo",valorContador($con1));
      $movs=campoObjetoCalculo("incidencia","nombre");
      ponCampoRegistro("movimientos",$movs);
    FIN
  FIN;
  SI (valorContador($con1)<>00:00)
  ENTONCES
    escribeRegistro();
  FSI;
FSI;/####/Interfaz:proc_previo_diario/####/$nombre_pers=campoPersona("nombre");
$apellidos_pers=campoPersona("apellidos");
$codigo_pers=campoPersona("codigo");
$dni=campoPersona("dni");
buscaDepartamentoPersona();
$dept=rutaDepartamento(1,3);
revisaCalculo("listados.retrasos.calculo_diario",$p1,$p2,"");
/####/Interfaz:movimientos_diarios/####/SI (mov_dato("I")=="0")
ENTONCES
  $incid=" ";
SINO
  $incid=mov_dato("I");
FSI;
SI ((mov_flags(0)==0)+(mov_flags(0)==4))
ENTONCES
 SI ((a_texto(mov_instante(1))<>a_texto(mov_instante(0)))+(mov_dato("IO")<>mov_dato("I")))
  ENTONCES
    COMPRUEBA (mov_sentido(0))
      CASO ("E") ENTONCES $sentido="e "; FIN
      CASO ("S") ENTONCES $sentido="s "; FIN
      CASO ("B") ENTONCES $sentido="b "; FIN
    FIN;
  SINO
    $sentido=mov_sentido(0)+" ";
  FSI;
SINO
  COMPRUEBA (mov_sentido(0))
    CASO ("E") ENTONCES $sentido="e "; FIN
    CASO ("S") ENTONCES $sentido="s "; FIN
    CASO ("B") ENTONCES $sentido="b "; FIN
  FIN;
FSI;
SI (mov_minuto(0)>1439)
ENTONCES
  $movs=$movs+$sentido+"+"+formatea(mov_minuto(0)-1440,$fhora)+" "+$incid+" ";
SINO
  $movs=$movs+$sentido+" "+formatea(mov_minuto(0),$fhora)+" "+$incid+" ";
FSI;
$nmovs = $nmovs + 1;
SI ($nmovs>=4) ENTONCES
 $nmovs = 0;
 $movs=$movs+CR+LF;
FSI;
/####/Interfaz:export_diario/####/SI (inicioAgrupacion(1)) 
ENTONCES
  usarAspecto($a2);
  print(CR+LF+campo("apellidos")+", "+campo("nombre"));
  tablaPDF($ac);
  print(str("mDia",0));print(str("mJornada",0));print(str("mMarcajes",0));
  usarAspecto($a4);
  print("Retrasos");  
FSI;
usarAspecto($a1);
printf(campo("dia"),$fd);
print(campo("jornada"));
print(campo("movimientos"));
usarAspecto($a3);  
lanzaInterfaz("listados.retrasos.columnas_diario","","");
SI (finalAgrupacion(1))
ENTONCES
  usarAspecto($a2);
  print("Total");
  print("");print("");
  usarAspecto($a4);
  lanzaInterfaz("listados.retrasos.totales_diario","","");
  cierraTablaPDF();
FSI;/####/Interfaz:columnas_diario/####/$cont=campo("saldo");
SI (($cont=="")+($cont=="0")) 
ENTONCES 
  print("-");
  SINO 
  $h=a_hora(a_entero($cont) div 100);
  sumaTotal("TEMPORAL",1, $h);
  printf($h,$fhora);
FSI;/####/Lanzador:restrasos/####/alAceptar("trabajo_diario");
ponParametro("$p1","Fecha de inicio:",1,"");
ponParametro("$p2","Fecha de Fin:",1,"");
saltarFilaParametros();
ponParametro("$p3","Contadores",7,"");
saltarFilaParametros();
ponParametro("$p4","Ruta del fichero",3,"");
ponValorParametro("$p1",a_texto(extrae_fecha(fecha)-7));
ponValorParametro("$p2",fecha);
persistencia("$p3,$p4");/####/Tarea:trabajo_diario/####/lanzaInterfaz("listado","","");/####/Paquete:listados.incidencias/####/Interfaz:ampl_cabeceras_hoja_dept/####/$ac=$ac+",2";/####/Interfaz:hoja_dept_persona/####/aspectoCelda($a1,0,1,0);
print(campoPersona("nombre_completo"));
creaFuente("tmp2",7,$p1,$p2);
lanzaInterfaz("listados.incidencias.calculo","tmp2","");
/####/Interfaz:calculo_persona/####/$inc=campoCalculo("incidencia_dia");
SI ($inc<>"0") 
ENTONCES
  $scol=campoObjetoCalculo("incidencia","color");
  $col=a_entero($scol);
//con una variable sabemos si ya hemos insertado el mapa para la leyenda o no
  SI ($insertado==0) 
  ENTONCES
    $insertado=1;
  FSI;
  ponValor("leyenda",campoObjetoCalculo("incidencia","nombre"),a_texto($col));
  aspectoCelda($a1,0,1,$col);
SINO 
//los festivos los ponemos en gris
  SI (estadoDia()==3) ENTONCES
    aspectoCelda($a1,0,1,$cg); 
  SINO  
    aspectoCelda($a1,0,1,0); 
  FSI;
FSI;
print("");
$impreso=1;
/####/Interfaz:listado/####/creaDestino("salida_departamentos",4,"*.pdf");
$ac="20";
$cg=defineColor(230,230,230);
$a1=aspectoTexto("Helvetica",10,0,0,0);
$a2=aspectoTexto("Helvetica",14,2,0,0);
$fd=formatoFecha("DDMMAAAA","/");
$fdh=formatoFecha("DDMMAAAAhhmm","/| |:");
$fhora=formatoHora(0,0,2,0,0,":");
usarAspecto($a1);
ponNumeroPagina(str("mPagina",0)+" ",0);
usarAspecto($a2);
print(str("mListadoPlanificaciones",0));print(" ");
usarAspecto($a1);
ponNumeroPagina(str("mPagina",0)+" ",0);
print(CR+LF+str("mPeriodoSol:",0));print(" ");print($p1);print(" - ");print($p2);
usarAspecto($a1);
print(CR+LF+str("mFechaImpresion",0));print(": ");print(formatea(ahora,$fdh)+CR+LF+CR+LF);
creaFuente("leyenda",13,"","");
creaFuente("tmp",7,$p1,$p2);
lanzaInterfaz("listados.incidencias.ampl_cabeceras_hoja_dept","tmp","");
tablaPDF($ac);
print(str("mEmple",0));
$insertado=0;
lanzaInterfaz("listados.incidencias.cabeceras_hoja_dept","tmp","");
$seleccion="seleccion_personas";
SI(esPorPlantilla("seleccion_personas")) 
ENTONCES
  creaFuente("plantilla",2,"TODO EL PERSONAL","");
  $seleccion="plantilla";
FSI;
lanzaInterfaz("listados.incidencias.hoja_dept_persona",$seleccion,"");
cierraTablaPDF();
print(CR+LF);
tablaPDF("5,70;30");
lanzaInterfaz("listados.incidencias.imprime_leyenda","leyenda","");
cierraTablaPDF();
cierraDestino("salida_departamentos");
abreEnNavegador("salida_departamentos");/####/Interfaz:cabeceras_hoja_dept/####/print(day(fecha));/####/Interfaz:calculo/####/$impreso=0;
revisaCalculo("listados.incidencias.calculo_persona",a_fecha(fecha),a_fecha(fecha),"");
SI ($impreso==0) 
ENTONCES
  aspectoCelda($a1,0,1,$sincontrato); 
  print("");
FSI;
/####/Interfaz:imprime_leyenda/####/$n=campo();
$v=prop($n);
aspectoCelda($a1,0,1,$v);
print("");
aspectoCelda($a1,0,1,0);
print($n);/####/Lanzador:incidencias_mes/####/alAceptar("listado_incidencias");
 ponParametro("$p1","Fecha de inicio:",1,"");
 ponParametro("$p2","Fecha de Fin:",1,"");
 saltarFilaParametros();
 ponValorParametro("$p1",fecha);
 ponValorParametro("$p2",a_texto(extrae_fecha(fecha)+31));/####/Tarea:listado_incidencias/####/lanzaInterfaz("listado","","");
